<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aku Bisa Simpan</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- SheetJS (js-xlsx) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="sha512-r22gChDnGvCbJn9FGk+bAUzA2nVctVpVbAU4BF0VRZMyBdFmNjUzzZJqzEkV1vrPOQtrwBqL9WCHljLzYJtM0A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Firebase SDKs (v8 - Namespaced) -->
    <!-- Firebase App (Required) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Firebase Storage (Optional, but needed for profile pics) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <!-- Firebase Analytics (Optional) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
    <!-- END Firebase SDKs -->


    <style>
        /* --- START OF CSS --- */

        /* --- Variabel Warna & Dasar --- */
        :root {
            --primary-color: #0d6efd; /* Updated Bootstrap 5 Blue */
            --primary-dark: #0b5ed7;
            --primary-light: #cfe2ff;
            --secondary-color: #6c757d;
            --secondary-dark: #5c636a;
            --light-color: #f8f9fa;
            --dark-color: #212529; /* Updated Bootstrap 5 Dark */
            --success-color: #198754; /* Updated Bootstrap 5 Green */
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #0dcaf0; /* Updated Bootstrap 5 Teal */
            --text-color: #495057;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --body-bg: #f0f2f5; /* Slightly grayer background */
            --card-bg: #ffffff;

            --sidebar-bg: #212529; /* Darker Sidebar */
            --sidebar-link-color: #adb5bd;
            --sidebar-link-hover-bg: rgba(255, 255, 255, 0.05);
            --sidebar-link-hover-color: #ffffff;
            --sidebar-link-active-bg: var(--primary-color);
            --sidebar-link-active-color: #ffffff;
            --sidebar-header-border: rgba(255, 255, 255, 0.1);

            --font-family-base: 'Poppins', sans-serif;
            --box-shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            --box-shadow-lg: 0 1rem 3rem rgba(0, 0, 0, 0.175);
            --border-radius: 0.375rem;
            --border-radius-lg: 0.5rem;

            --spacer: 1rem; /* Base spacer unit */
        }

        /* --- Reset & Global Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; font-size: 16px; } /* Base font size */
        body {
            font-family: var(--font-family-base);
            background-color: var(--body-bg);
            color: var(--text-color);
            line-height: 1.6;
            font-size: 1rem;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        body.login-view { display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, var(--primary-light), var(--light-color)); }
        a { color: var(--primary-color); text-decoration: none; transition: color 0.2s ease, opacity 0.2s ease; }
        a:hover { color: var(--primary-dark); text-decoration: none; opacity: 0.85; }
        img { max-width: 100%; height: auto; vertical-align: middle; }
        hr { border: 0; height: 1px; background-color: var(--border-color); margin: calc(var(--spacer) * 1.5) 0; }

        /* --- Utility Classes --- */
        .text-muted { color: var(--text-muted) !important; }
        .text-center { text-align: center; }
        .text-end { text-align: end; }
        .mt-1 { margin-top: calc(var(--spacer) * 0.25) !important; }
        .mt-2 { margin-top: calc(var(--spacer) * 0.5) !important; }
        .mt-3 { margin-top: var(--spacer) !important; }
        .mt-4 { margin-top: calc(var(--spacer) * 1.5) !important; }
        .mb-1 { margin-bottom: calc(var(--spacer) * 0.25) !important; }
        .mb-2 { margin-bottom: calc(var(--spacer) * 0.5) !important; }
        .mb-3 { margin-bottom: var(--spacer) !important; }
        .mb-4 { margin-bottom: calc(var(--spacer) * 1.5) !important; }
        .p-1 { padding: calc(var(--spacer) * 0.25) !important; }
        .p-2 { padding: calc(var(--spacer) * 0.5) !important; }
        .p-3 { padding: var(--spacer) !important; }
        .p-4 { padding: calc(var(--spacer) * 1.5) !important; }
        .d-block { display: block !important; }
        .d-flex { display: flex !important; }
        .align-items-center { align-items: center !important; }
        .justify-content-between { justify-content: space-between !important; }
        .justify-content-center { justify-content: center !important; }
        .justify-content-end { justify-content: flex-end !important; }
        .flex-grow-1 { flex-grow: 1 !important; }
        .hidden { display: none !important; }
        .w-100 { width: 100% !important; }

        .row { display: flex; flex-wrap: wrap; margin-left: -10px; margin-right: -10px; }
        .col, .col-md-3, .col-md-4, .col-md-6, .col-md-8, .col-md-12 { padding-left: 10px; padding-right: 10px; width: 100%; margin-bottom: var(--spacer); }
        @media (min-width: 768px) {
            .col-md-3 { flex: 0 0 auto; width: 25%; }
            .col-md-4 { flex: 0 0 auto; width: 33.3333%; }
            .col-md-6 { flex: 0 0 auto; width: 50%; }
            .col-md-8 { flex: 0 0 auto; width: 66.6667%; }
            .col-md-12 { flex: 0 0 auto; width: 100%; }
            .col, .col-md-3, .col-md-4, .col-md-6, .col-md-8, .col-md-12 { margin-bottom: 0; }
        }
        @media (min-width: 992px) { /* Example LG breakpoint */
             .col-lg-2 { flex: 0 0 auto; width: 16.6667%; padding-left: 10px; padding-right: 10px; }
             .col-lg-3 { flex: 0 0 auto; width: 25%; padding-left: 10px; padding-right: 10px; } /* Added col-lg-3 */
             .col-lg-4 { flex: 0 0 auto; width: 33.3333%; padding-left: 10px; padding-right: 10px; } /* Added col-lg-4 */
             .col-lg-6 { flex: 0 0 auto; width: 50%; padding-left: 10px; padding-right: 10px; } /* Added col-lg-6 */
             .col-lg-10 { flex: 0 0 auto; width: 83.3333%; padding-left: 10px; padding-right: 10px; }
             .offset-lg-1 { margin-left: 8.333333%; } /* Added offset */
        }

        /* --- Tombol (Button) Styles --- */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.4rem; font-weight: 500; color: #fff; text-align: center; vertical-align: middle; cursor: pointer; user-select: none; background-color: transparent; border: 1px solid transparent; padding: 0.5rem 1rem; font-size: 0.95rem; line-height: 1.5; border-radius: var(--border-radius); transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out, transform .1s ease; }
        .btn:hover { text-decoration: none; transform: translateY(-1px); box-shadow: var(--box-shadow-sm); }
        .btn:focus, .btn:active { outline: 0; box-shadow: var(--box-shadow-sm); }
        .btn:active { transform: translateY(0); box-shadow: none; }
        .btn i.fas, .btn i.fa-solid { line-height: 1; } /* Ensure icon vertical alignment */
        .btn:disabled, .btn.disabled { cursor: not-allowed; opacity: 0.65; box-shadow: none; transform: none; }
        .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
        .btn-primary:hover { background-color: var(--primary-dark); border-color: var(--primary-dark); }
        .btn-secondary { background-color: var(--secondary-color); border-color: var(--secondary-color); color: #fff; }
        .btn-secondary:hover { background-color: var(--secondary-dark); border-color: var(--secondary-dark); }
        .btn-success { background-color: var(--success-color); border-color: var(--success-color); }
        .btn-success:hover { background-color: #157347; border-color: #146c43; }
        .btn-danger { background-color: var(--danger-color); border-color: var(--danger-color); }
        .btn-danger:hover { background-color: #bb2d3b; border-color: #b02a37; }
        .btn-warning { background-color: var(--warning-color); border-color: var(--warning-color); color: var(--dark-color); }
        .btn-warning:hover { background-color: #ffca2c; border-color: #ffc720; }
        .btn-info { background-color: var(--info-color); border-color: var(--info-color); color: var(--dark-color); }
        .btn-info:hover { background-color: #31d2f2; border-color: #25cff2; }
        .btn-block { display: flex; width: 100%; }
        .btn-sm { padding: .3rem .6rem; font-size: .875rem; border-radius: .25rem; gap: 0.3rem;}
        .btn-lg { padding: .75rem 1.5rem; font-size: 1.1rem; border-radius: var(--border-radius-lg); }
        .btn-outline-secondary { color: var(--secondary-color); border-color: var(--secondary-color); }
        .btn-outline-secondary:hover { color: #fff; background-color: var(--secondary-color); border-color: var(--secondary-color); }
        .btn-action { margin: 0 .15rem; padding: 0.25rem 0.5rem; font-size: 0.8rem; } /* Spacing and sizing for action buttons in table */
        .btn-link { font-weight: 400; color: var(--primary-color); text-decoration: underline; background: none; border: none; padding: 0; }
        .btn-link:hover { color: var(--primary-dark); text-decoration: underline; }

        /* Button Spinner */
        .btn .spinner-border-sm { width: 1rem; height: 1rem; border-width: .2em; }

        /* --- Form Styles --- */
        .form-group { margin-bottom: calc(var(--spacer) * 1.25); }
        .form-label, .form-group label { display: inline-block; margin-bottom: .5rem; font-weight: 500; color: var(--text-color); font-size: 0.9rem; }
        .form-group label i, .form-label i { margin-right: .4rem; color: var(--secondary-color); width: 1em; text-align: center; font-size: 0.9em; }
        .form-control, .form-select, .form-group select, .form-group textarea { display: block; width: 100%; padding: .65rem .9rem; font-size: .95rem; font-weight: 400; line-height: 1.5; color: var(--text-color); background-color: var(--card-bg); background-clip: padding-box; border: 1px solid #ced4da; appearance: none; border-radius: var(--border-radius); transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out; }
        .form-control:focus, .form-select:focus, .form-group select:focus, .form-group textarea:focus { color: var(--text-color); background-color: var(--card-bg); border-color: #86b7fe; outline: 0; box-shadow: 0 0 0 .25rem rgba(13,110,253,.25); }
        .form-control[disabled], .form-control[readonly], .form-select[disabled] { background-color: #e9ecef; opacity: 1; cursor: not-allowed; }
        textarea.form-control { min-height: 100px; resize: vertical; }
        .form-select, .form-group select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right .9rem center; background-size: 16px 12px; padding-right: 2.5rem; }
        .form-check { display: block; position: relative; padding-left: 1.75rem; margin-bottom: .75rem; }
        .form-check-input { position: absolute; margin-top: .25em; margin-left: -1.75rem; }
        .form-check-label { margin-bottom: 0; font-weight: 400; cursor: pointer; }
        .form-check-input[type=radio] { border-radius: 50%; }
        .form-check-input:checked { background-color: var(--primary-color); border-color: var(--primary-color); }
        .form-check-input:checked[type=radio] { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='2' fill='%23fff'/%3e%3c/svg%3e"); }
        .form-text { margin-top: .25rem; font-size: .875em; color: var(--text-muted); }
        .is-invalid { border-color: var(--danger-color) !important; /* Use important to override focus */ padding-right: calc(1.5em + .75rem); background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right calc(.375em + .1875rem) center; background-size: calc(.75em + .375rem) calc(.75em + .375rem); }
        .is-invalid:focus { border-color: var(--danger-color) !important; box-shadow: 0 0 0 .25rem rgba(220, 53, 69, .25) !important; }
        .invalid-feedback { display: none; width: 100%; margin-top: .25rem; font-size: .875em; color: var(--danger-color); }
        .was-validated .form-control:invalid, .was-validated .form-select:invalid { border-color: var(--danger-color); /* Style for native validation */ }
        .was-validated .form-control:invalid ~ .invalid-feedback, .was-validated .form-select:invalid ~ .invalid-feedback,
        .form-control.is-invalid ~ .invalid-feedback, .form-select.is-invalid ~ .invalid-feedback { display: block; } /* Ensure feedback shows */


        /* --- Alert Styles --- */
        .alert { position: relative; padding: var(--spacer) var(--spacer); margin-bottom: var(--spacer); border: 1px solid transparent; border-radius: var(--border-radius); display: flex; align-items: center; gap: 0.75rem;}
        .alert i.fas { font-size: 1.2rem; line-height: 1;}
        .alert-heading { color: inherit; margin-top: 0; margin-bottom: .5rem; font-weight: 500; font-size: 1.1rem;}
        .alert-success { color: #0a3622; background-color: #d1e7dd; border-color: #a3cfbb; } .alert-success i { color: #157347;}
        .alert-danger { color: #58151c; background-color: #f8d7da; border-color: #f1aeb5; } .alert-danger i { color: #bb2d3b; }
        .alert-warning { color: #664d03; background-color: #fff3cd; border-color: #ffe69c; } .alert-warning i { color: #ffca2c; }
        .alert-info { color: #055160; background-color: #cff4fc; border-color: #9eeaf9; } .alert-info i { color: #31d2f2; }
        .alert-dismissible { padding-right: 3rem; }
        .alert-dismissible .btn-close { position: absolute; top: 0; right: 0; z-index: 2; padding: 1.25rem 1rem; background: none; border: none; font-size: 1.2rem; opacity: 0.7; cursor: pointer;}
        .alert-dismissible .btn-close:hover { opacity: 1; } /* Bootstrap 5 style */
        .fade { transition: opacity .15s linear; }
        .show { opacity: 1; }

        /* --- Halaman Login --- */
        .login-wrapper { width: 100%; max-width: 450px; padding: var(--spacer); }
        .login-container { padding: calc(var(--spacer) * 2); background-color: var(--card-bg); border-radius: var(--border-radius-lg); box-shadow: var(--box-shadow-lg); text-align: center; }
        .logo-placeholder { font-size: 1.75rem; font-weight: 700; color: var(--primary-color); margin-bottom: calc(var(--spacer) * 1.5); display: flex; align-items: center; justify-content: center; gap: 0.75rem; }
        /* .logo-placeholder i { font-size: 2.5rem; } */ /* Removed icon style */
        .login-container h2 { margin-bottom: .5rem; color: var(--dark-color); font-size: 1.75rem; font-weight: 600; }
        .login-container p { margin-bottom: calc(var(--spacer) * 2); color: var(--text-muted); font-size: 1rem; }
        .error-message { text-align: left; color: #58151c; margin-top: var(--spacer); font-size: 0.9em; font-weight: 500; min-height: 1.2em; display: none; background-color: #f8d7da; border: 1px solid #f1aeb5; padding: .75rem 1rem; border-radius: var(--border-radius); }
        .error-message.show { display: block; }
        .login-container .form-group { text-align: left; } /* Align labels left */

        /* --- Halaman Dashboard --- */
        .dashboard-container { display: flex; min-height: 100vh; width: 100%; }

        /* --- Sidebar --- */
        .sidebar { width: 260px; background-color: var(--sidebar-bg); color: var(--sidebar-link-color); padding: 0; display: flex; flex-direction: column; flex-shrink: 0; box-shadow: var(--box-shadow-sm); position: fixed; left: 0; top: 0; bottom: 0; overflow-y: auto; z-index: 1030; /* Higher z-index */ transition: width 0.3s ease; }
        .sidebar-header { padding: 1.1rem 1.5rem; border-bottom: 1px solid var(--sidebar-header-border); display: flex; align-items: center; flex-shrink: 0; }
        .sidebar-header .logo-placeholder { font-size: 1.25rem; color: #fff; margin: 0; gap: 0.6rem; font-weight: 600; display: flex; align-items: center;} /* Ensure flex alignment */
        /* .sidebar-header .logo-placeholder i { font-size: 1.8rem; } */ /* Removed icon style */
        .sidebar nav { flex-grow: 1; padding: 1rem 0; }
        .sidebar nav ul { list-style: none; padding: 0; margin: 0; }
        .sidebar nav ul li a { display: flex; align-items: center; gap: 0.8rem; padding: .75rem 1.5rem; color: var(--sidebar-link-color); text-decoration: none; transition: background-color 0.2s ease, color 0.2s ease, border-left-color 0.2s ease; font-size: 0.95rem; font-weight: 400; border-left: 4px solid transparent; margin: .1rem 0; }
        .sidebar nav ul li a i.fas { font-size: 1rem; width: 1.3em; text-align: center; }
        .sidebar nav ul li a:hover { background-color: var(--sidebar-link-hover-bg); color: var(--sidebar-link-hover-color); border-left-color: var(--secondary-color); text-decoration: none; }
        .sidebar nav ul li a.active { background-color: var(--sidebar-link-active-bg); color: var(--sidebar-link-active-color); border-left-color: var(--light-color); font-weight: 500; }
        .sidebar nav ul li a.active i { color: inherit; }
        .sidebar nav ul li.nav-section-title { padding: 0.5rem 1.5rem; margin-top: 1rem; font-size: 0.8rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .logout-button { margin: 1rem 1.5rem; }

        /* --- Content Area --- */
        .content-area { flex-grow: 1; background-color: var(--body-bg); padding: 0; display: flex; flex-direction: column; margin-left: 260px; min-height: 100vh; transition: margin-left 0.3s ease; }

        /* --- Content Header --- */
        .content-header { background-color: var(--card-bg); padding: .8rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; box-shadow: var(--box-shadow-sm); position: sticky; top: 0; z-index: 1020; /* Above content, below sidebar */}
        .header-title h1 { font-size: 1.5rem; color: var(--dark-color); margin: 0; font-weight: 600; line-height: 1.2; }
        .user-info { display: flex; align-items: center; gap: 0.75rem;}
        .user-info span { font-size: 0.95rem; color: var(--text-muted); font-weight: 500; text-align: right; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color); }

        /* --- Main Content --- */
        #main-content { padding: calc(var(--spacer) * 1.5); flex-grow: 1; overflow-y: auto; }

        /* --- Card Styles --- */
        .card { background-color: var(--card-bg); border: none; border-radius: var(--border-radius-lg); margin-bottom: calc(var(--spacer) * 1.5); box-shadow: var(--box-shadow-sm); overflow: visible; /* Allow potential dropdowns to overflow */}
        .card-header { padding: 1rem 1.5rem; margin-bottom: 0; background-color: transparent; border-bottom: 1px solid var(--border-color); font-weight: 600; font-size: 1.1rem; color: var(--dark-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        .card-header-title { flex-grow: 1; font-size: 1.1rem; font-weight: 600; margin: 0;}
        .card-header-actions { display: flex; gap: 0.5rem; align-items: center; }
        .card-body { padding: 1.5rem; }
        .card-footer { padding: 1rem 1.5rem; background-color: transparent; border-top: 1px solid var(--border-color); }
        .card-body h2 { margin-top: 0; margin-bottom: calc(var(--spacer) * 1.5); font-size: 1.4rem; font-weight: 600; color: var(--primary-dark); }
        .card-body h3 { margin-top: 0; margin-bottom: var(--spacer); font-size: 1.2rem; font-weight: 600; color: var(--dark-color); }
        .card-body h3.card-subtitle { margin-top: 1.5rem; margin-bottom: .75rem; font-size: 1.1rem; font-weight: 600; color: var(--secondary-color); }
        .card-body p:last-child { margin-bottom: 0; }

        /* Specific Card Styles */
        .welcome-card { border-left: 5px solid var(--primary-color); background: linear-gradient(120deg, var(--primary-light), var(--card-bg));}
        .summary-card .card-header { background-color: #f0f2f5; }
        .score-summary-list { list-style: none; padding: 0; }
        .score-summary-list li { display: flex; align-items: center; padding: .85rem 0; border-bottom: 1px solid var(--border-color); font-size: 1rem; }
        .score-summary-list li:last-child { border-bottom: none; }
        .score-summary-list li i { font-size: 1.3rem; margin-right: var(--spacer); width: 1.5em; text-align: center; color: var(--primary-color); }
        .score-summary-list li .icon-literasi { color: #1e90ff; } /* Dodger Blue */
        .score-summary-list li .icon-numerasi { color: #32cd32; } /* Lime Green */
        .score-summary-list li span { flex-grow: 1; color: var(--text-muted); }
        .score-summary-list li strong { font-weight: 600; color: var(--dark-color); margin-left: auto; /* Push score to the right */}
        .score-summary-list li .sparkline-container { width: 80px; height: 30px; margin-left: 1rem; } /* Sparkline container */
        .sparkline-canvas { max-width: 100%; max-height: 100%; display: block; } /* Sparkline canvas */

        /* Student Psychometry List */
        .psychometry-summary-list { list-style: none; padding: 0; }
        .psychometry-summary-list li { display: flex; align-items: center; padding: .75rem 0; border-bottom: 1px dashed var(--border-color); font-size: 0.95rem; }
        .psychometry-summary-list li:last-child { border-bottom: none; }
        .psychometry-summary-list li i { font-size: 1.1rem; margin-right: 0.75rem; width: 1.5em; text-align: center; color: var(--secondary-color); }
        .psychometry-summary-list li span { flex-grow: 1; color: var(--text-muted); }
        .psychometry-summary-list li strong { font-weight: 500; color: var(--dark-color); margin-left: auto; }

        .quick-actions .card-body { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacer); }
        .test-actions .card-body { display: flex; gap: var(--spacer); flex-wrap: wrap; align-items: center; justify-content: center; padding: calc(var(--spacer) * 2); }
        .test-actions .btn { padding: 0.75rem 1.5rem; font-size: 1rem; }
        .history-section-card .card-body h2 { margin-bottom: 1rem; }

        /* Teacher/Admin Dashboard Specific */
        .summary-box { background-color: var(--card-bg); border-radius: var(--border-radius); padding: 1.5rem; text-align: center; box-shadow: var(--box-shadow-sm); border: 1px solid var(--border-color); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .summary-box:hover { transform: translateY(-3px); box-shadow: var(--box-shadow); }
        .summary-box .count { font-size: 2.25rem; font-weight: 700; color: var(--primary-color); display: block; margin-bottom: .25rem; line-height: 1.2; }
        .summary-box .label { font-size: .9rem; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em;}
        .chart-container { position: relative; height: 250px; width: 100%; margin: 0 auto; } /* Fixed height */
        .chart-placeholder { display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); font-style: italic; background-color: var(--light-color); border-radius: var(--border-radius); padding: 1rem; text-align: center; }
        .psychometry-summary-admin { list-style: none; padding: 0; margin: 0; }
        .psychometry-summary-admin li { display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; padding: 0.5rem 0; border-bottom: 1px dashed var(--border-color); }
        .psychometry-summary-admin li:last-child { border-bottom: none; }
        .psychometry-summary-admin span { color: var(--text-muted); }
        .psychometry-summary-admin strong { color: var(--dark-color); font-weight: 500; }

        /* --- Table Styles --- */
        .table-responsive { overflow-x: auto; border: 1px solid var(--border-color); border-radius: var(--border-radius); }
        .data-table { width: 100%; border-collapse: collapse; background-color: var(--card-bg); font-size: 0.9rem; margin-bottom: 0; /* Remove bottom margin as it's handled by table-responsive */}
        .data-table th, .data-table td { border: none; border-bottom: 1px solid var(--border-color); padding: 1rem 1.25rem; text-align: left; vertical-align: middle; }
        .data-table thead th { background-color: #f8f9fa; font-weight: 600; color: var(--secondary-color); font-size: 0.8rem; text-transform: uppercase; white-space: nowrap; border-bottom-width: 2px; border-bottom-color: var(--border-color); }
        .data-table tbody tr:last-child td { border-bottom: none; }
        /* .data-table tbody tr:nth-child(even) { background-color: rgba(0,0,0,.02); } */
        .data-table tbody tr:hover { background-color: #f1f3f5; /* Subtle hover */ }
        .data-table .actions-cell { white-space: nowrap; text-align: center; width: 1%; } /* Minimal width for actions */
        .data-table .status-badge { padding: 0.25em 0.6em; font-size: 75%; font-weight: 700; line-height: 1; color: #fff; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: var(--border-radius); }
        .data-table .status-aktif { background-color: var(--success-color); }
        .data-table .status-nonaktif { background-color: var(--danger-color); }
        .data-table .question-text-cell { max-width: 350px; white-space: normal; } /* Allow wrapping */
        .student-score-card .card-body h3 { font-size: 1.1rem; margin-bottom: 0.75rem; color: var(--primary-dark); }
        .student-score-card .table-responsive { margin-bottom: 1rem; margin-top: 0.5rem;}

        /* --- Settings Form --- */
        .settings-card .card-body h2 { margin-bottom: calc(var(--spacer) * 1.5); }
        .settings-form h4 { margin-top: 1.5rem; margin-bottom: 1rem; color: var(--primary-color); font-size: 1.1rem; font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: .5rem; display: flex; align-items: center; gap: 0.5rem;}
        .profile-pic-preview { width: 150px; height: 150px; border-radius: 50%; border: 4px solid var(--card-bg); box-shadow: var(--box-shadow); margin: 0 auto 1rem auto; object-fit: cover; display: block; background-color: #e9ecef; }
        .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .upload-btn { width: auto; }
        .upload-btn-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer;}
        #settings-message .alert { margin-bottom: 0; }

        /* --- Loader Styles --- */
        .loader-container { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 200px; color: var(--text-muted); gap: 1rem;}
        .loader { border: 5px solid #e9ecef; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .loader-small { border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid #fff; border-radius: 50%; width: 1rem; height: 1rem; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner-border { display: inline-block; width: 2rem; height: 2rem; vertical-align: -0.125em; border: .25em solid currentColor; border-right-color: transparent; border-radius: 50%; animation: .75s linear infinite spin; }
        .spinner-border-sm { width: 1rem; height: 1rem; border-width: .2em; }

        /* --- Modal Styles --- */
        .modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; outline: 0; background-color: rgba(0,0,0,0.5); animation: fadeIn 0.3s ease-out; }
        .modal.show { display: block; }
        .modal-dialog { position: relative; width: auto; margin: .5rem; pointer-events: none; display: flex; align-items: center; min-height: calc(100% - 1rem); max-width: 600px; } /* Centering */
        @media (min-width: 576px) { .modal-dialog { max-width: 500px; margin: 1.75rem auto; min-height: calc(100% - 3.5rem); } }
        @media (min-width: 768px) { .modal-dialog { max-width: 600px; } }
        @media (min-width: 992px) { .modal-dialog { max-width: 800px; } } /* Wider modals for user/question management */
        .modal-content { position: relative; display: flex; flex-direction: column; width: 100%; pointer-events: auto; background-color: var(--card-bg); background-clip: padding-box; border: 1px solid rgba(0,0,0,.2); border-radius: var(--border-radius-lg); outline: 0; box-shadow: var(--box-shadow-lg); }
        .modal-header { display: flex; flex-shrink: 0; align-items: center; justify-content: space-between; padding: var(--spacer) calc(var(--spacer) * 1.5); border-bottom: 1px solid var(--border-color); border-top-left-radius: calc(var(--border-radius-lg) - 1px); border-top-right-radius: calc(var(--border-radius-lg) - 1px); }
        .modal-title { margin-bottom: 0; line-height: 1.5; font-size: 1.25rem; font-weight: 600; color: var(--dark-color); }
        .modal-close-btn { padding: 1rem 1rem; margin: -1rem -1rem -1rem auto; background: transparent; border: 0; font-size: 1.5rem; font-weight: 700; line-height: 1; color: #000; text-shadow: 0 1px 0 #fff; opacity: .5; cursor: pointer;}
        .modal-close-btn:hover { opacity: .75; }
        .modal-body { position: relative; flex: 1 1 auto; padding: calc(var(--spacer) * 1.5); max-height: 70vh; overflow-y: auto; }
        .modal-footer { display: flex; flex-wrap: wrap; flex-shrink: 0; align-items: center; justify-content: flex-end; padding: calc(var(--spacer) * .75) calc(var(--spacer) * 1.5); border-top: 1px solid var(--border-color); border-bottom-right-radius: calc(var(--border-radius-lg) - 1px); border-bottom-left-radius: calc(var(--border-radius-lg) - 1px); gap: .5rem; }
        .modal-body .form-group:last-child { margin-bottom: 0; }
        .modal-body .row { margin-left: -5px; margin-right: -5px; }
        .modal-body .col, .modal-body .col-md-6 { padding-left: 5px; padding-right: 5px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Tab Styles --- */
        .nav-tabs { display: flex; flex-wrap: wrap; list-style: none; padding-left: 0; margin-bottom: 0; border-bottom: 1px solid var(--border-color); }
        .nav-item { margin-bottom: -1px; } /* Overlap border */
        .nav-link { display: block; padding: .75rem 1.25rem; color: var(--primary-color); text-decoration: none; background: none; border: 1px solid transparent; border-top-left-radius: var(--border-radius); border-top-right-radius: var(--border-radius); cursor: pointer; font-weight: 500; transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out; }
        .nav-link:hover, .nav-link:focus { border-color: var(--light-color) var(--light-color) var(--border-color); isolation: isolate; color: var(--primary-dark); background-color: #e9ecef;}
        .nav-link.active { color: var(--dark-color); background-color: var(--card-bg); border-color: var(--border-color) var(--border-color) var(--card-bg); font-weight: 600; }
        .tab-content { padding: calc(var(--spacer) * 1.5) 0 0 0; } /* No padding on sides, rely on card padding */

        /* --- Test Interface Styles --- */
        .test-container { background-color: var(--card-bg); padding: calc(var(--spacer) * 2); border-radius: var(--border-radius-lg); box-shadow: var(--box-shadow); margin-bottom: calc(var(--spacer)*1.5); }
        .test-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: var(--spacer); margin-bottom: calc(var(--spacer) * 1.5); padding-bottom: var(--spacer); border-bottom: 1px solid var(--border-color); }
        .test-title { font-size: 1.5rem; font-weight: 600; color: var(--primary-dark); margin: 0; flex-grow: 1; }
        .test-progress { font-size: 1rem; font-weight: 500; color: var(--text-muted); white-space: nowrap; background-color: #e9ecef; padding: 0.3rem 0.8rem; border-radius: 50px; }
        .question-area { margin-bottom: calc(var(--spacer) * 2); }
        .question-text { font-size: 1.2rem; margin-bottom: calc(var(--spacer) * 1.5); font-weight: 500; line-height: 1.7; }
        .options-area .form-check { background-color: transparent; padding: 1rem 1.25rem 1rem 3rem; border-radius: var(--border-radius); border: 1px solid var(--border-color); margin-bottom: .75rem; transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease; cursor: pointer; position: relative; }
        .options-area .form-check:hover { background-color: var(--primary-light); border-color: var(--primary-color); }
        .options-area .form-check-input { position: absolute; left: 1.25rem; top: 50%; transform: translateY(-50%) scale(1.2); margin: 0; cursor: pointer;}
        .options-area .form-check-input:checked + .form-check-label::before { /* Optional: Custom check style */ }
        .options-area .form-check-input:checked ~ .form-check-label { font-weight: 600; color: var(--primary-dark); }
        .options-area .form-check:has(input:checked) { border-color: var(--primary-color); background-color: var(--primary-light); box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);}
        .options-area .form-check-label { font-weight: 500; cursor: pointer; margin: 0; width: 100%;}
        .test-navigation { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: var(--spacer); margin-top: calc(var(--spacer) * 2); padding-top: calc(var(--spacer) * 1.5); border-top: 1px solid var(--border-color); }
        .test-result-container { text-align: center; }
        .test-result-container .result-icon { font-size: 4rem; margin-bottom: 1rem; }
        .test-result-container .result-icon.success { color: var(--success-color); }
        .test-result-container .result-icon.info { color: var(--info-color); }
        .test-result-container h2 { font-size: 2rem; margin-bottom: .5rem; font-weight: 600; }
        .test-result-container .score-display { font-size: 3.5rem; font-weight: 700; color: var(--primary-color); margin-bottom: 0.5rem; line-height: 1; }
        .test-result-container .score-detail { font-size: 1rem; color: var(--text-muted); margin-bottom: 1.5rem; }
        .test-result-container p.result-text { font-size: 1.1rem; color: var(--dark-color); margin-bottom: 1.5rem; font-weight: 500; }
        .test-result-container p.result-note { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 2rem; }
        .test-result-container .btn { margin-top: 1rem; }

        /* --- Logo Styling --- */
        .logo-image {
            height: 35px; /* Default height */
            width: auto;
            object-fit: contain; /* Ensure logo isn't distorted */
        }
        .login-container .logo-placeholder .logo-image {
            height: 45px; /* Slightly larger for login */
        }
        .sidebar-header .logo-placeholder {
            gap: 0.6rem; /* Ensure gap is appropriate */
            align-items: center;
        }
        .sidebar-header .logo-placeholder .logo-image {
             height: 30px; /* Adjust if needed for sidebar */
        }


        /* --- Responsiveness Overrides --- */
        @media (max-width: 992px) {
            .sidebar { width: 240px; } /* Slightly wider for medium */
            .content-area { margin-left: 240px; }
            .summary-box .count { font-size: 2rem; }
            .modal-dialog { max-width: 90%; }
        }
        @media (max-width: 768px) {
            /* Mobile Sidebar - Top Nav */
            body.dashboard-view { padding-top: 60px; } /* Space for fixed top nav */
            .sidebar { position: fixed; top: 0; left: 0; right: 0; width: 100%; height: 60px; box-shadow: var(--box-shadow-sm); border-bottom: 1px solid var(--border-color); overflow: visible; z-index: 1031; flex-direction: row; background-color: var(--sidebar-bg); /* Use dark bg */}
            .sidebar-header { padding: 0 1rem; border: none; width: auto; }
            .sidebar-header .logo-placeholder { font-size: 1.1rem;}
            .sidebar-header .logo-placeholder .logo-image { height: 30px; } /* Adjust logo size for mobile top nav */
            .sidebar nav { flex-grow: 1; padding: 0; overflow-x: auto; overflow-y: hidden; height: 60px; display: flex; align-items: center;}
            .sidebar nav ul { display: flex; height: 100%; white-space: nowrap; -ms-overflow-style: none; scrollbar-width: none; padding: 0 0.5rem; }
            .sidebar nav ul::-webkit-scrollbar { display: none; }
            .sidebar nav ul li { height: 100%; display: flex; align-items: center;}
            .sidebar nav ul li a { padding: 0 1rem; height: 100%; border-left: none; border-bottom: 4px solid transparent; margin: 0; display: flex; align-items: center; font-weight: 500;}
            .sidebar nav ul li a i.fas { width: auto; margin-right: .4rem; font-size: 1rem; }
            .sidebar nav ul li a:hover { background: none; color: var(--light-color); border-bottom-color: var(--secondary-light); }
            .sidebar nav ul li a.active { background: none; color: #fff; border-bottom-color: var(--primary-color); border-left-color: transparent; }
            .logout-button { display: none; } /* Needs relocating or hamburger menu */

            /* Mobile Content */
            .content-area { margin-left: 0; margin-top: 0; /* Removed top margin if sidebar was static */ }
            .content-header { padding: .75rem 1rem; display: none; /* Hide header on mobile, info might go in sidebar */ }
            #main-content { padding: 1rem; }
            .card-body h2 { font-size: 1.3rem; }
            .login-container { padding: 1.5rem; box-shadow: var(--box-shadow); }
            .profile-pic-preview { width: 120px; height: 120px; }
            .test-actions .card-body { flex-direction: column; align-items: stretch; }
            .test-actions .btn { width: 100%; }
            .chart-container { height: 280px; } /* Taller charts */
            .modal-dialog { margin: 10px auto; max-width: calc(100% - 20px); }
            .modal-body { max-height: 75vh; }
            .data-table { font-size: 0.85rem; }
            .data-table th, .data-table td { padding: 0.75rem 0.8rem; }
            .data-table .actions-cell { white-space: normal; text-align: left; }
            .data-table .actions-cell .btn-action { margin-right: .25rem; margin-bottom: .25rem; display: inline-flex; }
            .card-header { flex-direction: column; align-items: flex-start; }
            .card-header-actions { margin-top: 0.75rem; width: 100%; justify-content: flex-start; }
            .nav-tabs { /* Ensure tabs scroll */ overflow-x: auto; white-space: nowrap; flex-wrap: nowrap; -webkit-overflow-scrolling: touch; -ms-overflow-style: none; scrollbar-width: none; }
            .nav-tabs::-webkit-scrollbar { display: none; }
            .nav-link { padding: .6rem .8rem; font-size: .9rem; }
            .test-container { padding: 1rem; }
            .test-header { flex-direction: column; align-items: flex-start; }
            .test-progress { margin-top: .5rem; align-self: flex-start;}
            .question-text { font-size: 1.1rem; }
            .options-area .form-check { padding-left: 2.75rem; }
            .options-area .form-check-input { left: 1rem; }
            .test-navigation { flex-direction: column; gap: 0.75rem; }
            .test-navigation .btn { width: 100%; font-size: 1rem; padding: 0.75rem;}
            .score-summary-list li .sparkline-container { display: none; } /* Hide sparklines on mobile */
            .psychometry-summary-list li { flex-direction: column; align-items: flex-start; gap: 0.25rem; } /* Stack psychometry results */
            .psychometry-summary-list li strong { margin-left: 0; }
        }

        /* --- END OF CSS --- */
    </style>
</head>
<body>

    <!-- Login Section -->
    <div id="login-section">
         <div class="login-wrapper">
            <div class="login-container">
                <div class="logo-placeholder">
                    <!-- Replaced icon with image -->
                    <img src="logo.png" alt="Aku Bisa Simpan" class="logo-image">
                    <span> Aku Bisa Simpan</span>
                </div>
                <h2>Selamat Datang</h2>
                <p>Silakan login untuk mengakses fitur belajar.</p>

                <form id="login-form">
                    <div class="form-group mb-3">
                        <label for="role" class="form-label"><i class="fas fa-user-tag"></i> Login sebagai</label>
                        <select id="role" name="role" class="form-select" required>
                            <option value="murid">Murid</option>
                            <option value="guru">Guru</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label for="username" class="form-label"><i class="fas fa-user"></i> NISN / Username</label>
                        <input type="text" id="username" name="username" class="form-control" placeholder="Masukkan NISN atau Username Anda" required>
                    </div>
                    <div class="form-group mb-4">
                        <label for="password" class="form-label"><i class="fas fa-lock"></i> Password</label>
                        <input type="password" id="password" name="password" class="form-control" placeholder="Masukkan Password Anda" required>
                    </div>
                    <button type="submit" id="login-submit-btn" class="btn btn-primary btn-lg btn-block">Login <i class="fas fa-sign-in-alt"></i></button> <!-- Added ID -->
                    <div id="error-message" class="error-message mt-3"></div> <!-- Moved error div -->
                </form>
            </div>
        </div>
    </div>

    <!-- Dashboard Section (Initially Hidden) -->
    <div id="dashboard-section" class="hidden">
         <div class="dashboard-container">
            <aside class="sidebar">
                <div class="sidebar-header">
                     <div class="logo-placeholder">
                        <!-- Replaced icon with image -->
                        <img src="logo.png" alt="App Logo" class="logo-image">
                        <span>Aku Bisa Simpan</span>
                    </div>
                </div>
                <nav>
                    <ul id="sidebar-menu">
                        <li class="p-3 text-center"><div class="spinner-border spinner-border-sm text-light" role="status"> <span class="visually-hidden">Memuat menu...</span></div></li>
                    </ul>
                </nav>
                <button id="logout-button" class="btn btn-danger logout-button mb-3 mx-3">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </aside>

            <main class="content-area">
                <header class="content-header">
                    <div class="header-title">
                         <h1 id="page-title">Dashboard</h1>
                    </div>
                    <div class="user-info">
                        <span id="user-name">Nama Pengguna</span>
                        <img id="user-avatar" src="assets/default-profile.png" alt="Avatar" class="user-avatar" onerror="this.src='assets/default-profile.png';">
                    </div>
                </header>
                <section id="main-content">
                     <div class="loader-container">
                        <div class="loader"></div>
                        <p>Memuat konten...</p>
                     </div>
                </section>
            </main>
        </div>
    </div>

    <!-- User Management Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="user-form" novalidate> <!-- Added novalidate to handle validation manually -->
                    <div class="modal-header">
                        <h5 class="modal-title" id="user-modal-title">Tambah Pengguna</h5>
                        <button type="button" class="modal-close-btn" onclick="closeModal('user-modal')" aria-label="Close">×</button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="user-edit-mode" value="">
                        <input type="hidden" id="user-edit-identifier" value="">
                        <div id="user-modal-error" class="alert alert-danger hidden"><i class="fas fa-exclamation-triangle"></i><span>Error placeholder</span></div> <!-- Improved alert -->
                        <div class="row">
                            <div class="col-md-6"> <div class="form-group"> <label for="user-nama" class="form-label">Nama Lengkap <span class="text-danger">*</span></label> <input type="text" id="user-nama" class="form-control" required> <div class="invalid-feedback">Nama lengkap wajib diisi.</div></div> </div>
                            <div class="col-md-6"> <div class="form-group"> <label for="user-role" class="form-label">Role <span class="text-danger">*</span></label> <select id="user-role" class="form-select" required onchange="toggleUserFormFields()"> <option value="guru">Guru</option> <option value="murid">Murid</option> <option value="admin">Admin</option> </select> </div> </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6"> <div class="form-group" id="user-identifier-group"> <label for="user-identifier" id="user-identifier-label" class="form-label">Username <span class="text-danger">*</span></label> <input type="text" id="user-identifier" class="form-control" required> <div class="invalid-feedback">Username/NISN wajib diisi.</div></div> </div>
                            <div class="col-md-6"> <div class="form-group"> <label for="user-status" class="form-label">Status <span class="text-danger">*</span></label> <select id="user-status" class="form-select" required> <option value="aktif">Aktif</option> <option value="nonaktif">Nonaktif</option> </select> </div> </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6"> <div class="form-group"> <label for="user-password" class="form-label">Password <span id="password-required-indicator" class="text-danger">*</span></label> <input type="password" id="user-password" class="form-control" placeholder="Kosongkan jika tidak diubah"> <small id="password-help" class="form-text"></small> <div class="invalid-feedback">Password minimal 6 karakter.</div></div> </div>
                            <div class="col-md-6"> <div class="form-group"> <label for="user-confirm-password" class="form-label">Konfirmasi Password <span id="confirm-password-required-indicator" class="text-danger">*</span></label> <input type="password" id="user-confirm-password" class="form-control"> <div class="invalid-feedback">Konfirmasi password tidak cocok.</div></div> </div>
                        </div>
                        <div id="murid-fields" class="hidden"> <hr> <h6 class="text-muted">Data Tambahan Murid (Opsional)</h6> <div class="row"> <div class="col-md-6"> <div class="form-group"> <label for="user-parentName" class="form-label">Nama Ortu/Wali</label> <input type="text" id="user-parentName" class="form-control"> </div> </div> <div class="col-md-6"> <div class="form-group"> <label for="user-address" class="form-label">Alamat</label> <textarea id="user-address" class="form-control" rows="2"></textarea> </div> </div> </div> </div>
                    </div>
                    <div class="modal-footer"> <button type="button" class="btn btn-secondary" onclick="closeModal('user-modal')">Batal</button> <button type="submit" class="btn btn-primary" id="user-modal-save-btn"><i class="fas fa-save"></i> Simpan</button> </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Question Management Modal -->
    <div id="question-modal" class="modal">
        <div class="modal-dialog"> <!-- Default size -->
            <div class="modal-content">
                <form id="question-form" novalidate>
                    <div class="modal-header">
                        <h5 class="modal-title" id="question-modal-title">Tambah Soal</h5>
                        <button type="button" class="modal-close-btn" onclick="closeModal('question-modal')" aria-label="Close">×</button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="question-edit-id" value="">
                        <input type="hidden" id="question-bank-key" value="">
                        <div id="question-modal-error" class="alert alert-danger hidden"><i class="fas fa-exclamation-triangle"></i><span>Error placeholder</span></div>

                        <div class="form-group mb-3">
                            <label for="question-text" class="form-label">Teks Pertanyaan <span class="text-danger">*</span></label>
                            <textarea id="question-text" class="form-control" rows="3" required></textarea>
                             <div class="invalid-feedback">Teks pertanyaan wajib diisi.</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6"> <div class="form-group mb-3"> <label for="question-option-a" class="form-label">Opsi A <span class="text-danger">*</span></label> <input type="text" id="question-option-a" class="form-control" required> <div class="invalid-feedback">Opsi A wajib diisi.</div></div> </div>
                            <div class="col-md-6"> <div class="form-group mb-3"> <label for="question-option-b" class="form-label">Opsi B <span class="text-danger">*</span></label> <input type="text" id="question-option-b" class="form-control" required> <div class="invalid-feedback">Opsi B wajib diisi.</div></div> </div>
                        </div>
                         <div class="row">
                            <div class="col-md-6"> <div class="form-group mb-3"> <label for="question-option-c" class="form-label">Opsi C <span class="text-danger">*</span></label> <input type="text" id="question-option-c" class="form-control" required> <div class="invalid-feedback">Opsi C wajib diisi.</div></div> </div>
                            <div class="col-md-6"> <div class="form-group mb-3" id="question-option-d-group"> <label for="question-option-d" class="form-label">Opsi D <span class="text-danger">*</span></label> <input type="text" id="question-option-d" class="form-control" required> <div class="invalid-feedback">Opsi D wajib diisi.</div></div> </div>
                        </div>
                         <div class="form-group mb-3" id="question-answer-group">
                            <label for="question-answer" class="form-label">Jawaban Benar <span class="text-danger">*</span></label>
                            <select id="question-answer" class="form-select" required>
                                <option value="" disabled selected>-- Pilih Jawaban --</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                            </select>
                             <div class="invalid-feedback">Jawaban benar wajib dipilih.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('question-modal')">Batal</button>
                        <button type="submit" class="btn btn-primary" id="question-modal-save-btn"><i class="fas fa-save"></i> Simpan Soal</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script>
        // --- START OF JAVASCRIPT ---

        // --- Firebase Configuration ---
        // IMPORTANT: Replace with your actual Firebase project configuration!
        const firebaseConfig = {
          apiKey: "AIzaSyDEGaps4Kqsq0DwyyRPzunAM_qEbZ9ANPc", // Replace with your API key
          authDomain: "save-eduapp.firebaseapp.com",
          projectId: "save-eduapp",
          storageBucket: "save-eduapp.firebasestorage.app",
          messagingSenderId: "593244504314",
          appId: "1:593244504314:web:db0bc7279a39dfebd2c943",
          measurementId: "G-8V8PDYWR0R" // Optional
        };

        // Initialize Firebase
        // Check if Firebase is already initialized to avoid errors during hot reloads
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app(); // if already initialized, use that instance
        }

        // Initialize Analytics (optional)
        try {
            firebase.analytics();
        } catch (e) {
            console.warn("Firebase Analytics initialization failed:", e);
        }


        // Get Firebase Service Handles
        const fbAuth = firebase.auth();
        const fbDb = firebase.firestore();
        const fbStorage = firebase.storage();

        // --- IMPORTANT SECURITY NOTE ---
        // Make sure you have configured Firebase Security Rules for Firestore and Storage
        // to protect your data from unauthorized access. The default rules are often too permissive.
        // --- END SECURITY NOTE ---


        document.addEventListener('DOMContentLoaded', () => {

            // --- Global Elements & State ---
            const loginSection = document.getElementById('login-section');
            const dashboardSection = document.getElementById('dashboard-section');
            let currentUser = null; // Will be populated by Firebase Auth state listener or simulation
            let activeCharts = {}; // Store active chart instances { canvasId: chartInstance }
            let currentActiveUserTab = 'guru';
            let currentActiveQuestionBank = 'literasi';
            let currentTestState = {};
            const threeOptionTestKeys = ['gayaBelajar', 'kecerdasanGanda']; // Types needing only 3 options

            // --- SIMULASI DATA (To be replaced with Firebase) ---
            // FIREBASE INTEGRATION POINT: Replace these hardcoded objects with Firestore data fetching.
            const users = {}; // Will be populated below
            const testData = {}; // Will be populated below
            let questionBanks = {}; // Will be populated below

             // -- Hardcoded user data (Simulation) --
            Object.assign(users, {
                murid: [ { nisn: '1234567890', password: 'password123', name: 'Budi Doremi', role: 'murid', parentName: 'Ayah Budi', address: 'Jl. Merdeka 1', profilePic: 'assets/default-profile.png', status: 'aktif' }, { nisn: '0987654321', password: 'password456', name: 'Siti Aminah', role: 'murid', parentName: 'Ibu Siti', address: 'Jl. Pahlawan 2', profilePic: 'assets/default-profile.png', status: 'aktif' } ],
                guru: [ { username: 'guru01', password: 'passwordguru', name: 'Ibu Guru Hebat', role: 'guru', profilePic: 'assets/default-profile.png', status: 'aktif' }, { username: 'guru02', password: 'passwordguru2', name: 'Bapak Guru Keren', role: 'guru', profilePic: 'assets/default-profile.png', status: 'nonaktif' } ],
                admin: [ { username: 'admin', password: 'passwordadmin', name: 'Administrator Utama', role: 'admin', profilePic: 'assets/default-profile.png', status: 'aktif' } ]
            });
             // -- Hardcoded test data (Simulation) --
             Object.assign(testData, {
                 '1234567890': { // Budi
                     literasi: [ { date: '2024-01-15', score: 85 }, { date: '2024-03-20', score: 90 }, { date: '2024-05-10', score: 88 } ],
                     numerasi: [ { date: '2024-02-10', score: 78 }, { date: '2024-04-15', score: 82 } ],
                     gayaBelajar: [{ date: '2024-04-01', result: 'Visual' }],
                     modalitasBelajar: [{ date: '2024-04-05', result: 'Auditori' }],
                     kecerdasanGanda: [{ date: '2024-04-10', result: 'Logis-Matematis, Linguistik' }],
                     ketertarikan: [{ date: '2024-04-15', result: 'Sains, Seni' }],
                     highestScores: { literasi: 90, numerasi: 82 } // Updated highest scores
                 },
                 '0987654321': { // Siti
                     literasi: [ { date: '2024-03-05', score: 88 }, { date: '2024-05-01', score: 92 } ],
                     numerasi: [ { date: '2024-05-15', score: 75 } ], // Added numerasi score
                     gayaBelajar: [{ date: '2024-05-01', result: 'Auditori' }],
                     modalitasBelajar: [{ date: '2024-05-05', result: 'Visual' }],
                     kecerdasanGanda: [{ date: '2024-05-10', result: 'Interpersonal, Visual-Spasial' }],
                     ketertarikan: [], // No ketertarikan data yet
                     highestScores: { literasi: 92, numerasi: 75 } // Updated highest scores
                 }
             });
            // -- Hardcoded question banks (Simulation) --
             Object.assign(questionBanks, {
                 literasi: [ { id: 'LIT001', text: 'Antonim dari kata "Besar" adalah...', options: ['Kecil', 'Luas', 'Lebar', 'Tinggi'], answer: 'A', type: 'multiple-choice' }, { id: 'LIT002', text: 'Sinonim dari kata "Senang" adalah...', options: ['Sedih', 'Marah', 'Gembira', 'Takut'], answer: 'C', type: 'multiple-choice' }, { id: 'LIT003', text: 'Ibu kota Indonesia adalah...', options: ['Surabaya', 'Bandung', 'Medan', 'Jakarta'], answer: 'D', type: 'multiple-choice' } ],
                 numerasi: [ { id: 'NUM001', text: 'Hasil dari 5 + 7 adalah...', options: ['10', '11', '12', '13'], answer: 'C', type: 'multiple-choice' }, { id: 'NUM002', text: 'Hasil dari 3 x 4 adalah...', options: ['7', '12', '1', '9'], answer: 'B', type: 'multiple-choice' }, { id: 'NUM003', text: 'Angka setelah 9 adalah...', options: ['8', '10', '11', '7'], answer: 'B', type: 'multiple-choice' } ],
                 gayaBelajar: [ { id: 'GAB001', text: 'Saat belajar, saya lebih suka...', options: ['Melihat diagram/gambar', 'Mendengarkan penjelasan', 'Melakukan praktik langsung'], answer: null, type: 'multiple-choice-3opt' } ],
                 modalitasBelajar: [ { id: 'MOB001', text: 'Saya mudah mengingat informasi jika...', options: ['Ditulis', 'Diucapkan', 'Dicoba', 'Dilihat polanya'], answer: 'B', type: 'multiple-choice' } ], // Remains 4 options
                 kecerdasanGanda: [ { id: 'KEC001', text: 'Saya merasa paling nyaman saat...', options: ['Bekerja dengan angka', 'Berbicara/menulis', 'Berada di alam'], answer: null, type: 'multiple-choice-3opt' } ],
                 ketertarikan: [ { id: 'KET001', text: 'Aktivitas yang paling saya nikmati adalah...', options: ['Membaca buku fiksi', 'Melakukan eksperimen sains', 'Bermain alat musik', 'Berolahraga'], answer: 'B', type: 'multiple-choice' } ] // Remains 4 options
            });

            // --- Generate Question ID Function ---
            const generateQuestionId = (bankKey) => {
                // FIREBASE INTEGRATION POINT: This ID generation might be handled by Firestore automatically (auto-IDs)
                // or you might implement a counter in Firestore if sequential IDs are strictly needed.
                const prefix = bankKey.substring(0, 3).toUpperCase();
                const bank = questionBanks[bankKey] || [];
                let nextNum = 1;
                if (bank.length > 0) {
                    const existingNums = bank.map(q => parseInt(q.id.replace(prefix, ''), 10)).filter(num => !isNaN(num));
                    if (existingNums.length > 0) {
                        nextNum = Math.max(...existingNums) + 1;
                    }
                }
                return `${prefix}${String(nextNum).padStart(3, '0')}`;
            };
            window.generateQuestionId = generateQuestionId;


            // --- UI Utility Functions ---
            const showNotification = (message, type = 'success', duration = 3000) => {
                const containerId = 'notification-container';
                let container = document.getElementById(containerId);
                if (!container) {
                    container = document.createElement('div');
                    container.id = containerId;
                    container.style.position = 'fixed';
                    container.style.top = '1rem';
                    container.style.right = '1rem';
                    container.style.zIndex = '1060'; /* Higher than modal */
                    container.style.maxWidth = '350px';
                    document.body.appendChild(container);
                }

                const alertIcon = type === 'success' ? 'fa-check-circle' : (type === 'danger' ? 'fa-exclamation-triangle' : 'fa-info-circle');
                const alert = document.createElement('div');
                alert.className = `alert alert-${type} alert-dismissible fade`; // Start faded out
                alert.style.boxShadow = 'var(--box-shadow)';
                alert.setAttribute('role', 'alert');
                alert.innerHTML = `<i class="fas ${alertIcon}"></i> <div class="flex-grow-1">${message}</div> <button type="button" class="btn-close" aria-label="Close"></button>`;

                // Add close functionality
                const closeButton = alert.querySelector('.btn-close');
                const removeAlert = () => {
                    alert.classList.remove('show');
                    // Use transitionend event for smoother removal
                    alert.addEventListener('transitionend', () => {
                        if (alert.parentNode) {
                            alert.remove();
                            // Remove container if empty
                            if (container && container.children.length === 0) {
                                container.remove();
                            }
                        }
                    }, { once: true });
                };
                closeButton.addEventListener('click', removeAlert);

                container.appendChild(alert);
                // Trigger fade in
                setTimeout(() => alert.classList.add('show'), 50);

                // Auto-dismiss timer
                setTimeout(removeAlert, duration);
            };
            window.closeModal = (modalId) => { const modal = document.getElementById(modalId); if (modal) modal.classList.remove('show'); };
            window.openModal = (modalId) => { const modal = document.getElementById(modalId); if (modal) modal.classList.add('show'); };
            const displayModalError = (modalId, message) => { const errorDiv = document.getElementById(`${modalId}-error`); if (errorDiv) { errorDiv.querySelector('span').innerHTML = message; errorDiv.classList.remove('hidden'); } }; // Use innerHTML for <br>
            const clearModalError = (modalId) => { const errorDiv = document.getElementById(`${modalId}-error`); if (errorDiv) errorDiv.classList.add('hidden'); };
            const toggleButtonLoading = (buttonId, isLoading) => {
                 const button = document.getElementById(buttonId); if (!button) return;
                 if (isLoading) {
                     button.disabled = true;
                     button.dataset.originalHtml = button.innerHTML; // Store original content
                     button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Memproses...`; // Generic loading text
                 } else {
                     button.disabled = false;
                     if (button.dataset.originalHtml) {
                         button.innerHTML = button.dataset.originalHtml; // Restore original content
                         delete button.dataset.originalHtml; // Clean up dataset
                     }
                 }
            };
            const validateForm = (formElement) => {
                formElement.classList.remove('was-validated'); // Clear previous validation states
                let isValid = true;
                const fields = formElement.querySelectorAll('input[required], select[required], textarea[required]');

                fields.forEach(field => {
                    field.classList.remove('is-invalid'); // Reset invalid state
                    let fieldValid = true;

                    if (!field.value || (field.type === 'select-one' && field.value === "")) {
                        fieldValid = false;
                    } else if (field.type === 'password') {
                        // Password specific checks (only if required or has value)
                        if (field.required || field.value) {
                            if (field.id === 'user-password' && field.value.length < 6) {
                                fieldValid = false;
                                const feedback = field.closest('.form-group').querySelector('.invalid-feedback');
                                if (feedback) feedback.textContent = 'Password minimal 6 karakter.';
                            } else if (field.id === 'user-confirm-password') {
                                const passwordField = document.getElementById('user-password');
                                if (passwordField && passwordField.value !== field.value) {
                                    fieldValid = false;
                                    const feedback = field.closest('.form-group').querySelector('.invalid-feedback');
                                    if (feedback) feedback.textContent = 'Konfirmasi password tidak cocok.';
                                }
                            }
                        }
                    } else if (field.type === 'number' && field.id === 'user-identifier' && !/^\d+$/.test(field.value)) {
                         fieldValid = false; // Example: Ensure NISN is numeric if type=number
                         const feedback = field.closest('.form-group').querySelector('.invalid-feedback');
                         if (feedback) feedback.textContent = 'NISN harus berupa angka.';
                    }

                    if (!fieldValid) {
                        isValid = false;
                        field.classList.add('is-invalid');
                    }
                });

                // Add 'was-validated' only after checking all fields
                // This allows Bootstrap's :invalid styles to apply correctly if needed
                // formElement.classList.add('was-validated');
                return isValid;
            };


            // --- View Management Functions ---
            const showLogin = () => { loginSection.classList.remove('hidden'); dashboardSection.classList.add('hidden'); document.body.classList.add('login-view'); document.body.classList.remove('dashboard-view'); destroyActiveCharts(); };
            const showDashboard = () => { loginSection.classList.add('hidden'); dashboardSection.classList.remove('hidden'); document.body.classList.remove('login-view'); document.body.classList.add('dashboard-view'); initializeDashboard(); };

            // --- Login Logic ---
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    const submitButton = loginForm.querySelector('button[type="submit"]'); // Use the button's ID
                    const role = document.getElementById('role').value;
                    const username = document.getElementById('username').value.trim();
                    const password = document.getElementById('password').value;
                    const errorMsgDiv = document.getElementById('error-message');
                    errorMsgDiv.classList.remove('show'); // Hide previous error

                    if (!username || !password) { errorMsgDiv.textContent = 'NISN/Username dan Password wajib diisi.'; errorMsgDiv.classList.add('show'); return; }

                    toggleButtonLoading(submitButton.id, true); // Use the button's ID

                    // FIREBASE INTEGRATION POINT: Replace this setTimeout block with Firebase Authentication (e.g., signInWithEmailAndPassword)
                    // You'll need to:
                    // 1. Construct email/identifier based on role if needed (e.g., username@yourapp.com or use NISN directly if emails are structured that way).
                    // 2. Call Firebase Auth sign-in method (fbAuth.signInWithEmailAndPassword).
                    // 3. On success: Get the Firebase user UID (userCredential.user.uid). Fetch the corresponding user profile data (role, name, status, etc.) from Firestore using the UID (fbDb.collection('users').doc(uid).get()). Set `currentUser`. Call `showDashboard()`.
                    // 4. On failure: Handle errors (auth/wrong-password, auth/user-not-found, network error, inactive user status from Firestore). Show appropriate message in `errorMsgDiv`.
                    // 5. Remember to handle the loading state (`toggleButtonLoading`) correctly around async Firebase calls.

                    // Simulate login delay
                    setTimeout(() => {
                        let userFound = null;
                        // Simulation: Check hardcoded data
                        if (role === 'murid') userFound = users.murid.find(u => u.nisn === username && u.password === password && u.status === 'aktif');
                        else if (role === 'guru') userFound = users.guru.find(u => u.username === username && u.password === password && u.status === 'aktif');
                        else if (role === 'admin') userFound = users.admin.find(u => u.username === username && u.password === password && u.status === 'aktif');

                        toggleButtonLoading(submitButton.id, false); // Use the button's ID

                        if (userFound) {
                            currentUser = { ...userFound };
                            // FIREBASE INTEGRATION POINT: Instead of sessionStorage, rely on Firebase Auth's persistence.
                            // You might store non-sensitive info like role/name in sessionStorage for quick access if needed, but Auth state is primary.
                            sessionStorage.setItem('loggedInUser', JSON.stringify(currentUser)); // Keep for simulation until Firebase Auth is fully implemented
                            showDashboard();
                        } else {
                            // Simulation: Check if user exists but is inactive
                            let inactiveUser = null;
                            if (role === 'murid') inactiveUser = users.murid.find(u => u.nisn === username && u.password === password);
                            else if (role === 'guru') inactiveUser = users.guru.find(u => u.username === username && u.password === password);
                            else if (role === 'admin') inactiveUser = users.admin.find(u => u.username === username && u.password === password);

                            if (inactiveUser && inactiveUser.status === 'nonaktif') {
                                errorMsgDiv.textContent = 'Akun Anda saat ini tidak aktif. Hubungi administrator.';
                            } else {
                                errorMsgDiv.textContent = 'Login gagal. Periksa kembali NISN/Username dan Password Anda.';
                            }
                            errorMsgDiv.classList.add('show');
                        }
                    }, 500); // 0.5 second delay simulation
                });
            } else { console.error("Login form not found!"); }

            // --- Dashboard Logic ---
            let mainContent, pageTitle, userNameDisplay, userAvatar, sidebarNav, logoutButton;
            const initializeDashboard = () => {
                mainContent = document.getElementById('main-content'); pageTitle = document.getElementById('page-title'); userNameDisplay = document.getElementById('user-name'); userAvatar = document.getElementById('user-avatar'); sidebarNav = document.getElementById('sidebar-menu'); logoutButton = document.getElementById('logout-button');
                if (!mainContent || !pageTitle || !userNameDisplay || !userAvatar || !sidebarNav || !logoutButton) { console.error("Dashboard elements missing!"); if (dashboardSection) dashboardSection.innerHTML = '<div class="alert alert-danger m-5">Error memuat elemen dashboard.</div>'; return; }

                // FIREBASE INTEGRATION POINT: `currentUser` should be populated from Firebase Auth state and Firestore profile data.
                // The profilePic URL might come from Firebase Storage.
                userNameDisplay.textContent = currentUser.name;
                userAvatar.src = currentUser.profilePic || 'assets/default-profile.png'; // Use default if profilePic is missing
                userAvatar.onerror = () => { userAvatar.src = 'assets/default-profile.png'; }; // Fallback

                generateSidebarMenu();
                const initialMenuItem = (menus[currentUser.role] && menus[currentUser.role].find(item => item.section)); // Find first non-divider
                const initialSection = initialMenuItem?.section || 'dashboard-home'; const initialTitle = initialMenuItem?.title || 'Dashboard';
                loadContent(initialSection, initialTitle);
                logoutButton.removeEventListener('click', handleLogout); logoutButton.addEventListener('click', handleLogout);
            };
            const handleLogout = () => {
                if (confirm("Apakah Anda yakin ingin keluar?")) {
                    // FIREBASE INTEGRATION POINT: Call Firebase Auth `signOut()` method here.
                    // fbAuth.signOut().then(() => {
                    //     console.log("User signed out successfully.");
                    //     // The Auth state listener (initializeApp) should handle redirecting to login.
                    // }).catch((error) => {
                    //     console.error("Sign out error:", error);
                    //     showNotification("Gagal logout.", "danger");
                    // });

                    // --- Simulation Logout ---
                    currentUser = null;
                    sessionStorage.removeItem('loggedInUser'); // Clear simulation session data
                    showLogin();
                    // Clear UI elements (optional, as showLogin hides the dashboard)
                    if (sidebarNav) sidebarNav.innerHTML = '<li class="p-3 text-center"><div class="spinner-border spinner-border-sm text-light"></div></li>';
                    if (mainContent) mainContent.innerHTML = '';
                    if (pageTitle) pageTitle.textContent = 'Dashboard';
                    if (userNameDisplay) userNameDisplay.textContent = 'Pengguna';
                    if (userAvatar) userAvatar.src = 'assets/default-profile.png';
                    // --- End Simulation Logout ---
                }
             };

            // --- Chart Management ---
            const destroyActiveCharts = () => {
                Object.values(activeCharts).forEach(chart => {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                    }
                });
                activeCharts = {};
            };

            // --- Content Loading ---
            const showLoading = (containerId = 'main-content') => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `<div class="loader-container p-5"><div class="loader"></div><p>Memuat konten...</p></div>`;
                }
            };
            const loadContent = (section, title, isHistoryView = false) => {
                // FIREBASE INTEGRATION POINT: Most `load...` functions below will need to fetch data from Firestore
                // instead of reading from the global `users`, `testData`, `questionBanks` objects.
                // Use async/await with Firebase SDK calls (e.g., fbDb.collection(...).get()). Show loading indicators during fetches.

                if (!mainContent || !pageTitle || !currentUser) return;
                destroyActiveCharts(); // Destroy charts before loading new content
                showLoading(); // Show loading in main content area
                pageTitle.textContent = title;
                const originalSectionForHighlight = isHistoryView ? section.replace('-history', '') : section;
                document.querySelectorAll('#sidebar-menu li a').forEach(link => link.classList.remove('active'));
                const activeLink = document.querySelector(`#sidebar-menu li a[data-section="${originalSectionForHighlight}"]`);
                if (activeLink) activeLink.classList.add('active');

                // Simulate slight delay for realistic feel
                setTimeout(() => {
                    if (!mainContent || !currentUser) return; // Check again
                    mainContent.innerHTML = ''; // Clear loading

                    try {
                        if (isHistoryView && section.endsWith('-history')) {
                            const originalSection = section.replace('-history', ''); const parts = originalSection.split('-');
                            if (parts.length >= 2 && parts[0] === 'test') {
                                const dataKey = parts.slice(1).join('-'); // Reconstruct key like 'gaya-belajar'
                                const originalMenuItem = menus.murid.find(m => m.section === originalSection);
                                const originalTitle = originalMenuItem?.title.replace('Test ','') || title.replace('Riwayat Test ', '');
                                const isScoredTest = !threeOptionTestKeys.includes(dataKey) && dataKeyRequiresScore(dataKey); // Use helper
                                loadTestHistory(originalSection, dataKey, originalTitle, isScoredTest);
                            } else { mainContent.innerHTML = '<div class="alert alert-warning">Tidak dapat memuat riwayat untuk bagian ini.</div>'; }
                            return; // Stop further processing for history view
                        }

                        // Route to the correct content loader function
                        switch (section) {
                            case 'dashboard-home':
                                if (currentUser.role === 'murid') loadStudentDashboardHome();
                                else if (currentUser.role === 'guru') loadTeacherDashboardHome();
                                else if (currentUser.role === 'admin') loadAdminDashboardHome();
                                break;
                            case 'pengaturan': loadSettings(); break;
                            // Student Test Sections
                            case 'test-literasi': loadTestSection(section, 'literasi', 'Literasi'); break;
                            case 'test-numerasi': loadTestSection(section, 'numerasi', 'Numerasi'); break;
                            case 'test-gaya-belajar': loadTestSection(section, 'gayaBelajar', 'Gaya Belajar'); break;
                            case 'test-modalitas-belajar': loadTestSection(section, 'modalitasBelajar', 'Modalitas Belajar'); break;
                            case 'test-kecerdasan-ganda': loadTestSection(section, 'kecerdasanGanda', 'Kecerdasan Ganda'); break;
                            case 'test-ketertarikan': loadTestSection(section, 'ketertarikan', 'Ketertarikan'); break;
                            // Guru/Admin Sections
                            case 'kelola-soal-guru':
                            case 'kelola-soal-admin': loadKelolaSoal(); break;
                            case 'lihat-nilai': loadLihatNilai(); break;
                            case 'kelola-pengguna': loadKelolaPengguna(); break; // Admin only
                            default: mainContent.innerHTML = `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Konten untuk "${title}" (${section}) tidak ditemukan atau belum diimplementasikan.</div>`;
                        }
                    } catch (error) {
                        console.error(`Error loading content "${section}":`, error);
                        mainContent.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Terjadi kesalahan saat memuat konten. Silakan coba lagi atau hubungi support.</div>';
                    }
                }, 150); // Shorter delay after initial load is faster
            };

            // --- Specific Content Loaders ---

            // Student Dashboard & Tests
            const loadStudentDashboardHome = () => {
                 // FIREBASE INTEGRATION POINT: Fetch student's test data (`testData[studentNisn]`) from Firestore.
                 // Example: const studentDoc = await fbDb.collection('users').doc(currentUser.uid).get(); const studentData = studentDoc.data();
                 // Fetch history subcollections if needed for sparklines.
                 const studentNisn = currentUser.nisn; // Simulation: Use NISN as key
                 if (!studentNisn) { mainContent.innerHTML = `<div class="alert alert-danger">Error: NISN siswa tidak ditemukan.</div>`; return; }
                 const studentData = testData[studentNisn] || { highestScores: {} }; // Simulation
                 const scores = studentData.highestScores || {};

                 // Get latest non-scored results (Simulation)
                 const latestGayaBelajar = getLatestResult(studentNisn, 'gayaBelajar');
                 const latestModalitas = getLatestResult(studentNisn, 'modalitasBelajar');
                 const latestKecerdasan = getLatestResult(studentNisn, 'kecerdasanGanda');
                 const latestKetertarikan = getLatestResult(studentNisn, 'ketertarikan');

                 mainContent.innerHTML = `
                    <div class="card welcome-card mb-4">
                        <div class="card-body p-4">
                            <h2 class="mb-1">Selamat Datang, ${currentUser.name}!</h2>
                            <p class="text-muted mb-0">Berikut adalah ringkasan hasil test terbaikmu sejauh ini.</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="card summary-card h-100">
                                <div class="card-header"><span class="card-header-title">Skor Tertinggi & Tren</span></div>
                                <div class="card-body">
                                    <ul class="score-summary-list">
                                        <li>
                                            <i class="fas fa-book-open icon-literasi"></i>
                                            <span>Test Literasi</span>
                                            <div class="sparkline-container" id="literasi-sparkline-container">
                                                <canvas id="literasi-sparkline"></canvas>
                                            </div>
                                            <strong>${scores.literasi ?? '--'}</strong>
                                        </li>
                                        <li>
                                            <i class="fas fa-calculator icon-numerasi"></i>
                                            <span>Test Numerasi</span>
                                            <div class="sparkline-container" id="numerasi-sparkline-container">
                                                <canvas id="numerasi-sparkline"></canvas>
                                            </div>
                                            <strong>${scores.numerasi ?? '--'}</strong>
                                        </li>
                                    </ul>
                                </div>
                             </div>
                         </div>
                         <div class="col-lg-6 mb-4">
                              <div class="card h-100">
                                 <div class="card-header"><span class="card-header-title">Hasil Psikometri Terbaru</span></div>
                                 <div class="card-body">
                                     <ul class="psychometry-summary-list">
                                         <li><i class="fas fa-palette"></i><span>Gaya Belajar</span><strong>${latestGayaBelajar}</strong></li>
                                         <li><i class="fas fa-brain"></i><span>Modalitas Belajar</span><strong>${latestModalitas}</strong></li>
                                         <li><i class="fas fa-lightbulb"></i><span>Kecerdasan Ganda</span><strong>${latestKecerdasan}</strong></li>
                                         <li><i class="fas fa-heart"></i><span>Ketertarikan</span><strong>${latestKetertarikan}</strong></li>
                                     </ul>
                                 </div>
                              </div>
                         </div>
                     </div>
                     <div class="row">
                        <div class="col-12">
                            <div class="card quick-actions">
                                <div class="card-header"><span class="card-header-title">Mulai Test Baru</span></div>
                                <div class="card-body">
                                    <button class="btn btn-outline-secondary" onclick="window.navigateTo('test-literasi', 'Test Literasi')"><i class="fas fa-pen"></i> Test Literasi</button>
                                    <button class="btn btn-outline-secondary" onclick="window.navigateTo('test-numerasi', 'Test Numerasi')"><i class="fas fa-calculator"></i> Test Numerasi</button>
                                    <button class="btn btn-outline-secondary" onclick="window.navigateTo('test-gaya-belajar', 'Test Gaya Belajar')"><i class="fas fa-palette"></i> Test Gaya Belajar</button>
                                    <button class="btn btn-outline-secondary" onclick="window.navigateTo('test-modalitas-belajar', 'Test Modalitas Belajar')"><i class="fas fa-brain"></i> Test Modalitas</button>
                                    <button class="btn btn-outline-secondary" onclick="window.navigateTo('test-kecerdasan-ganda', 'Test Kecerdasan Ganda')"><i class="fas fa-lightbulb"></i> Test Kecerdasan</button>
                                    <button class="btn btn-outline-secondary" onclick="window.navigateTo('test-ketertarikan', 'Test Ketertarikan')"><i class="fas fa-heart"></i> Test Ketertarikan</button>
                                </div>
                            </div>
                        </div>
                     </div>
                     `;

                 // Render Sparklines after HTML is in the DOM (Simulation data)
                 // FIREBASE: Fetch actual score history for sparklines
                 const literasiHistory = getScoreHistory(studentNisn, 'literasi');
                 const numerasiHistory = getScoreHistory(studentNisn, 'numerasi');
                 renderSparkline('literasi-sparkline', literasiHistory, 'Skor Literasi');
                 renderSparkline('numerasi-sparkline', numerasiHistory, 'Skor Numerasi');
            };
            const loadTestSection = (section, dataKey, title) => {
                  if (currentUser.role !== 'murid') { mainContent.innerHTML = `<div class="alert alert-warning">Menu ini hanya untuk murid.</div>`; return; }
                  const instructions = testInstructions[dataKey] || `Klik tombol "Mulai Test" untuk mengerjakan soal ${title}. Hasil test akan direkam. Anda juga dapat melihat riwayat pengerjaan sebelumnya.`;
                  mainContent.innerHTML = `
                      <div class="card test-section-card mb-4">
                          <div class="card-body p-4"> <!-- Added padding -->
                              <h2>Test ${title}</h2>
                              <p class="text-muted mb-0">${instructions}</p> <!-- Removed bottom margin -->
                          </div>
                      </div>
                      <div class="card test-actions">
                          <div class="card-body">
                              <button class="btn btn-success btn-lg start-test-btn" onclick="confirmStartTest('${dataKey}', '${title}')">
                                  <i class="fas fa-play-circle"></i> Mulai Test ${title}
                              </button>
                              <button class="btn btn-outline-secondary history-test-btn" onclick="window.navigateToHistory('${section}', '${dataKey}', '${title}')">
                                  <i class="fas fa-history"></i> Lihat Riwayat Test
                              </button>
                          </div>
                      </div>`;
             };
             // Added Instructions Map
             const testInstructions = {
                literasi: "Uji kemampuan Anda dalam memahami dan menggunakan bahasa tertulis.",
                numerasi: "Uji kemampuan Anda dalam memahami dan menggunakan konsep matematika dasar.",
                gayaBelajar: "Identifikasi gaya belajar yang paling efektif untuk Anda (Visual, Auditori, Kinestetik).",
                modalitasBelajar: "Temukan preferensi modalitas Anda dalam menerima dan mengolah informasi.",
                kecerdasanGanda: "Kenali potensi kecerdasan majemuk yang dominan pada diri Anda.",
                ketertarikan: "Jelajahi minat dan ketertarikan Anda terhadap berbagai bidang."
             };
            const loadTestHistory = (originalSection, dataKey, title, hasScore) => {
                  // FIREBASE INTEGRATION POINT: Fetch student's specific test history from Firestore.
                  // Example: const historySnapshot = await fbDb.collection('users').doc(currentUser.uid).collection('testHistory').doc(dataKey).collection('results').orderBy('date', 'desc').get();
                  // const history = historySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                  const studentNisn = currentUser.nisn; // Simulation
                  if (currentUser.role !== 'murid' || !studentNisn) { mainContent.innerHTML = `<div class="alert alert-warning">Riwayat hanya tersedia untuk murid.</div>`; return; }
                  const studentData = testData[studentNisn] || {}; // Simulation
                  const history = studentData[dataKey] || []; // Simulation

                  let historyTableHtml = '<p class="text-muted mt-3 text-center">Belum ada riwayat test untuk kategori ini.</p>';
                  if (history.length > 0) {
                      historyTableHtml = `<div class="table-responsive"><table class="data-table history-table"><thead><tr><th>Tanggal Pengerjaan</th><th>${hasScore ? 'Skor' : 'Hasil Dominan'}</th></tr></thead><tbody>`;
                      const sortedHistory = [...history].sort((a, b) => new Date(b.date) - new Date(a.date));
                      sortedHistory.forEach(item => {
                          const displayValue = hasScore ? (item.score ?? '-') : (item.result ?? '-');
                          const formattedDate = new Date(item.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                          historyTableHtml += `<tr><td>${formattedDate}</td><td>${displayValue}</td></tr>`;
                      });
                      historyTableHtml += '</tbody></table></div>';
                  }

                  mainContent.innerHTML = `
                      <div class="card history-section-card">
                           <div class="card-header">
                              <h2 class="card-header-title mb-0">Riwayat Test ${title}</h2>
                           </div>
                          <div class="card-body">
                              <button class="btn btn-secondary btn-sm mb-3" onclick="window.navigateTo('${originalSection}', 'Test ${title}')">
                                  <i class="fas fa-arrow-left"></i> Kembali ke Halaman Test
                              </button>
                              ${historyTableHtml}
                          </div>
                      </div>`;
            };

            // Test Interface (Murid) - Enhanced UX
            const loadTestInterface = (testKey, testTitle) => {
                // FIREBASE INTEGRATION POINT: Fetch questions for the `testKey` from the Firestore `questionBanks` collection.
                // Example: const questionsSnapshot = await fbDb.collection('questionBanks').doc(testKey).collection('questions').get();
                // const questions = questionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const questions = questionBanks[testKey] || []; // Simulation
                if (questions.length === 0) {
                    mainContent.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Soal untuk test ${testTitle} belum tersedia. Silakan hubungi guru atau admin.
                        </div>
                        <button class="btn btn-secondary mt-3" onclick="window.navigateTo('dashboard-home', 'Dashboard')">
                            <i class="fas fa-arrow-left"></i> Kembali ke Dashboard
                        </button>`;
                    return;
                }
                const shuffledQuestions = [...questions].sort(() => Math.random() - 0.5); // Shuffle questions
                currentTestState = {
                    testKey: testKey,
                    testTitle: testTitle,
                    questions: shuffledQuestions,
                    currentIndex: 0,
                    answers: {} // Initialize empty answers object
                };
                if (pageTitle) pageTitle.textContent = `Mengerjakan Test: ${testTitle}`; // Update page title

                mainContent.innerHTML = `
                    <div class="test-container">
                        <div class="test-header">
                            <h3 class="test-title">${testTitle}</h3>
                            <span class="test-progress badge bg-secondary" id="test-progress-indicator">Soal 1 dari ${shuffledQuestions.length}</span>
                        </div>
                        <form id="test-form">
                            <div class="question-area" id="question-area">
                                <!-- Question will be rendered here -->
                                <div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Memuat soal...</span></div></div>
                            </div>
                        </form>
                        <div class="test-navigation">
                            <button id="prev-question-btn" type="button" class="btn btn-outline-secondary" onclick="navigateTestQuestion(-1)" disabled><i class="fas fa-arrow-left"></i> Sebelumnya</button>
                            <button id="finish-test-btn" type="button" class="btn btn-danger hidden" onclick="confirmFinishTest()"><i class="fas fa-check-circle"></i> Selesai & Kirim Jawaban</button>
                            <button id="next-question-btn" type="button" class="btn btn-primary" onclick="navigateTestQuestion(1)">Berikutnya <i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>`;
                renderTestQuestion(); // Render the first question
            };
             const confirmStartTest = (testKey, testTitle) => {
                 if (confirm(`Anda akan memulai ${testTitle}. Pastikan koneksi stabil. Apakah Anda siap?`)) {
                     startTest(testKey, testTitle); // Call the correctly defined startTest
                 }
             }
             // Make confirmStartTest globally accessible
             window.confirmStartTest = confirmStartTest;

             const confirmFinishTest = () => {
                  if (confirm(`Anda yakin ingin menyelesaikan test ${currentTestState.testTitle} ini? Jawaban tidak dapat diubah.`)) {
                      finishTest();
                  }
             }
             // Make confirmFinishTest globally accessible
             window.confirmFinishTest = confirmFinishTest;

            const renderTestQuestion = () => {
                const questionArea = document.getElementById('question-area');
                const progressIndicator = document.getElementById('test-progress-indicator');
                const prevBtn = document.getElementById('prev-question-btn');
                const nextBtn = document.getElementById('next-question-btn');
                const finishBtn = document.getElementById('finish-test-btn');

                // Ensure elements exist and test state is valid
                if (!questionArea || !progressIndicator || !prevBtn || !nextBtn || !finishBtn || !currentTestState || !currentTestState.questions || currentTestState.questions.length === 0) {
                    console.error("Error rendering question: Missing elements or invalid test state.");
                    mainContent.innerHTML = `<div class="alert alert-danger">Terjadi kesalahan saat menampilkan soal. Silakan coba lagi.</div>`;
                    return;
                }

                const currentQuestion = currentTestState.questions[currentTestState.currentIndex];
                const questionNumber = currentTestState.currentIndex + 1;
                const totalQuestions = currentTestState.questions.length;
                const currentAnswer = currentTestState.answers[currentQuestion.id]; // Get previously selected answer for this question

                progressIndicator.textContent = `Soal ${questionNumber} / ${totalQuestions}`;

                let optionsHtml = '';
                const isThreeOption = threeOptionTestKeys.includes(currentTestState.testKey);
                const numOptions = isThreeOption ? 3 : (currentQuestion.options?.length || 0); // Use actual options length if available

                if (numOptions < (isThreeOption ? 3 : 4)) {
                    console.warn(`Question ${currentQuestion.id} has fewer options than expected for type ${currentTestState.testKey}.`);
                }

                for (let i = 0; i < numOptions; i++) {
                    const optionLetter = String.fromCharCode(65 + i);
                    const optionText = currentQuestion.options[i] || `Opsi ${optionLetter} Tidak Tersedia`; // Fallback for missing option text
                    const isChecked = currentAnswer === optionLetter;
                    // Basic HTML sanitization (replace with a library for production)
                    const sanitizedOptionText = optionText.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    optionsHtml += `
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question_${currentQuestion.id}" id="option_${optionLetter}" value="${optionLetter}" ${isChecked ? 'checked' : ''} onchange="handleAnswerSelection('${currentQuestion.id}', '${optionLetter}')">
                            <label class="form-check-label" for="option_${optionLetter}">${optionLetter}. ${sanitizedOptionText}</label>
                        </div>`;
                }

                // Basic HTML sanitization for question text
                 const sanitizedQuestionText = (currentQuestion.text || "Teks Pertanyaan Tidak Tersedia").replace(/</g, "&lt;").replace(/>/g, "&gt;");

                // Apply fade-in effect (optional, simple version)
                questionArea.style.opacity = '0';
                questionArea.innerHTML = `<div class="question-text">${questionNumber}. ${sanitizedQuestionText}</div><div class="options-area">${optionsHtml}</div>`;
                // Use requestAnimationFrame for smoother transition start
                requestAnimationFrame(() => {
                    questionArea.style.transition = 'opacity 0.3s ease-in-out';
                    questionArea.style.opacity = '1';
                });

                // Update navigation buttons state
                prevBtn.disabled = currentTestState.currentIndex === 0;
                nextBtn.classList.toggle('hidden', questionNumber === totalQuestions);
                finishBtn.classList.toggle('hidden', questionNumber !== totalQuestions);
            };
            window.handleAnswerSelection = (questionId, selectedOption) => {
                if (currentTestState && currentTestState.answers) {
                    currentTestState.answers[questionId] = selectedOption;
                } else {
                    console.error("Cannot save answer: currentTestState is not properly initialized.");
                }
            };
            // Make handleAnswerSelection globally accessible
            window.handleAnswerSelection = handleAnswerSelection;

            window.navigateTestQuestion = (direction) => {
                if (!currentTestState || !currentTestState.questions) return;
                const newIndex = currentTestState.currentIndex + direction;
                if (newIndex >= 0 && newIndex < currentTestState.questions.length) {
                    currentTestState.currentIndex = newIndex;
                    renderTestQuestion();
                }
            };
            // Make navigateTestQuestion globally accessible
            window.navigateTestQuestion = navigateTestQuestion;

            window.finishTest = async () => { // Make async for Firebase
                 const finishButton = document.getElementById('finish-test-btn');
                 if (finishButton) toggleButtonLoading(finishButton.id, true); // Show loading on finish button

                 const testKey = currentTestState.testKey;
                 const testTitle = currentTestState.testTitle;
                 const studentUid = currentUser.uid; // FIREBASE: Use UID
                 const totalQuestions = currentTestState.questions.length;

                 // Calculate score or determine result
                 let correctAnswers = 0; let resultText = null; let score = 0;
                 const isScoredTest = !threeOptionTestKeys.includes(testKey) && dataKeyRequiresScore(testKey);
                 if (isScoredTest) {
                     currentTestState.questions.forEach(q => { if (q.answer && currentTestState.answers[q.id] === q.answer) { correctAnswers++; } });
                     score = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
                 } else {
                     const answers = Object.values(currentTestState.answers);
                     const mostFrequentAnswer = answers.reduce((acc, val) => { acc[val] = (acc[val] || 0) + 1; return acc; }, {});
                     let dominantResult = Object.keys(mostFrequentAnswer).reduce((a, b) => mostFrequentAnswer[a] > mostFrequentAnswer[b] ? a : b, null);
                     if (testKey === 'gayaBelajar') resultText = dominantResult === 'A' ? 'Visual' : dominantResult === 'B' ? 'Auditori' : 'Kinestetik';
                     else if (testKey === 'kecerdasanGanda') resultText = dominantResult === 'A' ? 'Logis-Matematis' : dominantResult === 'B' ? 'Linguistik' : 'Naturalis';
                     else resultText = dominantResult ? `Hasil Dominan Opsi ${dominantResult}` : "Hasil Belum Terdefinisi";
                 }

                 // Prepare result data for Firestore
                 const newResultData = {
                     date: firebase.firestore.FieldValue.serverTimestamp(), // Use server timestamp
                     answers: currentTestState.answers // Store the actual answers submitted
                 };
                 if (isScoredTest) newResultData.score = score; else newResultData.result = resultText;

                 try {
                     // FIREBASE: Save result to Firestore
                     const resultRef = fbDb.collection('users').doc(studentUid).collection('testHistory').doc(testKey).collection('results');
                     // This add() operation WILL AUTOMATICALLY CREATE the 'users' collection (if needed),
                     // the 'testHistory' subcollection (if needed), the document for 'testKey' (if needed),
                     // and the 'results' subcollection (if needed) before adding the new result document.
                     await resultRef.add(newResultData);
                     console.log(`Test result saved for user ${studentUid}, test ${testKey}`);

                     // FIREBASE: Optionally update highest score in user's main document
                     if (isScoredTest) {
                         const userDocRef = fbDb.collection('users').doc(studentUid);
                         const userDoc = await userDocRef.get();
                         if (userDoc.exists) {
                             const currentHighest = userDoc.data().highestScores?.[testKey] || 0;
                             if (score > currentHighest) {
                                 await userDocRef.update({
                                     [`highestScores.${testKey}`]: score // Use dot notation to update nested field
                                 });
                                 console.log(`Highest score updated for ${testKey}`);
                             }
                         }
                     }

                     // --- Update Simulation Data (Remove in full Firebase implementation) ---
                     const studentNisn = currentUser.nisn;
                     if (!testData[studentNisn]) testData[studentNisn] = { highestScores: {} };
                     if (!testData[studentNisn][testKey]) testData[studentNisn][testKey] = [];
                     testData[studentNisn][testKey].push({ ...newResultData, date: new Date().toISOString().split('T')[0] }); // Simulate date
                     if (isScoredTest) {
                         const currentHighestSim = testData[studentNisn].highestScores[testKey] || 0;
                         if (score > currentHighestSim) testData[studentNisn].highestScores[testKey] = score;
                     }
                     // --- End Simulation Update ---

                     showTestResult(testKey, testTitle, score, correctAnswers, totalQuestions, isScoredTest, resultText);

                 } catch (error) {
                     console.error("Error saving test result:", error);
                     showNotification(`Gagal menyimpan hasil test: ${error.message}`, "danger", 5000);
                     if (finishButton) toggleButtonLoading(finishButton.id, false); // Re-enable button on error
                 }
             };
            // Make finishTest globally accessible
            window.finishTest = finishTest;

            const showTestResult = (testKey, testTitle, score, correctAnswers, totalQuestions, isScoredTest, resultText = null) => {
                   let resultDisplay = '';
                   const resultIconClass = isScoredTest ? (score >= 70 ? 'success fas fa-check-circle' : 'info fas fa-info-circle') : 'info fas fa-award'; // Award icon for non-scored
                   const iconHtml = `<i class="result-icon ${resultIconClass}"></i>`;

                   if (isScoredTest) {
                        resultDisplay = `
                           ${iconHtml}
                           <h2>Test ${testTitle} Selesai!</h2>
                           <p>Berikut adalah hasil pengerjaan Anda:</p>
                           <div class="score-display">${score}</div>
                           <p class="score-detail">${correctAnswers} dari ${totalQuestions} Jawaban Benar</p>
                           <p class="result-note">Hasil ini telah disimpan dalam riwayat Anda.</p>
                       `;
                    } else {
                        resultDisplay = `
                            ${iconHtml}
                           <h2>Test ${testTitle} Selesai!</h2>
                           <p>Preferensi atau kecenderungan dominan Anda (simulasi):</p>
                           <p class="result-text">${resultText || 'Hasil Tidak Terdefinisi'}</p>
                           <p class="result-note">Hasil ini bersifat indikatif dan telah disimpan dalam riwayat Anda. Konsultasikan dengan guru untuk interpretasi lebih lanjut.</p>
                       `;
                   }
                   mainContent.innerHTML = `<div class="test-result-container card"><div class="card-body p-4">${resultDisplay}<button class="btn btn-primary" onclick="window.navigateTo('dashboard-home', 'Dashboard')"><i class="fas fa-arrow-left"></i> Kembali ke Dashboard</button></div></div>`;
                   currentTestState = {}; // Clear test state
             };


            // Settings Page
            const loadSettings = () => {
                // FIREBASE INTEGRATION POINT: Fetch current user's profile data from Firestore using currentUser.uid.
                // Example: const userDoc = await fbDb.collection('users').doc(currentUser.uid).get(); currentUser = { uid: currentUser.uid, ...userDoc.data() };
                // The profilePic URL might come from Firebase Storage.
                const storedUser = sessionStorage.getItem('loggedInUser'); // Simulation
                if (!storedUser) { handleLogout(); return; }
                currentUser = JSON.parse(storedUser); // Simulation
                const profilePicSrc = currentUser.profilePic || 'assets/default-profile.png';

                mainContent.innerHTML = `
                    <div class="row">
                      <div class="col-lg-10 offset-lg-1"> <!-- Center content on large screens -->
                       <form id="settings-form" class="settings-form">
                        <div class="card settings-card">
                           <div class="card-header"><h2 class="card-header-title mb-0">Pengaturan Profil & Akun</h2></div>
                            <div class="card-body">
                                  <div id="settings-message" class="mb-3"></div> <!-- Message inside card body -->
                                <div class="row">
                                    <div class="col-md-4 text-center">
                                        <img src="${profilePicSrc}" alt="Foto Profil" id="profile-pic-preview" class="profile-pic-preview" onerror="this.src='assets/default-profile.png';">
                                        <label for="profilePic" class="btn btn-secondary btn-sm upload-btn">
                                            <i class="fas fa-camera"></i> Ganti Foto
                                        </label>
                                          <input type="file" id="profilePic" name="profilePic" accept="image/png, image/jpeg, image/gif" style="position: absolute; left: -9999px;"> <!-- Visually hidden but functional -->
                                        <p class="form-text mt-1">Max. 1MB (PNG, JPG, GIF)</p>
                                    </div>
                                    <div class="col-md-8">
                                        <h4><i class="fas fa-user-edit"></i> Informasi Dasar</h4>
                                        <div class="form-group mb-3"><label for="name" class="form-label">Nama:</label><input type="text" id="name" name="name" class="form-control" value="${currentUser.name || ''}" required></div>
                                        ${currentUser.role === 'murid' ? `
                                        <div class="form-group mb-3"><label for="nisn" class="form-label">NISN:</label><input type="text" id="nisn" name="nisn" class="form-control" value="${currentUser.nisn || ''}" disabled></div>
                                        <div class="form-group mb-3"><label for="parentName" class="form-label">Nama Ortu/Wali:</label><input type="text" id="parentName" name="parentName" class="form-control" value="${currentUser.parentName || ''}"></div>
                                        <div class="form-group mb-3"><label for="address" class="form-label">Alamat:</label><textarea id="address" name="address" class="form-control" rows="3">${currentUser.address || ''}</textarea></div>
                                        ` : ''}
                                        ${currentUser.role !== 'murid' ? `<div class="form-group mb-3"><label for="username" class="form-label">Username:</label><input type="text" id="username" name="username" class="form-control" value="${currentUser.username || ''}" disabled></div>` : ''}
                                    </div>
                                </div>
                                <hr>
                                <h4><i class="fas fa-key"></i> Ubah Password</h4>
                                <div class="row">
                                    <div class="col-md-4"><div class="form-group mb-3"><label for="currentPassword" class="form-label">Password Lama:</label><input type="password" id="currentPassword" name="currentPassword" class="form-control" placeholder="Masukkan password saat ini"></div></div>
                                    <div class="col-md-4"><div class="form-group mb-3"><label for="newPassword" class="form-label">Password Baru:</label><input type="password" id="newPassword" name="newPassword" class="form-control" placeholder="Min. 6 karakter" minlength="6"></div></div>
                                    <div class="col-md-4"><div class="form-group mb-3"><label for="confirmPassword" class="form-label">Konfirmasi Baru:</label><input type="password" id="confirmPassword" name="confirmPassword" class="form-control" placeholder="Ulangi password baru"></div></div>
                                </div>
                                <p class="form-text">Kosongkan bagian ini jika tidak ingin mengubah password.</p>
                               </div>
                           <div class="card-footer text-end">
                                <button type="submit" id="settings-save-btn" class="btn btn-primary"><i class="fas fa-save"></i> Simpan Perubahan</button>
                           </div>
                         </div>
                        </form>
                      </div>
                     </div>`;

                const settingsForm = document.getElementById('settings-form');
                if (settingsForm) { settingsForm.removeEventListener('submit', handleSettingsSave); settingsForm.addEventListener('submit', handleSettingsSave); }
                const profilePicInput = document.getElementById('profilePic');
                const profilePicPreview = document.getElementById('profile-pic-preview');
                if (profilePicInput && profilePicPreview) { profilePicInput.removeEventListener('change', handleProfilePicChange); profilePicInput.addEventListener('change', handleProfilePicChange); }
            };
            const handleProfilePicChange = (event) => {
                 // FIREBASE INTEGRATION POINT: This function previews the image. The actual upload to Firebase Storage
                 // should happen within `handleSettingsSave` if a new file is selected.
                 const profilePicPreview = document.getElementById('profile-pic-preview');
                 const file = event.target.files[0];
                 if (!file || !profilePicPreview) return;
                 if (!['image/png', 'image/jpeg', 'image/gif'].includes(file.type)) { displaySettingsMessage('Format gambar tidak valid (PNG, JPG, GIF).', 'warning'); event.target.value = null; return; }
                 if (file.size > 1 * 1024 * 1024) { displaySettingsMessage('Ukuran gambar maksimal 1MB.', 'warning'); event.target.value = null; return; }
                 const reader = new FileReader();
                 reader.onload = (e) => { profilePicPreview.src = e.target.result; };
                 reader.onerror = () => { displaySettingsMessage('Gagal membaca file gambar.', 'danger'); profilePicPreview.src = currentUser.profilePic || 'assets/default-profile.png'; };
                 reader.readAsDataURL(file);
            };
            const handleSettingsSave = async (event) => { // Make async for Firebase calls
                 event.preventDefault();
                 const saveButton = document.getElementById('settings-save-btn');
                 toggleButtonLoading(saveButton.id, true);
                 clearSettingsMessage(); // Clear previous messages

                 // Get form data
                 const nameInput = document.getElementById('name'); const parentNameInput = document.getElementById('parentName'); const addressInput = document.getElementById('address'); const currentPasswordInput = document.getElementById('currentPassword'); const newPasswordInput = document.getElementById('newPassword'); const confirmPasswordInput = document.getElementById('confirmPassword'); const profilePicInput = document.getElementById('profilePic'); const profilePicPreview = document.getElementById('profile-pic-preview');

                 let isValid = true; let messages = []; let focusField = null;

                 const newName = nameInput.value.trim(); const newParentName = parentNameInput ? parentNameInput.value.trim() : currentUser.parentName; const newAddress = addressInput ? addressInput.value.trim() : currentUser.address; const currentPassword = currentPasswordInput.value; const newPassword = newPasswordInput.value; const confirmPassword = confirmPasswordInput.value;
                 const profilePicFile = profilePicInput.files[0]; // Get the selected file

                 if (!newName) { isValid = false; messages.push('Nama tidak boleh kosong.'); focusField = focusField || nameInput; }

                 let passwordUpdateAttempted = newPassword || confirmPassword || currentPassword;
                 let passwordChanged = false;

                 // --- Validation ---
                 if (passwordUpdateAttempted) {
                     if (!currentPassword) { isValid = false; messages.push('Masukkan password lama untuk mengubah password.'); focusField = focusField || currentPasswordInput;}
                     // FIREBASE: Actual password check requires re-authentication, skip direct comparison here.
                     // else if (currentPassword !== currentUser.password) { isValid = false; messages.push('Password lama yang Anda masukkan salah.'); focusField = focusField || currentPasswordInput; }
                     else if (!newPassword || newPassword.length < 6) { isValid = false; messages.push('Password baru minimal harus 6 karakter.'); focusField = focusField || newPasswordInput; }
                     else if (newPassword !== confirmPassword) { isValid = false; messages.push('Konfirmasi password baru tidak cocok.'); focusField = focusField || confirmPasswordInput; }
                     else { passwordChanged = true; } // Assume valid if fields are filled correctly for now
                 }

                 if (!isValid) {
                     displaySettingsMessage(messages.join('<br>'), 'danger'); if (focusField) focusField.focus(); toggleButtonLoading(saveButton.id, false); return;
                 }

                 // --- Firebase Operations ---
                 try {
                     let newProfilePicUrl = currentUser.profilePic; // Start with existing URL

                     // 1. Re-authenticate if password change is attempted
                     if (passwordChanged) {
                         const user = fbAuth.currentUser;
                         if (!user) throw new Error("User not logged in for password change.");
                         // IMPORTANT: Use email associated with the account for credential
                         // You might need to fetch the email from Firestore or have it in currentUser
                         const userEmail = user.email; // Assuming email is available
                         if (!userEmail) throw new Error("User email not available for re-authentication.");

                         const credential = firebase.auth.EmailAuthProvider.credential(userEmail, currentPassword);
                         await user.reauthenticateWithCredential(credential);
                         // If re-authentication is successful, update the password
                         await user.updatePassword(newPassword);
                         console.log("Firebase password updated successfully.");
                         // Update local simulation password (remove in full Firebase implementation)
                         currentUser.password = newPassword;
                     }

                     // 2. Upload new profile picture if selected
                     if (profilePicFile) {
                         const storageRef = fbStorage.ref();
                         // Use UID for unique path, include original filename for reference
                         const filePath = `profilePictures/${currentUser.uid}/${Date.now()}_${profilePicFile.name}`;
                         const fileRef = storageRef.child(filePath);
                         const uploadTask = await fileRef.put(profilePicFile);
                         newProfilePicUrl = await uploadTask.ref.getDownloadURL();
                         console.log("Profile picture uploaded:", newProfilePicUrl);
                     }

                     // 3. Update Firestore document
                     const userDocRef = fbDb.collection('users').doc(currentUser.uid);
                     const dataToUpdate = {
                         name: newName,
                         profilePic: newProfilePicUrl, // Use the potentially new URL
                         // Add other fields specific to role
                     };
                     if (currentUser.role === 'murid') {
                         dataToUpdate.parentName = newParentName;
                         dataToUpdate.address = newAddress;
                     }
                     // This update() operation assumes the 'users' collection and the document already exist.
                     await userDocRef.update(dataToUpdate);
                     console.log("Firestore user data updated.");

                     // 4. Update local currentUser object and UI
                     currentUser.name = newName;
                     currentUser.profilePic = newProfilePicUrl;
                     if (currentUser.role === 'murid') { currentUser.parentName = newParentName; currentUser.address = newAddress; }
                     sessionStorage.setItem('loggedInUser', JSON.stringify(currentUser)); // Update simulation session
                     if(userNameDisplay) userNameDisplay.textContent = currentUser.name;
                     if(userAvatar) userAvatar.src = currentUser.profilePic || 'assets/default-profile.png';

                     // Reset form fields
                     currentPasswordInput.value = ''; newPasswordInput.value = ''; confirmPasswordInput.value = ''; profilePicInput.value = null;

                     // Show success
                     let successMessage = 'Pengaturan berhasil disimpan!';
                     if (passwordChanged && profilePicFile) successMessage = 'Pengaturan, password, dan foto profil berhasil disimpan!';
                     else if (passwordChanged) successMessage = 'Pengaturan dan password berhasil disimpan!';
                     else if (profilePicFile) successMessage = 'Pengaturan dan foto profil berhasil disimpan!';
                     displaySettingsMessage(successMessage, 'success');
                     showNotification(successMessage, 'success');

                 } catch (error) {
                     console.error("Error saving settings:", error);
                     let errorMessage = "Gagal menyimpan pengaturan.";
                     if (error.code === 'auth/wrong-password') {
                         errorMessage = "Password lama yang Anda masukkan salah.";
                         currentPasswordInput.focus();
                     } else if (error.code === 'auth/requires-recent-login') {
                         errorMessage = "Sesi Anda sudah terlalu lama. Silakan logout dan login kembali untuk mengubah password.";
                     } else if (error.code === 'storage/unauthorized') {
                         errorMessage = "Gagal upload foto: Tidak ada izin. Periksa Storage Rules.";
                     } else if (error.message) {
                         errorMessage = `Gagal menyimpan: ${error.message}`;
                     }
                     displaySettingsMessage(errorMessage, 'danger');
                     showNotification(errorMessage, 'danger', 5000);
                 } finally {
                     toggleButtonLoading(saveButton.id, false);
                 }
             };
            const displaySettingsMessage = (message, type = 'success') => {
                  const settingsMessage = document.getElementById('settings-message');
                  if (settingsMessage) {
                       // Use textContent for simple messages, innerHTML if message contains HTML like <br>
                       const alertContent = message.includes('<br>') ? message : message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                       settingsMessage.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert"> ${alertContent} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button> </div>`;
                       // Add dismiss functionality to the new alert's close button
                       const newCloseButton = settingsMessage.querySelector('.btn-close');
                       if (newCloseButton) {
                           newCloseButton.addEventListener('click', () => {
                               const alertDiv = newCloseButton.closest('.alert');
                               if (alertDiv) {
                                   alertDiv.classList.remove('show');
                                   alertDiv.addEventListener('transitionend', () => alertDiv.remove(), { once: true });
                               }
                           });
                       }
                   }
             };
            const clearSettingsMessage = () => {
                 const settingsMessage = document.getElementById('settings-message');
                 if(settingsMessage) settingsMessage.innerHTML = '';
            }


            // Teacher & Admin Dashboard - With Charts and Psychometry Summary
            const loadTeacherDashboardHome = async () => { // Make async for Firebase calls
                showLoading(); // Show loading indicator

                try {
                    // FIREBASE INTEGRATION POINT: Fetch aggregated data from Firestore.
                    // This might involve fetching all student test results, which can be inefficient for large datasets.
                    // Consider using Firebase Functions to pre-aggregate this data periodically or on-demand.
                    // Fetch counts (students, gurus, questions, tests) from Firestore (e.g., using `getCountFromServer` or maintaining counters).

                    // --- Simulation Data Fetch (Replace with Firebase) ---
                    const aggregateTestData = (testKey, resultKey = 'result') => {
                        const resultsCount = {}; const labels = []; const data = [];
                        users.murid.forEach(murid => {
                            const studentNisn = murid.nisn;
                            const studentTestData = testData[studentNisn];
                            if (studentTestData && studentTestData[testKey] && studentTestData[testKey].length > 0) {
                                const latestResult = [...studentTestData[testKey]].sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                                const resultValue = latestResult[resultKey];
                                if (resultValue) {
                                    const individualResults = String(resultValue).split(',').map(r => r.trim()).filter(r => r);
                                    individualResults.forEach(res => resultsCount[res] = (resultsCount[res] || 0) + 1);
                                }
                            }
                        });
                        const sortedKeys = Object.keys(resultsCount).sort();
                        sortedKeys.forEach(key => { labels.push(key); data.push(resultsCount[key]); });
                        return { labels, data };
                    };
                    const gayaBelajarData = aggregateTestData('gayaBelajar');
                    const modalitasBelajarData = aggregateTestData('modalitasBelajar');
                    const kecerdasanGandaData = aggregateTestData('kecerdasanGanda');
                    const mostFrequentGaya = getMostFrequentLatestResult('gayaBelajar');
                    const mostFrequentModalitas = getMostFrequentLatestResult('modalitasBelajar');
                    const mostFrequentKecerdasan = getMostFrequentLatestResult('kecerdasanGanda');
                    const mostFrequentKetertarikan = getMostFrequentLatestResult('ketertarikan');
                    const totalStudents = users.murid.length;
                    const totalQuestions = Object.values(questionBanks).reduce((sum, bank) => sum + bank.length, 0);
                    const totalGurus = users.guru.filter(g => g.status === 'aktif').length;
                    const totalTestRecords = Object.values(testData).reduce((total, studentData) => {
                         return total + Object.values(studentData).filter(Array.isArray).reduce((sum, testArr) => sum + testArr.length, 0);
                     }, 0);
                    // --- End Simulation Data Fetch ---

                    // --- Firebase Data Fetch Example (Illustrative - Needs refinement) ---
                    /*
                    // Fetch counts (Example using getCountFromServer - requires v9+ SDK or specific setup)
                    // const studentsCountSnapshot = await fbDb.collection('users').where('role', '==', 'murid').count().get();
                    // const totalStudents = studentsCountSnapshot.data().count;
                    // Similar fetches for gurus, questions, test records (might need aggregation)

                    // Fetch latest psychometry results (More complex - might need Functions or careful querying)
                    // This is a simplified example, real implementation depends heavily on data structure
                    const studentsSnapshot = await fbDb.collection('users').where('role', '==', 'murid').get();
                    let latestResultsAgg = { gayaBelajar: {}, modalitasBelajar: {}, kecerdasanGanda: {}, ketertarikan: {} };
                    for (const doc of studentsSnapshot.docs) {
                        const uid = doc.id;
                        // Fetch latest result for each psychometry test for this student
                        // Example for gayaBelajar:
                        const gayaSnapshot = await fbDb.collection('users').doc(uid).collection('testHistory').doc('gayaBelajar').collection('results').orderBy('date', 'desc').limit(1).get();
                        if (!gayaSnapshot.empty) {
                            const result = gayaSnapshot.docs[0].data().result;
                            if (result) {
                                const individualResults = String(result).split(',').map(r => r.trim()).filter(r => r);
                                individualResults.forEach(res => latestResultsAgg.gayaBelajar[res] = (latestResultsAgg.gayaBelajar[res] || 0) + 1);
                            }
                        }
                        // Repeat for modalitas, kecerdasan, ketertarikan...
                    }

                    // Process aggregated results to find most frequent and data for charts
                    const processAggregatedData = (aggData) => {
                        const labels = Object.keys(aggData).sort();
                        const data = labels.map(label => aggData[label]);
                        let maxFreq = 0; let mostFrequent = [];
                        labels.forEach(label => {
                            if (aggData[label] > maxFreq) { maxFreq = aggData[label]; mostFrequent = [label]; }
                            else if (aggData[label] === maxFreq) { mostFrequent.push(label); }
                        });
                        return { labels, data, mostFrequent: mostFrequent.sort().join(' / ') || 'N/A' };
                    };

                    const gayaProcessed = processAggregatedData(latestResultsAgg.gayaBelajar);
                    // const modalitasProcessed = processAggregatedData(latestResultsAgg.modalitasBelajar);
                    // const kecerdasanProcessed = processAggregatedData(latestResultsAgg.kecerdasanGanda);
                    // const ketertarikanProcessed = processAggregatedData(latestResultsAgg.ketertarikan);

                    // Use processed data below...
                    */
                    // --- End Firebase Data Fetch Example ---


                    mainContent.innerHTML = `
                        <div class="row mb-4">
                            <div class="col-lg-3 col-md-6 col-6 mb-3 mb-lg-0"> <div class="summary-box"> <span class="count">${totalStudents}</span> <span class="label">Total Murid</span> </div> </div>
                            <div class="col-lg-3 col-md-6 col-6 mb-3 mb-lg-0"> <div class="summary-box"> <span class="count">${totalGurus}</span> <span class="label">Guru Aktif</span> </div> </div>
                            <div class="col-lg-3 col-md-6 col-6 mb-3 mb-lg-0"> <div class="summary-box"> <span class="count">${totalQuestions}</span> <span class="label">Jumlah Soal</span> </div> </div>
                            <div class="col-lg-3 col-md-6 col-6 mb-3 mb-lg-0"> <div class="summary-box"> <span class="count">${totalTestRecords}</span> <span class="label">Record Test</span> </div> </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header"><h3 class="card-header-title mb-0">Ringkasan Psikometri Kelas (Hasil Terbaru Terbanyak)</h3></div>
                            <div class="card-body">
                                <ul class="psychometry-summary-admin">
                                    <li><span>Gaya Belajar Dominan</span><strong>${mostFrequentGaya}</strong></li>
                                    <li><span>Modalitas Belajar Dominan</span><strong>${mostFrequentModalitas}</strong></li>
                                    <li><span>Kecerdasan Ganda Dominan</span><strong>${mostFrequentKecerdasan}</strong></li>
                                    <li><span>Ketertarikan Dominan</span><strong>${mostFrequentKetertarikan}</strong></li>
                                </ul>
                            </div>
                        </div>

                        <h3 class="mb-3">Distribusi Hasil Psikometri Kelas (Simulasi)</h3>
                        <div class="row">
                            <div class="col-md-4 mb-4"> <div class="card h-100"> <div class="card-body text-center d-flex flex-column"> <h4 class="mb-3">Gaya Belajar</h4> <div class="chart-container flex-grow-1 d-flex align-items-center justify-content-center" id="gayaBelajarChartContainer"> <canvas id="gayaBelajarChart"></canvas> </div> </div> </div> </div>
                            <div class="col-md-4 mb-4"> <div class="card h-100"> <div class="card-body text-center d-flex flex-column"> <h4 class="mb-3">Modalitas Belajar</h4> <div class="chart-container flex-grow-1 d-flex align-items-center justify-content-center" id="modalitasChartContainer"> <canvas id="modalitasChart"></canvas> </div> </div> </div> </div>
                            <div class="col-md-4 mb-4"> <div class="card h-100"> <div class="card-body text-center d-flex flex-column"> <h4 class="mb-3">Kecerdasan Ganda</h4> <div class="chart-container flex-grow-1 d-flex align-items-center justify-content-center" id="kecerdasanChartContainer"> <canvas id="kecerdasanChart"></canvas> </div> </div> </div> </div>
                        </div>
                    `;

                    // Function to create chart or placeholder (remains the same)
                     const createOrShowPlaceholder = (containerId, canvasId, chartLabel, labels, data) => {
                         const container = document.getElementById(containerId);
                         if (!container) { console.error(`Chart container not found: ${containerId}`); return; }
                         if (typeof Chart === 'undefined') { console.error("Chart.js library is not loaded."); container.innerHTML = `<div class="chart-placeholder text-danger">Error: Chart library tidak termuat.</div>`; return; }
                         if (labels && labels.length > 0) {
                              const canvas = container.querySelector('canvas');
                              if (!canvas) { console.error(`Canvas element not found in container: ${containerId}`); container.innerHTML = `<div class="chart-placeholder text-danger">Error: Elemen chart tidak ditemukan.</div>`; return; }
                              const ctx = canvas.getContext('2d');
                              if (!ctx) { console.error(`Could not get 2D context for canvas: ${canvasId}`); container.innerHTML = `<div class="chart-placeholder text-danger">Error: Gagal membuat konteks chart.</div>`; return; }
                              if (activeCharts[canvasId]) { activeCharts[canvasId].destroy(); }
                              try {
                                   const chartColors = ['#0d6efd', '#ffc107', '#198754', '#dc3545', '#0dcaf0', '#6f42c1', '#fd7e14', '#20c997', '#6c757d', '#d63384'];
                                   activeCharts[canvasId] = new Chart(ctx, {
                                       type: 'doughnut',
                                       data: { labels: labels, datasets: [{ label: chartLabel, data: data, backgroundColor: chartColors.slice(0, data.length), borderColor: '#ffffff', borderWidth: 2, hoverOffset: 6 }] },
                                       options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 15, font: { size: 11 } } }, tooltip: { boxPadding: 5 } } }
                                   });
                              } catch (chartError) { console.error(`Error creating chart (${canvasId}):`, chartError); container.innerHTML = `<div class="chart-placeholder text-danger">Error saat membuat chart: ${chartError.message}</div>`; }
                         } else { container.innerHTML = `<div class="chart-placeholder">Data belum tersedia</div>`; }
                     };

                     // Create charts after rendering HTML (Simulation data)
                     createOrShowPlaceholder('gayaBelajarChartContainer', 'gayaBelajarChart', 'Gaya Belajar', gayaBelajarData.labels, gayaBelajarData.data);
                     createOrShowPlaceholder('modalitasChartContainer', 'modalitasChart', 'Modalitas Belajar', modalitasBelajarData.labels, modalitasBelajarData.data);
                     createOrShowPlaceholder('kecerdasanChartContainer', 'kecerdasanChart', 'Kecerdasan Ganda', kecerdasanGandaData.labels, kecerdasanGandaData.data);

                } catch (error) {
                    console.error("Error loading teacher dashboard:", error);
                    mainContent.innerHTML = `<div class="alert alert-danger">Gagal memuat data dashboard: ${error.message}</div>`;
                }
             };
            const loadAdminDashboardHome = () => { loadTeacherDashboardHome(); }; // Use the same enhanced dashboard


            // Kelola Soal (Guru & Admin) - Enhanced
            const loadKelolaSoal = async () => { // Make async for Firebase calls
                 if (currentUser.role !== 'guru' && currentUser.role !== 'admin') { mainContent.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Akses ditolak. Fitur ini hanya untuk Guru dan Admin.</div>`; return; }

                 showLoading(); // Show loading indicator

                 try {
                     // FIREBASE INTEGRATION POINT: Fetch available bank keys.
                     // Example: Fetch from a metadata doc or list collections/docs in `questionBanks`.
                     // const bankMetadataDoc = await fbDb.collection('metadata').doc('questionBanks').get();
                     // const availableBanks = bankMetadataDoc.exists ? bankMetadataDoc.data().keys || [] : Object.keys(questionBanks); // Fallback to simulation
                     const availableBanks = Object.keys(questionBanks); // Simulation

                     let tabsHtml = '';
                     availableBanks.forEach(bankKey => {
                         const bankTitle = bankKey.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()); // Format title
                         tabsHtml += `<li class="nav-item"> <a class="nav-link ${bankKey === currentActiveQuestionBank ? 'active' : ''}" href="#" data-bank="${bankKey}">${bankTitle}</a> </li>`;
                     });

                     mainContent.innerHTML = `
                         <div class="card">
                             <div class="card-header">
                                 <h3 class="card-header-title mb-0">Manajemen Bank Soal</h3>
                                 <div class="card-header-actions">
                                      <button id="excel-question-upload-btn" class="btn btn-success btn-sm" onclick="document.getElementById('excel-question-upload-input').click()" title="Upload soal dari file Excel"> <i class="fas fa-file-excel"></i> Upload Excel </button>
                                      <input type="file" id="excel-question-upload-input" class="hidden" accept=".xlsx, .xls" onchange="handleExcelQuestionUpload(event)">
                                      <button class="btn btn-primary btn-sm" onclick="openQuestionModal()" title="Tambah soal baru secara manual"> <i class="fas fa-plus"></i> Tambah Manual </button>
                                 </div>
                             </div>
                             <div class="card-body">
                                 <div id="question-upload-status-message" class="mb-3"></div> <!-- Status message area -->
                                 <ul class="nav nav-tabs mb-3" id="question-bank-tabs"> ${tabsHtml} </ul>
                                 <div class="tab-content" id="question-bank-content"> <!-- Table container -->
                                      <div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Memuat data soal...</span></div></div>
                                 </div>
                             </div>
                         </div>
                     `;
                     document.querySelectorAll('#question-bank-tabs .nav-link').forEach(tab => { tab.addEventListener('click', (e) => { e.preventDefault(); switchQuestionBankTab(e.target.getAttribute('data-bank')); }); });
                     await renderQuestionTable(currentActiveQuestionBank); // Render initial table (await Firebase fetch)

                 } catch (error) {
                     console.error("Error loading Kelola Soal:", error);
                     mainContent.innerHTML = `<div class="alert alert-danger">Gagal memuat data bank soal: ${error.message}</div>`;
                 }
             };
             window.switchQuestionBankTab = async (bankKey) => { // Make async
                 currentActiveQuestionBank = bankKey;
                 document.querySelectorAll('#question-bank-tabs .nav-link').forEach(tab => { tab.classList.toggle('active', tab.getAttribute('data-bank') === bankKey); });
                 const statusDiv = document.getElementById('question-upload-status-message'); if (statusDiv) statusDiv.innerHTML = ''; // Clear status message
                 const contentDiv = document.getElementById('question-bank-content'); if(contentDiv) contentDiv.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Memuat data soal...</span></div></div>`; // Show loading for table

                 await renderQuestionTable(bankKey); // Await rendering which includes fetch
             };
             // Make switchQuestionBankTab globally accessible
             window.switchQuestionBankTab = switchQuestionBankTab;

             const renderQuestionTable = async (bankKey) => { // Make async
                  const container = document.getElementById('question-bank-content'); if (!container) return;

                  let questions = [];
                  try {
                      // FIREBASE INTEGRATION POINT: Fetch questions for the `bankKey` from Firestore.
                      // Example: const questionsSnapshot = await fbDb.collection('questionBanks').doc(bankKey).collection('questions').get();
                      // questions = questionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                      questions = questionBanks[bankKey] || []; // Simulation fallback
                  } catch (error) {
                      console.error(`Error fetching questions for ${bankKey}:`, error);
                      container.innerHTML = `<div class="alert alert-danger">Gagal memuat soal untuk ${bankKey}: ${error.message}</div>`;
                      return;
                  }

                  const is3Opt = threeOptionTestKeys.includes(bankKey);
                  const answerHeader = is3Opt ? 'Preferensi*' : 'Jawaban Benar'; // Note for preference based tests
                  let tableHtml = `
                      <div class="table-responsive">
                          <table class="data-table" id="${bankKey}-questions-table">
                              <thead> <tr> <th>ID</th> <th class="question-text-cell">Teks Pertanyaan</th> <th>Opsi</th> <th>${answerHeader}</th> <th class="actions-cell">Aksi</th> </tr> </thead>
                              <tbody>`;

                   if (questions.length > 0) {
                       questions.forEach(q => {
                            // FIREBASE INTEGRATION POINT: Use the Firestore document ID as `q.id`.
                            const questionId = q.id; // Use Firestore doc ID
                            const answerDisplay = q.answer !== null ? q.answer : (is3Opt ? '<em class="text-muted">N/A</em>' : '-');
                           let optionsPreview = (q.options || []).slice(0, is3Opt ? 3 : 4).map((opt, i) => `<strong>${String.fromCharCode(65 + i)}:</strong> ${(opt || '').substring(0, 20)}${(opt || '').length > 20 ? '...' : ''}`).join('<br>');
                           const questionTextPreview = (q.text || '').substring(0, 80) + ((q.text || '').length > 80 ? '...' : '');

                            tableHtml += `<tr>
                                             <td>${questionId || '-'}</td>
                                             <td class="question-text-cell" title="${q.text || ''}">${questionTextPreview}</td>
                                              <td><small>${optionsPreview || '-'}</small></td>
                                              <td>${answerDisplay}</td>
                                             <td class="actions-cell">
                                                 <button class="btn btn-info btn-sm btn-action" title="Edit Soal" onclick="openQuestionModal('${bankKey}', '${questionId}')"><i class="fas fa-edit fa-fw"></i></button>
                                                 <button class="btn btn-danger btn-sm btn-action" title="Hapus Soal" onclick="handleDeleteQuestion('${bankKey}', '${questionId}')"><i class="fas fa-trash fa-fw"></i></button>
                                             </td>
                                         </tr>`;
                        });
                    } else {
                        tableHtml += `<tr><td colspan="5" class="text-center text-muted p-4">Belum ada soal di bank soal ${bankKey}.</td></tr>`;
                    }
                    tableHtml += `</tbody></table></div>`;
                   if (is3Opt) tableHtml += `<p class="form-text mt-2">*Tes preferensi tidak memiliki jawaban benar/salah.</p>`

                  container.innerHTML = tableHtml;
              };

            // Excel Question Upload Handler (Enhanced Feedback)
             window.handleExcelQuestionUpload = (event) => {
                const file = event.target.files[0];
                const statusDiv = document.getElementById('question-upload-status-message');
                const uploadButton = document.getElementById('excel-question-upload-btn');
                statusDiv.innerHTML = ''; statusDiv.className = 'mb-3';
                if (!file) return;

                const validExtensions = ['.xlsx', '.xls']; const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase(); if (!validExtensions.includes(fileExtension)) { statusDiv.innerHTML = `<div class="alert alert-danger">Format file tidak valid. Harap gunakan file .xlsx atau .xls.</div>`; event.target.value = null; return; }

                 statusDiv.innerHTML = `<div class="alert alert-info"><div class="spinner-border spinner-border-sm" role="status"></div> Memproses file Excel "${file.name}"... Harap tunggu.</div>`;
                 if (uploadButton) toggleButtonLoading(uploadButton.id, true);

                 const reader = new FileReader();
                 reader.onload = async (e) => { // Make async for Firebase batch
                      let resultHtml = '';
                      let uploadSuccess = false;
                      const bankKey = currentActiveQuestionBank;
                      const is3OptionType = threeOptionTestKeys.includes(bankKey);
                      let addedCount = 0; let skippedCount = 0; let errorMessages = [];
                      // FIREBASE: Initialize batch write
                      // const batch = fbDb.batch();

                      try {
                          const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName]; if (!worksheet) throw new Error("Sheet pertama tidak ditemukan atau kosong."); const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                          if (!jsonData || jsonData.length < 2) throw new Error("Tidak ada data (minimal 1 baris header dan 1 baris data).");

                          const headersRaw = jsonData[0]; if (!headersRaw || headersRaw.length === 0) throw new Error("Header tidak ditemukan."); const headers = headersRaw.map(h => String(h).trim().toLowerCase());

                          // Validate Headers based on current bank type
                           let expectedHeaders, optionCount, hasAnswerColumn;
                           if (is3OptionType) { expectedHeaders = ["nomor", "pertanyaan", "opsi a", "opsi b", "opsi c"]; optionCount = 3; hasAnswerColumn = false; }
                           else { expectedHeaders = ["nomor", "pertanyaan", "opsi a", "opsi b", "opsi c", "opsi d", "jawaban"]; optionCount = 4; hasAnswerColumn = true; }

                           const requiredHeadersPresent = expectedHeaders.every(expectedH => headers.includes(expectedH));
                           if (!requiredHeadersPresent) { throw new Error(`Format header tidak sesuai untuk ${bankKey}. Header wajib: ${expectedHeaders.map(h=>`"${h}"`).join(', ')}.`); }
                           const headerMap = {}; headers.forEach((h, index) => { headerMap[h] = index; });

                           for (let i = 1; i < jsonData.length; i++) {
                                const row = jsonData[i]; if (row.every(cell => String(cell).trim() === '')) continue;
                                const rowNum = i + 1;
                                const questionText = String(row[headerMap["pertanyaan"]] || '').trim();
                                const options = []; for(let j=0; j<optionCount; j++) { options.push(String(row[headerMap[`opsi ${String.fromCharCode(97 + j)}`]] || '').trim()); }
                                const answer = hasAnswerColumn ? String(row[headerMap["jawaban"]] || '').trim().toUpperCase() : null;

                                 let rowErrors = [];
                                 if (!questionText) rowErrors.push("Pertanyaan kosong");
                                 options.forEach((opt, k) => { if (!opt) rowErrors.push(`Opsi ${String.fromCharCode(65+k)} kosong`); });
                                 if (hasAnswerColumn && !answer) rowErrors.push("Jawaban kosong");
                                 else if (hasAnswerColumn && !['A', 'B', 'C', 'D'].includes(answer)) rowErrors.push(`Jawaban '${answer}' tidak valid (A/B/C/D)`);

                                if (rowErrors.length > 0) { errorMessages.push(`Baris ${rowNum}: ${rowErrors.join(', ')}.`); skippedCount++; continue; }

                                // FIREBASE INTEGRATION POINT: Add to Firestore batch instead of local array.
                                const newQuestionData = { text: questionText, options: options, answer: answer, type: is3OptionType ? 'multiple-choice-3opt' : 'multiple-choice' };
                                // const newQuestionRef = fbDb.collection('questionBanks').doc(bankKey).collection('questions').doc(); // Auto-generate ID
                                // // This batch.set() will automatically create the 'questions' subcollection if it doesn't exist under the 'bankKey' document.
                                // batch.set(newQuestionRef, newQuestionData);

                                // --- Simulation ---
                                const newQuestion = { ...newQuestionData, id: generateQuestionId(bankKey) };
                                if (!questionBanks[bankKey]) questionBanks[bankKey] = [];
                                questionBanks[bankKey].push(newQuestion);
                                // --- End Simulation ---
                                addedCount++;
                            } // End row loop

                           // FIREBASE INTEGRATION POINT: Commit the Firestore batch write here.
                           // if (addedCount > 0) {
                           //     await batch.commit();
                           //     console.log(`${addedCount} questions committed to Firestore for bank ${bankKey}.`);
                           // }

                           if (addedCount > 0) {
                               resultHtml += `<div class="alert alert-success">Upload selesai! ${addedCount} soal baru ditambahkan ke bank ${bankKey}.${skippedCount > 0 ? ` ${skippedCount} baris dilewati.` : ''}</div>`;
                               uploadSuccess = true;
                               await renderQuestionTable(bankKey); // Update table only on success (await fetch)
                           } else if (skippedCount > 0 && errorMessages.length === 0) { resultHtml += `<div class="alert alert-warning">Tidak ada soal baru yang valid ditambahkan. ${skippedCount} baris data dilewati.</div>`; }
                           else { resultHtml += `<div class="alert alert-warning">Tidak ada soal baru yang ditambahkan dari file.</div>`; }

                           if (errorMessages.length > 0) {
                               resultHtml += `<div class="alert alert-danger mt-2" style="max-height: 150px; overflow-y: auto;"><strong class="d-block mb-1">Detail Baris yang Dilewati/Error (${errorMessages.length}):</strong><ul class="list-unstyled mb-0" style="font-size: 0.85em;">`;
                               errorMessages.slice(0, 20).forEach(msg => resultHtml += `<li><i class="fas fa-times-circle text-danger me-1"></i>${msg}</li>`);
                               if (errorMessages.length > 20) resultHtml += `<li>...dan ${errorMessages.length - 20} error lainnya.</li>`;
                               resultHtml += `</ul></div>`;
                           }

                      } catch (error) { console.error("Error processing Excel:", error); resultHtml = `<div class="alert alert-danger">Gagal memproses file: ${error.message}. Pastikan format dan isi file benar.</div>`; }
                      finally { statusDiv.innerHTML = resultHtml; if (uploadSuccess) showNotification("Upload soal dari Excel berhasil!", 'success'); if (uploadButton) toggleButtonLoading(uploadButton.id, false); event.target.value = null; } // Reset input and loading state
                 };
                 reader.onerror = (error) => { console.error("Error reading file:", error); statusDiv.innerHTML = `<div class="alert alert-danger">Gagal membaca file.</div>`; if (uploadButton) toggleButtonLoading(uploadButton.id, false); event.target.value = null; };
                 reader.readAsArrayBuffer(file);
              };
             // Make handleExcelQuestionUpload globally accessible
             window.handleExcelQuestionUpload = handleExcelQuestionUpload;


            // Lihat Nilai (Guru & Admin) - Enhanced
            const loadLihatNilai = async () => { // Make async
                if (currentUser.role !== 'guru' && currentUser.role !== 'admin') { mainContent.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Akses ditolak.</div>`; return; }

                showLoading();
                let contentHtml = `<h2 class="mb-3">Rekap Nilai & Hasil Test Murid</h2>`;
                let studentList = [];

                try {
                    // FIREBASE INTEGRATION POINT: Fetch list of all students (`users.murid`) from Firestore.
                    // Example: const studentsSnapshot = await fbDb.collection('users').where('role', '==', 'murid').orderBy('name').get();
                    // studentList = studentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); // Use Firestore ID as 'id'
                    studentList = users.murid || []; // Simulation fallback
                } catch (error) {
                    console.error("Error fetching student list:", error);
                    mainContent.innerHTML = `<div class="alert alert-danger">Gagal memuat daftar murid: ${error.message}</div>`;
                    return;
                }


                if (studentList.length === 0) {
                    contentHtml += `<div class="alert alert-info mt-3"><i class="fas fa-info-circle"></i> Belum ada data murid untuk ditampilkan.</div>`;
                } else {
                    // Process students one by one (can be slow for many students, consider pagination or server-side aggregation)
                    for (const murid of studentList.sort((a, b) => a.name.localeCompare(b.name))) {
                        const studentNisn = murid.nisn; // Simulation key
                        const studentUid = murid.id || murid.uid; // FIREBASE: Use Firestore document ID (or UID if stored)
                        let studentTestData = {};

                        try {
                            // FIREBASE INTEGRATION POINT: Fetch test history for *this* student.
                            // This is inefficient (N+1 problem). Fetching all history at once or using aggregated data is better.
                            // Example (Inefficient):
                            // const historyKeys = menus.murid.filter(item => item.section?.startsWith('test-')).map(item => item.section.replace('test-', ''));
                            // for (const key of historyKeys) {
                            //     const historySnapshot = await fbDb.collection('users').doc(studentUid).collection('testHistory').doc(key).collection('results').orderBy('date', 'desc').limit(3).get();
                            //     studentTestData[key] = historySnapshot.docs.map(doc => doc.data());
                            // }
                            studentTestData = testData[studentNisn] || {}; // Simulation fallback
                        } catch (fetchError) {
                            console.error(`Error fetching history for ${murid.name}:`, fetchError);
                            // Continue to next student, maybe show an error indicator for this student
                        }

                        contentHtml += `<div class="card student-score-card mb-4"> <div class="card-body p-4"> <h4 class="mb-3"><i class="fas fa-user-graduate me-2"></i> ${murid.name} <small class="text-muted">(NISN: ${studentNisn})</small></h4>`;
                        const studentTests = menus.murid.filter(item => item.section && item.section.startsWith('test-'));
                        if (studentTests.length > 0) {
                           contentHtml += '<div class="row">'; // Start grid for tests
                            studentTests.forEach(menuItem => {
                                const dataKey = menuItem.section.replace('test-', ''); const testTitle = menuItem.title.replace('Test ', ''); const history = studentTestData[dataKey] || [];
                                const hasScore = dataKeyRequiresScore(dataKey);

                                contentHtml += '<div class="col-md-6 mb-3">'; // Each test in its column
                                contentHtml += `<h5>${testTitle}</h5>`; // Test title

                                if (history.length > 0) {
                                     contentHtml += `<div class="table-responsive"><table class="data-table history-table mb-0"><thead><tr><th>Tanggal</th><th>${hasScore ? 'Skor' : 'Hasil'}</th></tr></thead><tbody>`;
                                     const sortedHistory = [...history].sort((a, b) => new Date(b.date) - new Date(a.date));
                                     sortedHistory.slice(0, 3).forEach(item => { // Show max 3 recent results
                                          // FIREBASE: Adjust date formatting if using Timestamp objects
                                          const dateValue = item.date?.toDate ? item.date.toDate() : new Date(item.date); // Handle Timestamp or string date
                                          const formattedDate = !isNaN(dateValue) ? dateValue.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' }) : 'Invalid Date';
                                          const displayValue = hasScore ? (item.score ?? '-') : (item.result ?? '-');
                                          contentHtml += `<tr><td>${formattedDate}</td><td>${displayValue}</td></tr>`;
                                      });
                                      contentHtml += '</tbody></table></div>';
                                       if(history.length > 3) contentHtml += `<p class="form-text mt-1 text-center">Lihat riwayat lengkap di halaman murid.</p>`
                                 } else { contentHtml += '<p class="text-muted form-text">Belum ada riwayat.</p>'; }
                                contentHtml += '</div>'; // Close column
                            });
                             contentHtml += '</div>'; // End grid row
                        } else { contentHtml += '<p class="text-muted">Tidak ada data test tersedia untuk murid ini.</p>';}
                        contentHtml += `</div></div>`; // Close card
                    } // End student loop
                }
                mainContent.innerHTML = contentHtml; // Render after processing all students
            };


            // Admin User Management - Enhanced
            const loadKelolaPengguna = async () => { // Make async
                if (currentUser.role !== 'admin') { mainContent.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Akses ditolak.</div>`; return; }
                let containerHtml = `
                     <div class="card">
                         <div class="card-header">
                             <h3 class="card-header-title mb-0">Manajemen Pengguna</h3>
                              <div class="card-header-actions">
                                  <button id="upload-excel-btn" class="btn btn-success btn-sm hidden" onclick="document.getElementById('excel-upload-input').click()" title="Upload data siswa dari Excel"> <i class="fas fa-file-excel"></i> Upload Siswa (Excel) </button>
                                  <button class="btn btn-primary btn-sm" onclick="openUserModal()" title="Tambah pengguna baru manual"> <i class="fas fa-plus"></i> Tambah Pengguna </button>
                                  <input type="file" id="excel-upload-input" class="hidden" accept=".xlsx, .xls" onchange="handleExcelUserUpload(event)">
                              </div>
                         </div>
                         <div class="card-body">
                              <div id="upload-status-message" class="mb-3"></div> <!-- Status Upload -->
                              <ul class="nav nav-tabs mb-3" id="user-tabs">
                                 <li class="nav-item"> <a class="nav-link ${currentActiveUserTab === 'guru' ? 'active' : ''}" href="#" data-role="guru"><i class="fas fa-chalkboard-teacher me-1"></i> Data Guru</a> </li>
                                 <li class="nav-item"> <a class="nav-link ${currentActiveUserTab === 'murid' ? 'active' : ''}" href="#" data-role="murid"><i class="fas fa-user-graduate me-1"></i> Data Murid</a> </li>
                                 <li class="nav-item"> <a class="nav-link ${currentActiveUserTab === 'admin' ? 'active' : ''}" href="#" data-role="admin"><i class="fas fa-user-shield me-1"></i> Data Admin</a> </li>
                              </ul>
                              <div class="tab-content" id="user-tab-content">
                                    <div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Memuat tabel...</span></div></div>
                              </div>
                         </div>
                     </div> `;
                 mainContent.innerHTML = containerHtml;
                 document.querySelectorAll('#user-tabs .nav-link').forEach(tab => { tab.addEventListener('click', (e) => { e.preventDefault(); showUserTab(e.target.getAttribute('data-role')); }); });
                 await showUserTab(currentActiveUserTab); // Render the initial or current tab (await fetch)
             };
             const showUserTab = async (role) => { // Make async
                 currentActiveUserTab = role;
                 const uploadButton = document.getElementById('upload-excel-btn');
                 const uploadStatusDiv = document.getElementById('upload-status-message');
                 document.querySelectorAll('#user-tabs .nav-link').forEach(tab => { tab.classList.toggle('active', tab.getAttribute('data-role') === role); });
                 if (uploadButton) uploadButton.classList.toggle('hidden', role !== 'murid'); // Show upload only for 'murid' tab
                 if (uploadStatusDiv) uploadStatusDiv.innerHTML = ''; // Clear upload status on tab change
                  const contentDiv = document.getElementById('user-tab-content');
                  if(contentDiv) contentDiv.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Memuat tabel pengguna ${role}...</span></div></div>`;

                  await renderUserTableForRole(role); // Await rendering which includes fetch
             };
             const renderUserTableForRole = async (role) => { // Make async
                  const container = document.getElementById('user-tab-content'); if (!container) return;

                  let usersOfRole = [];
                  try {
                      // FIREBASE INTEGRATION POINT: Fetch users for the selected `role` from Firestore.
                      // Example: const usersSnapshot = await fbDb.collection('users').where('role', '==', role).orderBy('name').get();
                      // usersOfRole = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); // Use Firestore ID as 'id'
                      usersOfRole = users[role] || []; // Simulation fallback
                  } catch (error) {
                      console.error(`Error fetching ${role} users:`, error);
                      container.innerHTML = `<div class="alert alert-danger">Gagal memuat data ${role}: ${error.message}</div>`;
                      return;
                  }

                  const tableId = `${role}-management-table`; const identifierHeader = role === 'murid' ? 'NISN' : 'Username';
                   let tableHtml = `<div class="table-responsive"><table class="data-table" id="${tableId}"><thead> <tr> <th>#</th> <th>Nama Lengkap</th> <th>${identifierHeader}</th> <th>Status</th> <th class="actions-cell">Aksi</th> </tr> </thead><tbody>`;

                  if (usersOfRole.length > 0) {
                      usersOfRole.forEach((user, index) => { // Already sorted by Firestore query or simulation
                         // FIREBASE: Use Firestore document ID (`user.id`) or UID if stored.
                         const identifier = user.nisn || user.username; // Key for actions (simulation)
                         const userId = user.id || user.uid || identifier; // Use Firestore ID/UID if available, else fallback (adjust based on your data)
                         const isCurrentUser = userId === currentUser.uid; // Compare with logged-in user's UID
                         const statusClass = user.status === 'aktif' ? 'status-aktif' : 'status-nonaktif';
                         const statusText = user.status === 'aktif' ? 'Aktif' : 'Nonaktif';
                         const toggleStatusText = user.status === 'aktif' ? 'Nonaktifkan' : 'Aktifkan';
                         const toggleStatusIcon = user.status === 'aktif' ? 'fa-toggle-off' : 'fa-toggle-on';
                         const toggleStatusBtnClass = user.status === 'aktif' ? 'btn-warning' : 'btn-success';
                          tableHtml += `<tr>
                                           <td>${index + 1}</td>
                                           <td>${user.name}</td>
                                           <td>${identifier}</td>
                                           <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                                           <td class="actions-cell">
                                                <button class="btn btn-info btn-sm btn-action" title="Edit Pengguna" onclick="openUserModal('${user.role}', '${userId}')"><i class="fas fa-edit fa-fw"></i></button>
                                                <button class="btn ${toggleStatusBtnClass} btn-sm btn-action" title="${toggleStatusText}" onclick="handleToggleStatus('${userId}', '${user.status}')" ${isCurrentUser ? 'disabled' : ''}><i class="fas ${toggleStatusIcon} fa-fw"></i></button>
                                                <button class="btn btn-secondary btn-sm btn-action" title="Reset Password (kirim email)" onclick="handleResetPassword('${userId}')"><i class="fas fa-key fa-fw"></i></button>
                                                <button class="btn btn-danger btn-sm btn-action" title="Hapus Pengguna" onclick="handleDeleteUser('${userId}', '${user.name}')" ${isCurrentUser ? 'disabled' : ''}><i class="fas fa-trash fa-fw"></i></button>
                                            </td>
                                          </tr>`;
                        });
                  } else { tableHtml += `<tr><td colspan="5" class="text-center text-muted p-4">Belum ada data pengguna ${role}.</td></tr>`; }
                  tableHtml += `</tbody></table></div>`;
                  container.innerHTML = tableHtml;
              };
              // Excel User Upload (Enhanced Feedback)
               window.handleExcelUserUpload = (event) => {
                  const file = event.target.files[0];
                   const statusDiv = document.getElementById('upload-status-message');
                   const uploadButton = document.getElementById('upload-excel-btn');
                   statusDiv.innerHTML = ''; statusDiv.className = 'mb-3';
                   if (!file) return;

                  const validExtensions = ['.xlsx', '.xls']; const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase(); if (!validExtensions.includes(fileExtension)) { statusDiv.innerHTML = `<div class="alert alert-danger">Format file tidak valid (.xlsx/.xls).</div>`; event.target.value = null; return; }

                  statusDiv.innerHTML = `<div class="alert alert-info"><div class="spinner-border spinner-border-sm" role="status"></div> Memproses file "${file.name}"... Harap tunggu.</div>`;
                   toggleButtonLoading(uploadButton.id, true);

                   const reader = new FileReader();
                   reader.onload = async (e) => { // Make async for Firebase calls
                        let resultHtml = ''; let uploadSuccess = false;
                        let addedCount = 0; let skippedCount = 0; let errorMessages = [];
                        // FIREBASE: Initialize batch write for Firestore
                        // const batch = fbDb.batch();

                        try {
                            const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName]; if (!worksheet) throw new Error("Sheet pertama tidak ditemukan."); const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                             if (!jsonData || jsonData.length < 2) throw new Error("Tidak ada data (minimal 1 header dan 1 data).");
                            const headers = jsonData[0].map(h => String(h).trim().toLowerCase()); const expectedHeaders = ["nomor", "nama lengkap", "nisn"];
                             if (headers.length < 3 || headers[0] !== expectedHeaders[0] || headers[1] !== expectedHeaders[1] || headers[2] !== expectedHeaders[2]) throw new Error(`Format header Excel tidak sesuai. Harap gunakan: Nomor, Nama Lengkap, NISN. Header terdeteksi: ${jsonData[0].join(', ')}`);

                             const defaultPassword = 'password123'; // Default password for new users

                             for (let i = 1; i < jsonData.length; i++) {
                                  const row = jsonData[i]; if (row.every(cell => String(cell).trim() === '')) continue;
                                  const rowNum = i + 1;
                                  const namaLengkap = String(row[1] || '').trim(); const nisn = String(row[2] || '').trim().replace(/\s+/g, '');

                                 if (!namaLengkap || !nisn) { errorMessages.push(`Baris ${rowNum}: Nama/NISN kosong.`); skippedCount++; continue; }
                                 if (!/^\d+$/.test(nisn)) { errorMessages.push(`Baris ${rowNum}: NISN '${nisn}' tidak valid (harus angka).`); skippedCount++; continue; }

                                 // FIREBASE: Check if NISN already exists in Firestore
                                 // const existingUserSnapshot = await fbDb.collection('users').where('nisn', '==', nisn).limit(1).get();
                                 // if (!existingUserSnapshot.empty) {
                                 //     errorMessages.push(`Baris ${rowNum}: NISN '${nisn}' (${namaLengkap}) sudah terdaftar.`); skippedCount++; continue;
                                 // }

                                 // --- Simulation Check ---
                                 if (users.murid.some(murid => murid.nisn === nisn)) { errorMessages.push(`Baris ${rowNum}: NISN '${nisn}' (${namaLengkap}) sudah terdaftar.`); skippedCount++; continue; }
                                 // --- End Simulation Check ---

                                 // FIREBASE INTEGRATION POINT: Create Auth user and add Firestore doc to batch
                                 try {
                                     // Generate a dummy email for Auth creation (replace with real emails if available)
                                     const email = `${nisn}@save-eduapp.firebaseapp.com`; // Example dummy email
                                     // Create user in Firebase Auth
                                     // const userCredential = await fbAuth.createUserWithEmailAndPassword(email, defaultPassword);
                                     // const uid = userCredential.user.uid;

                                     // Prepare Firestore data
                                     const newUserFirestoreData = {
                                         // uid: uid, // Store UID for reference
                                         name: namaLengkap,
                                         nisn: nisn,
                                         role: 'murid',
                                         status: 'aktif',
                                         parentName: '', // Default empty
                                         address: '', // Default empty
                                         profilePic: 'assets/default-profile.png', // Default pic
                                         createdAt: firebase.firestore.FieldValue.serverTimestamp() // Record creation time
                                     };

                                     // Add Firestore document creation to batch
                                     // const userDocRef = fbDb.collection('users').doc(uid);
                                     // // This batch.set() will automatically create the 'users' collection if it doesn't exist.
                                     // batch.set(userDocRef, newUserFirestoreData);

                                     // --- Simulation Add ---
                                     users.murid.push({ ...newUserFirestoreData, password: defaultPassword, id: `sim_${nisn}` }); // Add simulation password and ID
                                     // --- End Simulation Add ---

                                     addedCount++;
                                 } catch (authError) {
                                     console.error(`Error creating auth user for NISN ${nisn}:`, authError);
                                     let authErrorMessage = `Gagal membuat akun Auth (${authError.code || authError.message})`;
                                     if (authError.code === 'auth/email-already-in-use') {
                                         authErrorMessage = `Email (dummy) untuk NISN ${nisn} sudah digunakan.`;
                                     }
                                     errorMessages.push(`Baris ${rowNum}: ${authErrorMessage}`);
                                     skippedCount++;
                                 }
                             } // End row loop

                            // FIREBASE: Commit Firestore batch write here.
                            // if (addedCount > 0) {
                            //     await batch.commit();
                            //     console.log(`${addedCount} users committed to Firestore.`);
                            // }

                            if (addedCount > 0) {
                                 resultHtml += `<div class="alert alert-success">Upload berhasil! ${addedCount} siswa baru ditambahkan.${skippedCount > 0 ? ` ${skippedCount} baris data dilewati/error.` : ''} Password default adalah '${defaultPassword}'.</div>`;
                                 uploadSuccess = true;
                                 await renderUserTableForRole('murid'); // Refresh table (await fetch)
                             } else if (skippedCount > 0 && errorMessages.length === 0) { resultHtml += `<div class="alert alert-warning">Tidak ada siswa baru ditambahkan. ${skippedCount} baris dilewati.</div>`; }
                             else { resultHtml += `<div class="alert alert-warning">Tidak ada siswa baru yang ditambahkan dari file.</div>`; }

                            if (errorMessages.length > 0) {
                                resultHtml += `<div class="alert alert-danger mt-2" style="max-height: 150px; overflow-y: auto;"><strong class="d-block mb-1">Detail Error/Skipped (${errorMessages.length}):</strong><ul class="list-unstyled mb-0" style="font-size: 0.85em;">`;
                                errorMessages.slice(0, 20).forEach(msg => resultHtml += `<li><i class="fas fa-times-circle text-danger me-1"></i>${msg}</li>`);
                                if (errorMessages.length > 20) resultHtml += `<li>...dan ${errorMessages.length - 20} error lainnya.</li>`;
                                resultHtml += `</ul></div>`;
                            }
                        } catch (error) { console.error("Error processing Excel:", error); resultHtml = `<div class="alert alert-danger">Gagal memproses file: ${error.message}. Pastikan format dan isi file benar.</div>`; }
                        finally { statusDiv.innerHTML = resultHtml; if(uploadSuccess) showNotification("Upload data siswa selesai.", "success"); toggleButtonLoading(uploadButton.id, false); event.target.value = null; } // Reset input and loading state
                   };
                    reader.onerror = (error) => { console.error("Error reading file:", error); statusDiv.innerHTML = `<div class="alert alert-danger">Gagal membaca file.</div>`; toggleButtonLoading(uploadButton.id, false); event.target.value = null; };
                    reader.readAsArrayBuffer(file);
              };
             // Make handleExcelUserUpload globally accessible
             window.handleExcelUserUpload = handleExcelUserUpload;


            // User Modal Functions (Enhanced Validation)
             window.openUserModal = async (role = null, userId = null) => { // Use userId (Firestore ID/UID)
                 const modalId = 'user-modal';
                 openModal(modalId);
                 clearModalError(modalId);
                 const form = document.getElementById('user-form');
                 const title = document.getElementById('user-modal-title');
                 const editModeInput = document.getElementById('user-edit-mode'); // Stores role being edited
                 const editIdentifierInput = document.getElementById('user-edit-identifier'); // Stores Firestore ID/UID
                 const passwordInput = document.getElementById('user-password');
                 const confirmPasswordInput = document.getElementById('user-confirm-password');
                 const passwordRequired = document.getElementById('password-required-indicator');
                 const confirmPasswordRequired = document.getElementById('confirm-password-required-indicator');
                 const passwordHelp = document.getElementById('password-help');
                 const roleSelectModal = document.getElementById('user-role');
                 const identifierInput = document.getElementById('user-identifier'); // NISN/Username input

                  form.reset();
                  form.classList.remove('was-validated');
                   passwordInput.classList.remove('is-invalid'); confirmPasswordInput.classList.remove('is-invalid');
                  editModeInput.value = role; // Store role being edited
                  editIdentifierInput.value = userId; // Store Firestore ID/UID
                  const isEdit = role && userId;

                  title.textContent = isEdit ? 'Edit Detail Pengguna' : 'Tambah Pengguna Baru';
                  passwordRequired.style.display = isEdit ? 'none' : 'inline';
                  confirmPasswordRequired.style.display = isEdit ? 'none' : 'inline';
                   passwordHelp.textContent = isEdit ? 'Kosongkan jika tidak ingin mengubah.' : 'Min. 6 karakter. Wajib diisi.';
                  passwordInput.required = !isEdit;
                  confirmPasswordInput.required = !isEdit;
                  confirmPasswordInput.disabled = !passwordInput.value && isEdit;

                  roleSelectModal.disabled = isEdit;
                   identifierInput.disabled = isEdit; // Disable NISN/Username input on edit

                  passwordInput.addEventListener('input', () => {
                      confirmPasswordInput.disabled = !passwordInput.value;
                      confirmPasswordInput.required = !!passwordInput.value;
                      if (!passwordInput.value) { confirmPasswordInput.classList.remove('is-invalid'); confirmPasswordInput.value = ''; }
                  });

                  if (isEdit) {
                       try {
                           // FIREBASE INTEGRATION POINT: Fetch user data from Firestore using userId (which is the doc ID/UID).
                           // const userDoc = await fbDb.collection('users').doc(userId).get();
                           // if (!userDoc.exists) throw new Error("Pengguna tidak ditemukan di database.");
                           // const userToEdit = { id: userDoc.id, ...userDoc.data() };

                           // --- Simulation Find ---
                           let userToEdit = findUserById(userId); // Use new helper
                           if (!userToEdit) throw new Error("Pengguna tidak ditemukan (simulasi).");
                           // --- End Simulation Find ---

                           document.getElementById('user-nama').value = userToEdit.name || '';
                           roleSelectModal.value = userToEdit.role;
                           // Display the correct identifier (NISN or Username)
                           identifierInput.value = userToEdit.nisn || userToEdit.username || '';
                           document.getElementById('user-status').value = userToEdit.status || 'aktif';
                           if (userToEdit.role === 'murid') {
                               document.getElementById('user-parentName').value = userToEdit.parentName || '';
                               document.getElementById('user-address').value = userToEdit.address || '';
                           }
                       } catch (error) {
                           console.error("Error fetching user for edit:", error);
                           showNotification(`Error: ${error.message}`, "danger");
                           closeModal(modalId);
                           return;
                       }
                  } else {
                      roleSelectModal.value = currentActiveUserTab || 'guru';
                      confirmPasswordInput.disabled = false;
                      confirmPasswordInput.required = true;
                      passwordInput.required = true;
                  }

                 toggleUserFormFields(); // Update fields based on role
             };
             // Make openUserModal globally accessible
             window.openUserModal = openUserModal;

             // Helper to find user by ID (Firestore ID/UID) - Simulation
             const findUserById = (userId) => {
                 // FIREBASE: This function is not needed if you fetch directly using the ID in openUserModal.
                 for (const role in users) {
                     const user = users[role].find(u => u.id === userId || u.nisn === userId || u.username === userId); // Simulate finding by ID or identifier
                     if (user) return user;
                 }
                 return null;
             };


             window.toggleUserFormFields = () => {
                  const role = document.getElementById('user-role').value;
                  const identifierLabel = document.getElementById('user-identifier-label');
                  const identifierInput = document.getElementById('user-identifier');
                  const muridFields = document.getElementById('murid-fields');
                  const saveButton = document.getElementById('user-modal-save-btn');

                 if (role === 'murid') {
                     identifierLabel.innerHTML = 'NISN <span class="text-danger">*</span>';
                     identifierInput.placeholder = 'Masukkan NISN Numerik';
                     identifierInput.type = 'number';
                     identifierInput.pattern = '\\d+';
                     muridFields.classList.remove('hidden');
                 } else {
                     identifierLabel.innerHTML = 'Username <span class="text-danger">*</span>';
                     identifierInput.placeholder = 'Masukkan Username';
                     identifierInput.type = 'text';
                     identifierInput.removeAttribute('pattern');
                     muridFields.classList.add('hidden');
                 }
                saveButton.disabled = false;
             };
             // Make toggleUserFormFields globally accessible
             window.toggleUserFormFields = toggleUserFormFields;

             const userForm = document.getElementById('user-form'); if (userForm) { userForm.addEventListener('submit', (event) => { event.preventDefault(); handleUserFormSubmit(); }); }
             const handleUserFormSubmit = async () => { // Make async
                const modalId = 'user-modal'; const form = document.getElementById('user-form'); const saveButton = document.getElementById('user-modal-save-btn');
                 clearModalError(modalId);

                 const isEdit = !!document.getElementById('user-edit-identifier').value; // Check if editing based on stored ID/UID
                 const passwordInput = document.getElementById('user-password');
                 const confirmPasswordInput = document.getElementById('user-confirm-password');
                 confirmPasswordInput.required = !isEdit || !!passwordInput.value;

                  if (!validateForm(form)) { displayModalError(modalId, "Harap perbaiki isian yang ditandai."); return; }
                  toggleButtonLoading(saveButton.id, true);

                   // Get values
                   const name = document.getElementById('user-nama').value.trim(); const role = document.getElementById('user-role').value; const identifierValue = document.getElementById('user-identifier').value.trim(); // NISN or Username
                   const status = document.getElementById('user-status').value; const password = document.getElementById('user-password').value;
                  const parentName = document.getElementById('user-parentName')?.value.trim(); const address = document.getElementById('user-address')?.value.trim();
                  const editUserId = document.getElementById('user-edit-identifier').value; // Firestore ID/UID

                   try {
                       if (isEdit) {
                           // --- EDIT USER ---
                           const userDocRef = fbDb.collection('users').doc(editUserId);
                           const dataToUpdate = { name: name, status: status };
                           if (role === 'murid') { dataToUpdate.parentName = parentName; dataToUpdate.address = address; }
                           // Note: Role and Identifier (NISN/Username) are generally not changed on edit.
                           // Password change requires re-authentication, handle separately or add logic here.
                           // If password field has value, trigger password update flow (re-auth + updatePassword) - omitted for brevity here.
                           // This update() assumes the 'users' collection and document exist.
                           await userDocRef.update(dataToUpdate);
                           console.log("User updated in Firestore:", editUserId);

                           // --- Simulation Update ---
                           let userIndex = -1; let userRole = document.getElementById('user-edit-mode').value;
                           if (userRole === 'murid') userIndex = users.murid.findIndex(u => (u.id || u.nisn) === editUserId);
                           else if (userRole === 'guru') userIndex = users.guru.findIndex(u => (u.id || u.username) === editUserId);
                           else if (userRole === 'admin') userIndex = users.admin.findIndex(u => (u.id || u.username) === editUserId);
                           if(userIndex > -1) { users[userRole][userIndex] = {...users[userRole][userIndex], ...dataToUpdate}; }
                           // --- End Simulation Update ---

                       } else {
                           // --- ADD USER ---
                           // Check if identifier already exists (Firestore query)
                           const identifierField = role === 'murid' ? 'nisn' : 'username';
                           const existingUserSnapshot = await fbDb.collection('users').where(identifierField, '==', identifierValue).limit(1).get();
                           if (!existingUserSnapshot.empty) { throw new Error(`${role === 'murid' ? 'NISN' : 'Username'} "${identifierValue}" sudah digunakan.`); }

                           // Create user in Firebase Auth
                           const email = `${identifierValue}@save-eduapp.firebaseapp.com`; // Dummy email
                           const userCredential = await fbAuth.createUserWithEmailAndPassword(email, password);
                           const uid = userCredential.user.uid;

                           // Prepare Firestore data
                           const newUserFirestoreData = {
                               uid: uid, // Store UID
                               name: name, role: role, status: status,
                               createdAt: firebase.firestore.FieldValue.serverTimestamp()
                           };
                           if (role === 'murid') { newUserFirestoreData.nisn = identifierValue; newUserFirestoreData.parentName = parentName; newUserFirestoreData.address = address; }
                           else { newUserFirestoreData.username = identifierValue; }

                           // Set Firestore document with UID as doc ID
                           const userDocRef = fbDb.collection('users').doc(uid);
                           // This set() operation WILL AUTOMATICALLY CREATE the 'users' collection if it doesn't exist.
                           await userDocRef.set(newUserFirestoreData);
                           console.log("User added to Auth and Firestore:", uid);

                           // --- Simulation Add ---
                           const simData = {...newUserFirestoreData, id: uid, password: password}; // Add ID and password for simulation
                           if (role === 'murid') users.murid.push(simData);
                           else if (role === 'guru') users.guru.push(simData);
                           else if (role === 'admin') users.admin.push(simData);
                           // --- End Simulation Add ---
                       }

                       toggleButtonLoading(saveButton.id, false);
                       closeModal(modalId);
                       await showUserTab(currentActiveUserTab); // Refresh current table view (await fetch)
                       showNotification(`Data pengguna ${isEdit ? 'berhasil diperbarui' : 'berhasil ditambahkan'}!`, 'success');

                   } catch (error) {
                       console.error("Error saving user:", error);
                       displayModalError(modalId, `Gagal menyimpan: ${error.message}`);
                       toggleButtonLoading(saveButton.id, false);
                   }
              };


             // User Action Handlers (Firebase Ready)
            window.handleDeleteUser = async (userId, userName) => { // Use userId (Firestore ID/UID)
                // FIREBASE INTEGRATION POINT:
                // Deleting Auth users requires Admin SDK (backend function) or re-authentication on client.
                // For simplicity, we'll just delete the Firestore document here. Auth user will be orphaned.
                // A better approach involves a Cloud Function triggered by Firestore delete or an admin panel.
                const userDocRef = fbDb.collection('users').doc(userId);
                const isCurrentUser = userId === currentUser.uid;
                if (isCurrentUser) { showNotification("Anda tidak dapat menghapus akun Anda sendiri.", "warning"); return; }

                if (confirm(`Anda yakin ingin menghapus pengguna "${userName}" (ID: ${userId})? Data terkait mungkin tetap ada. Tindakan ini tidak dapat diurungkan.`)) {
                    try {
                        // This delete() assumes the 'users' collection and document exist.
                        await userDocRef.delete();
                        console.log("User deleted from Firestore (simulation):", userId);

                        // --- Simulation Delete ---
                        for (const role in users) { users[role] = users[role].filter(u => (u.id || u.nisn || u.username) !== userId); }
                        // --- End Simulation Delete ---

                        await showUserTab(currentActiveUserTab); // Refresh view (await fetch)
                        showNotification("Pengguna berhasil dihapus dari database.", "success");
                    } catch (error) {
                        console.error("Error deleting user:", error);
                        showNotification(`Gagal menghapus pengguna: ${error.message}`, "danger");
                    }
                 }
            };
            // Make handleDeleteUser globally accessible
            window.handleDeleteUser = handleDeleteUser;

            window.handleToggleStatus = async (userId, currentStatus) => { // Use userId (Firestore ID/UID)
                const userDocRef = fbDb.collection('users').doc(userId);
                const isCurrentUser = userId === currentUser.uid;
                const newStatus = currentStatus === 'aktif' ? 'nonaktif' : 'aktif';
                const actionText = newStatus === 'aktif' ? 'mengaktifkan' : 'menonaktifkan';

                if (isCurrentUser && newStatus === 'nonaktif') { showNotification("Anda tidak dapat menonaktifkan akun Anda sendiri.", "warning"); return; }

                // Fetch user name for confirmation (optional but good UX)
                let userName = `Pengguna (ID: ${userId})`;
                try { const userDoc = await userDocRef.get(); if(userDoc.exists) userName = userDoc.data().name; } catch(e){}

                if (confirm(`Anda yakin ingin ${actionText} pengguna "${userName}"?`)) {
                    try {
                        // This update() assumes the 'users' collection and document exist.
                        await userDocRef.update({ status: newStatus });
                        console.log("User status updated in Firestore:", userId, newStatus);

                        // --- Simulation Update ---
                        const user = findUserById(userId); if(user) user.status = newStatus;
                        // --- End Simulation Update ---

                        await showUserTab(currentActiveUserTab); // Refresh view (await fetch)
                        showNotification(`Status pengguna ${userName} berhasil diubah menjadi ${newStatus}.`, "success");
                    } catch (error) {
                        console.error("Error toggling user status:", error);
                        showNotification(`Gagal mengubah status: ${error.message}`, "danger");
                    }
                 }
            };
            // Make handleToggleStatus globally accessible
            window.handleToggleStatus = handleToggleStatus;

            window.handleResetPassword = async (userId) => { // Use userId (Firestore ID/UID)
                // FIREBASE: Sending reset email is the standard client-side approach.
                try {
                    const userDoc = await fbDb.collection('users').doc(userId).get();
                    if (!userDoc.exists) throw new Error("Data pengguna tidak ditemukan.");
                    const userData = userDoc.data();
                    // Use the identifier to construct the dummy email used for Auth
                    const identifier = userData.nisn || userData.username;
                    if (!identifier) throw new Error("Identifier (NISN/Username) tidak ditemukan untuk pengguna.");
                    const email = `${identifier}@save-eduapp.firebaseapp.com`; // Must match the dummy email used during creation

                    if (confirm(`Kirim email reset password ke alamat terkait "${userData.name}" (Email: ${email})?`)) {
                        await fbAuth.sendPasswordResetEmail(email);
                        console.log("Password reset email sent to:", email);
                        showNotification(`Email reset password telah dikirim untuk ${userData.name}.`, "success");
                    }
                } catch (error) {
                    console.error("Error sending password reset email:", error);
                    let errorMsg = `Gagal mengirim email reset: ${error.message}`;
                    if (error.code === 'auth/user-not-found') {
                        errorMsg = "Gagal mengirim email reset: Akun Auth tidak ditemukan (mungkin email dummy salah?).";
                    }
                    showNotification(errorMsg, "danger", 5000);
                }
            };
            // Make handleResetPassword globally accessible
            window.handleResetPassword = handleResetPassword;


            // --- Question Modal Functions (Firebase Ready) ---
             window.openQuestionModal = async (bankKey = null, questionId = null) => { // Make async
                const modalId = 'question-modal'; openModal(modalId); clearModalError(modalId);
                 const form = document.getElementById('question-form');
                 const title = document.getElementById('question-modal-title');
                 const editIdInput = document.getElementById('question-edit-id'); // Stores Firestore Doc ID
                 const bankKeyInput = document.getElementById('question-bank-key');
                 const optionDGroup = document.getElementById('question-option-d-group');
                 const answerGroup = document.getElementById('question-answer-group');
                 const answerSelect = document.getElementById('question-answer');

                 form.reset(); form.classList.remove('was-validated');
                const currentBank = bankKey || currentActiveQuestionBank;
                 editIdInput.value = questionId; bankKeyInput.value = currentBank;

                 const isEdit = !!questionId; // Edit if questionId is provided
                 const is3Opt = threeOptionTestKeys.includes(currentBank);
                  const bankDisplayName = currentBank.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());

                 title.textContent = isEdit ? 'Edit Soal' : `Tambah Soal - ${bankDisplayName}`;
                 optionDGroup.classList.toggle('hidden', is3Opt);
                 document.getElementById('question-option-d').required = !is3Opt;
                 answerGroup.classList.toggle('hidden', is3Opt);
                 answerSelect.required = !is3Opt;

                 if (isEdit) {
                      try {
                          // FIREBASE INTEGRATION POINT: Fetch the specific question data from Firestore.
                          // const questionDoc = await fbDb.collection('questionBanks').doc(currentBank).collection('questions').doc(questionId).get();
                          // if (!questionDoc.exists) throw new Error("Soal tidak ditemukan.");
                          // const questionToEdit = { id: questionDoc.id, ...questionDoc.data() };

                          // --- Simulation Find ---
                          const bank = questionBanks[currentBank] || [];
                          const questionToEdit = bank.find(q => q.id === questionId);
                          if (!questionToEdit) throw new Error("Soal tidak ditemukan (simulasi).");
                          // --- End Simulation Find ---

                          document.getElementById('question-text').value = questionToEdit.text || '';
                          document.getElementById('question-option-a').value = questionToEdit.options?.[0] || '';
                          document.getElementById('question-option-b').value = questionToEdit.options?.[1] || '';
                          document.getElementById('question-option-c').value = questionToEdit.options?.[2] || '';
                          if (!is3Opt) {
                              document.getElementById('question-option-d').value = questionToEdit.options?.[3] || '';
                              answerSelect.value = questionToEdit.answer || '';
                          }
                      } catch (error) {
                          console.error("Error fetching question for edit:", error);
                          showNotification(`Error: ${error.message}`, "danger");
                          closeModal(modalId);
                          return;
                      }
                  } else { answerSelect.value = ''; }
              };
             // Make openQuestionModal globally accessible
             window.openQuestionModal = openQuestionModal;

             const questionForm = document.getElementById('question-form'); if (questionForm) { questionForm.addEventListener('submit', (event) => { event.preventDefault(); handleQuestionFormSubmit(); }); }
             const handleQuestionFormSubmit = async () => { // Make async
                  const modalId = 'question-modal'; const form = document.getElementById('question-form'); const saveButton = document.getElementById('question-modal-save-btn');
                   clearModalError(modalId);

                  if (!validateForm(form)) { displayModalError(modalId, "Harap perbaiki isian yang ditandai."); return; }
                  toggleButtonLoading(saveButton.id, true);

                   const bankKey = document.getElementById('question-bank-key').value; const editId = document.getElementById('question-edit-id').value; // Firestore Doc ID
                   const text = document.getElementById('question-text').value.trim(); const optA = document.getElementById('question-option-a').value.trim(); const optB = document.getElementById('question-option-b').value.trim(); const optC = document.getElementById('question-option-c').value.trim();
                   const is3Opt = threeOptionTestKeys.includes(bankKey); const optD = !is3Opt ? document.getElementById('question-option-d').value.trim() : null; const answer = !is3Opt ? document.getElementById('question-answer').value : null;

                  let errors = [];
                  if(!text) errors.push("Teks pertanyaan kosong."); if(!optA) errors.push("Opsi A kosong."); if(!optB) errors.push("Opsi B kosong."); if(!optC) errors.push("Opsi C kosong.");
                  if (!is3Opt && !optD) errors.push("Opsi D kosong."); if (!is3Opt && !answer) errors.push("Jawaban benar belum dipilih.");
                  if(errors.length > 0) { displayModalError(modalId, errors.join('<br>')); toggleButtonLoading(saveButton.id, false); return; }

                  if (!bankKey) { displayModalError(modalId, 'Error: Bank soal tidak valid.'); toggleButtonLoading(saveButton.id, false); return; }

                  const questionData = { text: text, options: is3Opt ? [optA, optB, optC] : [optA, optB, optC, optD], answer: answer, type: is3Opt ? 'multiple-choice-3opt' : 'multiple-choice' };

                  try {
                      if (editId) { // Edit mode
                          // FIREBASE: Update Firestore doc.
                          // const questionDocRef = fbDb.collection('questionBanks').doc(bankKey).collection('questions').doc(editId);
                          // // This update() assumes the collections and document exist.
                          // await questionDocRef.update(questionData);
                          // console.log("Question updated in Firestore:", editId);

                          // --- Simulation Update ---
                          const qIndex = questionBanks[bankKey]?.findIndex(q => q.id === editId);
                          if (qIndex > -1) { questionBanks[bankKey][qIndex] = { ...questionBanks[bankKey][qIndex], ...questionData }; }
                          else { throw new Error("Soal tidak ditemukan untuk diedit (simulasi)."); }
                          // --- End Simulation Update ---

                      } else { // Add mode
                           // FIREBASE: Add new doc to Firestore.
                           // const questionsColRef = fbDb.collection('questionBanks').doc(bankKey).collection('questions');
                           // // This add() operation WILL AUTOMATICALLY CREATE the 'questionBanks' collection (if needed)
                           // // and the 'questions' subcollection under the 'bankKey' document if they don't exist.
                           // const newDocRef = await questionsColRef.add(questionData);
                           // console.log("Question added to Firestore with ID:", newDocRef.id);
                           // questionData.id = newDocRef.id; // Add the generated ID for simulation consistency

                           // --- Simulation Add ---
                           questionData.id = generateQuestionId(bankKey); // Simulation ID
                           if (!questionBanks[bankKey]) questionBanks[bankKey] = [];
                           questionBanks[bankKey].push(questionData);
                           // --- End Simulation Add ---
                      }

                      toggleButtonLoading(saveButton.id, false);
                      closeModal(modalId);
                      await renderQuestionTable(bankKey); // Refresh table view (await fetch)
                      showNotification(`Soal ${editId ? 'berhasil diperbarui' : 'berhasil ditambahkan'}!`, 'success');

                  } catch (error) {
                      console.error("Error saving question:", error);
                      displayModalError(modalId, `Gagal menyimpan soal: ${error.message}`);
                      toggleButtonLoading(saveButton.id, false);
                  }
              };
            window.handleDeleteQuestion = async (bankKey, questionId) => { // Make async
                 // FIREBASE INTEGRATION POINT: Use `deleteDoc` to delete the question document from Firestore.
                 if (!bankKey || !questionId) { showNotification("Error: Data soal tidak valid.", "danger"); return; }

                 // Fetch question text for confirmation (optional)
                 let questionTextPreview = `Soal (ID: ${questionId})`;
                 try {
                     // FIREBASE: const questionDoc = await fbDb.collection('questionBanks').doc(bankKey).collection('questions').doc(questionId).get();
                     // if (questionDoc.exists) questionTextPreview = (questionDoc.data().text || '').substring(0, 50) + "...";

                     // --- Simulation Find ---
                     const bank = questionBanks[bankKey] || [];
                     const q = bank.find(q => q.id === questionId);
                     if (q) questionTextPreview = (q.text || '').substring(0, 50) + "...";
                     // --- End Simulation Find ---
                 } catch(e) {}


                 if (confirm(`Anda yakin ingin menghapus soal "${questionTextPreview}" dari bank ${bankKey}?`)) {
                      try {
                          // FIREBASE: Delete Firestore doc.
                          // const questionDocRef = fbDb.collection('questionBanks').doc(bankKey).collection('questions').doc(questionId);
                          // // This delete() assumes the collections and document exist.
                          // await questionDocRef.delete();
                          // console.log("Question deleted from Firestore:", questionId);

                          // --- Simulation Delete ---
                          const qIndex = questionBanks[bankKey]?.findIndex(q => q.id === questionId);
                          if (qIndex > -1) { questionBanks[bankKey].splice(qIndex, 1); }
                          else { throw new Error("Soal tidak ditemukan untuk dihapus (simulasi)."); }
                          // --- End Simulation Delete ---

                          await renderQuestionTable(bankKey); // Refresh the table (await fetch)
                          showNotification("Soal berhasil dihapus.", "success");
                      } catch (error) {
                          console.error("Error deleting question:", error);
                          showNotification(`Gagal menghapus soal: ${error.message}`, "danger");
                      }
                  }
             };
             // Make handleDeleteQuestion globally accessible
             window.handleDeleteQuestion = handleDeleteQuestion;


            // --- Helper Functions ---
            window.navigateTo = (section, title) => { loadContent(section, title, false); };
            window.navigateToHistory = (originalSection, dataKey, title) => { const historySection = `${originalSection}-history`; loadContent(historySection, `Riwayat Test ${title}`, true); };
            // FIX: Define startTest directly and make it globally accessible
            const startTest = (testKey, testTitle) => {
                loadTestInterface(testKey, testTitle);
            };
            window.startTest = startTest; // Make it global

            // Helper to determine if a test key should have a score
            const dataKeyRequiresScore = (dataKey) => {
                // Add other non-scored keys here if necessary
                return !['gayaBelajar', 'kecerdasanGanda', 'modalitasBelajar', 'ketertarikan'].includes(dataKey);
            };

            // Helper to get latest non-scored result for a student (Simulation)
            const getLatestResult = (studentNisn, testKey, resultField = 'result') => {
                // FIREBASE: Fetch latest result from student's history subcollection
                const studentData = testData[studentNisn]; // Simulation
                if (studentData && studentData[testKey] && studentData[testKey].length > 0) {
                    const sortedHistory = [...studentData[testKey]].sort((a, b) => new Date(b.date) - new Date(a.date));
                    return sortedHistory[0][resultField] || '--'; // Return result or default
                }
                return 'Belum ada'; // Default if no history
            };

            // Helper to get score history for sparklines (Simulation)
            const getScoreHistory = (studentNisn, testKey) => {
                 // FIREBASE: Fetch score history from student's history subcollection
                const studentData = testData[studentNisn]; // Simulation
                if (studentData && studentData[testKey] && studentData[testKey].length > 0) {
                    // Sort by date ascending for trend line
                    const sortedHistory = [...studentData[testKey]].sort((a, b) => new Date(a.date) - new Date(b.date));
                    return sortedHistory.map(item => item.score).filter(score => score !== null && score !== undefined); // Return only scores
                }
                return []; // Return empty array if no history
            };

            // Helper to render sparkline chart
            const renderSparkline = (canvasId, scores, label) => {
                const canvas = document.getElementById(canvasId);
                const container = document.getElementById(canvasId + '-container'); // Get container
                if (!canvas || !container) { console.warn(`Canvas or container not found for sparkline: ${canvasId}`); return; }

                // Destroy previous chart instance if exists
                if (activeCharts[canvasId]) { activeCharts[canvasId].destroy(); }

                if (scores && scores.length >= 2) { // Need at least 2 points for a line
                    container.innerHTML = ''; // Clear any placeholder
                    container.appendChild(canvas); // Re-add canvas if cleared
                    const ctx = canvas.getContext('2d');
                    if (!ctx) { console.error(`Could not get 2D context for sparkline: ${canvasId}`); return; }

                    activeCharts[canvasId] = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: scores.map((_, index) => index + 1), // Simple numerical labels
                            datasets: [{
                                label: label,
                                data: scores,
                                fill: false,
                                borderColor: 'rgba(13, 110, 253, 0.6)', // Primary color with transparency
                                tension: 0.1, // Slight curve
                                borderWidth: 1.5,
                                pointRadius: 0, // Hide points
                                pointHoverRadius: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: { display: false }, // Hide X axis
                                y: { display: false }  // Hide Y axis
                            },
                            plugins: {
                                legend: { display: false }, // Hide legend
                                tooltip: { enabled: false } // Disable tooltips
                            },
                            elements: { line: { borderJoinStyle: 'round' } }
                        }
                    });
                } else {
                    // Not enough data, show placeholder in container
                    container.innerHTML = `<span class="text-muted" style="font-size: 0.8em;">N/A</span>`;
                }
            };

            // Helper to get most frequent latest result for Teacher/Admin (Simulation)
            const getMostFrequentLatestResult = (testKey, resultField = 'result') => {
                // FIREBASE: This logic needs to run on fetched data
                const latestResults = [];
                users.murid.forEach(murid => { // Simulation: Iterate local users
                    const result = getLatestResult(murid.nisn, testKey, resultField); // Simulation: Use NISN
                    if (result && result !== 'Belum ada' && result !== '--') {
                        const individualResults = String(result).split(',').map(r => r.trim()).filter(r => r);
                        latestResults.push(...individualResults);
                    }
                });

                if (latestResults.length === 0) return 'Belum ada data';

                const frequency = latestResults.reduce((acc, val) => { acc[val] = (acc[val] || 0) + 1; return acc; }, {});
                let maxFreq = 0; let mostFrequent = [];
                for (const result in frequency) {
                    if (frequency[result] > maxFreq) { maxFreq = frequency[result]; mostFrequent = [result]; }
                    else if (frequency[result] === maxFreq) { mostFrequent.push(result); }
                }
                return mostFrequent.sort().join(' / '); // Join ties with slash, sorted
            };


            // --- Sidebar Menu Generation ---
            const menus = {
                  murid: [
                    { section: 'dashboard-home', title: 'Dashboard', icon: 'fa-tachometer-alt' },
                    { type: 'divider', title: 'ASESMEN' }, // Section title
                    { section: 'test-literasi', title: 'Test Literasi', icon: 'fa-book-open' },
                    { section: 'test-numerasi', title: 'Test Numerasi', icon: 'fa-calculator' },
                    { section: 'test-gaya-belajar', title: 'Test Gaya Belajar', icon: 'fa-palette' },
                    { section: 'test-modalitas-belajar', title: 'Test Modalitas', icon: 'fa-brain' },
                    { section: 'test-kecerdasan-ganda', title: 'Test Kecerdasan', icon: 'fa-lightbulb' },
                    { section: 'test-ketertarikan', title: 'Test Ketertarikan', icon: 'fa-heart' },
                     { type: 'divider', title: 'AKUN' }, // Section title
                    { section: 'pengaturan', title: 'Pengaturan Akun', icon: 'fa-cog' },
                 ],
                  guru: [
                    { section: 'dashboard-home', title: 'Dashboard Guru', icon: 'fa-chalkboard-teacher' },
                     { type: 'divider', title: 'MANAJEMEN' },
                    { section: 'kelola-soal-guru', title: 'Kelola Soal', icon: 'fa-edit' },
                    { section: 'lihat-nilai', title: 'Lihat Nilai Murid', icon: 'fa-clipboard-list' },
                      { type: 'divider', title: 'AKUN' },
                    { section: 'pengaturan', title: 'Pengaturan Akun', icon: 'fa-user-cog' },
                  ],
                 admin: [
                     { section: 'dashboard-home', title: 'Dashboard Admin', icon: 'fa-user-shield' },
                      { type: 'divider', title: 'MANAJEMEN DATA' },
                     { section: 'kelola-pengguna', title: 'Kelola Pengguna', icon: 'fa-users-cog' },
                     { section: 'kelola-soal-admin', title: 'Kelola Bank Soal', icon: 'fa-database' },
                     { section: 'lihat-nilai', title: 'Lihat Nilai Murid', icon: 'fa-clipboard-check' },
                      { type: 'divider', title: 'AKUN' },
                     { section: 'pengaturan', title: 'Pengaturan Akun', icon: 'fa-cogs' },
                  ]
             };
             const generateSidebarMenu = () => {
                 if (!sidebarNav || !currentUser || !currentUser.role) { if(sidebarNav) sidebarNav.innerHTML = '<li><a href="#" class="text-danger p-3">Error memuat menu.</a></li>'; return; }
                  let menuItems = '';
                  const currentRoleMenu = menus[currentUser.role] || [];
                  if (currentRoleMenu.length === 0) { sidebarNav.innerHTML = '<li><a href="#" class="text-warning p-3">Tidak ada menu.</a></li>'; return; }

                  currentRoleMenu.forEach(item => {
                      if(item.type === 'divider') {
                          menuItems += `<li class="nav-section-title">${item.title}</li>`;
                      } else {
                          menuItems += `<li><a href="#" data-section="${item.section}" data-title="${item.title}"><i class="fas ${item.icon} fa-fw"></i><span>${item.title}</span></a></li>`;
                      }
                  });
                  sidebarNav.innerHTML = menuItems;

                 document.querySelectorAll('#sidebar-menu li a').forEach(link => {
                     link.addEventListener('click', (event) => {
                          event.preventDefault();
                          const section = link.getAttribute('data-section');
                          const title = link.getAttribute('data-title');
                           // Simple mobile menu close simulation (if implemented)
                          if (window.innerWidth <= 768 && document.querySelector('.sidebar.mobile-open')) {
                              document.querySelector('.sidebar').classList.remove('mobile-open');
                          }
                           if (section) { window.navigateTo(section, title || 'Halaman'); }
                           else { console.warn("Menu link without data-section."); }
                      });
                  });
             };


            // --- Initial Application Load & Auth State Change ---
            const initializeApp = () => {
                // FIREBASE INTEGRATION POINT: Use onAuthStateChanged to manage user state.
                fbAuth.onAuthStateChanged(async (user) => { // Make listener async
                    if (user) {
                        // User is signed in. Get their profile data from Firestore.
                        console.log("Firebase Auth User:", user.uid);
                        try {
                            const userDocRef = fbDb.collection('users').doc(user.uid);
                            const userDoc = await userDocRef.get();

                            if (userDoc.exists) {
                                currentUser = { uid: user.uid, ...userDoc.data() }; // Combine Auth UID with Firestore data
                                // Check if user is active
                                if (currentUser.status === 'aktif') {
                                    console.log("Current User Data:", currentUser);
                                    showDashboard();
                                } else {
                                    // User exists but is inactive
                                    console.warn("User is inactive:", currentUser.uid);
                                    await fbAuth.signOut(); // Sign out inactive user
                                    showLogin();
                                    showNotification("Akun Anda tidak aktif. Silakan hubungi administrator.", "warning", 5000);
                                }
                            } else {
                                // User exists in Auth but not in Firestore (error state)
                                console.error("User data not found in Firestore for UID:", user.uid);
                                await fbAuth.signOut(); // Sign out inconsistent user
                                showLogin();
                                showNotification("Data profil Anda tidak ditemukan. Hubungi support.", "danger", 5000);
                            }
                        } catch (error) {
                            console.error("Error fetching user profile:", error);
                            await fbAuth.signOut(); // Sign out on error
                            showLogin();
                            showNotification("Gagal memuat data profil Anda.", "danger", 5000);
                        }
                    } else {
                        // User is signed out.
                        console.log("No Firebase user signed in.");
                        currentUser = null;
                        sessionStorage.removeItem('loggedInUser'); // Clear any simulation data
                        showLogin();
                    }
                });

                // --- Fallback Simulation (Remove when Firebase Auth is fully trusted) ---
                // const loggedInUserString = sessionStorage.getItem('loggedInUser');
                // if (loggedInUserString) {
                //     try {
                //         currentUser = JSON.parse(loggedInUserString);
                //         if (currentUser && currentUser.role && currentUser.status === 'aktif') {
                //             showDashboard();
                //         } else {
                //              sessionStorage.removeItem('loggedInUser'); showLogin();
                //              if (currentUser && currentUser.status === 'nonaktif') { showNotification("Akun Anda tidak aktif.", "warning", 5000); }
                //              else { showNotification("Sesi tidak valid.", "warning", 5000); }
                //         }
                //     } catch (e) { console.error("Error parsing user data:", e); sessionStorage.removeItem('loggedInUser'); showLogin(); showNotification("Error memuat sesi.", "danger", 5000); }
                // } else { showLogin(); }
                // --- End Fallback Simulation ---
            };

            initializeApp(); // Run the app initialization

        }); // End DOMContentLoaded

        // --- END OF JAVASCRIPT ---
    </script>

</body>
</html>
