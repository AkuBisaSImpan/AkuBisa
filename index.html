<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aku Bisa Simpan</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- SheetJS (js-xlsx) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="sha512-r22gChDnGvCbJn9FGk+bAUzA2nVctVpVbAU4BF0VRZMyBdFmNjUzzZJqzEkV1vrPOQtrwBqL9WCHljLzYJtM0A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Firebase SDKs (v8 - Namespaced) -->
    <!-- Firebase App (Required) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Firebase Storage (Optional, but needed for profile pics) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <!-- Firebase Analytics (Optional) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
    <!-- END Firebase SDKs -->


    <style>
        /* --- START OF CSS --- */

        /* --- Variabel Warna & Dasar --- */
        :root {
            --primary-color: #0d6efd; /* Updated Bootstrap 5 Blue */
            --primary-dark: #0b5ed7;
            --primary-light: #cfe2ff;
            --secondary-color: #6c757d;
            --secondary-dark: #5c636a;
            --secondary-light: #e2e6ea; /* Added light secondary */
            --light-color: #f8f9fa;
            --dark-color: #212529; /* Updated Bootstrap 5 Dark */
            --success-color: #198754; /* Updated Bootstrap 5 Green */
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #0dcaf0; /* Updated Bootstrap 5 Teal */
            --text-color: #495057;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --body-bg: #f0f2f5; /* Slightly grayer background */
            --card-bg: #ffffff;

            --sidebar-bg: #212529; /* Darker Sidebar */
            --sidebar-link-color: #adb5bd;
            --sidebar-link-hover-bg: rgba(255, 255, 255, 0.05);
            --sidebar-link-hover-color: #ffffff;
            --sidebar-link-active-bg: var(--primary-color);
            --sidebar-link-active-color: #ffffff;
            --sidebar-header-border: rgba(255, 255, 255, 0.1);

            --font-family-base: 'Poppins', sans-serif;
            --box-shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            --box-shadow-lg: 0 1rem 3rem rgba(0, 0, 0, 0.175);
            --border-radius: 0.375rem;
            --border-radius-lg: 0.5rem;

            --spacer: 1rem; /* Base spacer unit */
        }

        /* --- Reset & Global Styles --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; font-size: 16px; } /* Base font size */
        body {
            font-family: var(--font-family-base);
            background-color: var(--body-bg);
            color: var(--text-color);
            line-height: 1.6;
            font-size: 1rem;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        body.login-view { display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, var(--primary-light), var(--light-color)); }
        a { color: var(--primary-color); text-decoration: none; transition: color 0.2s ease, opacity 0.2s ease; }
        a:hover { color: var(--primary-dark); text-decoration: none; opacity: 0.85; }
        img { max-width: 100%; height: auto; vertical-align: middle; }
        hr { border: 0; height: 1px; background-color: var(--border-color); margin: calc(var(--spacer) * 1.5) 0; }

        /* --- Utility Classes --- */
        .text-muted { color: var(--text-muted) !important; }
        .text-center { text-align: center; }
        .text-end { text-align: end; }
        .mt-1 { margin-top: calc(var(--spacer) * 0.25) !important; }
        .mt-2 { margin-top: calc(var(--spacer) * 0.5) !important; }
        .mt-3 { margin-top: var(--spacer) !important; }
        .mt-4 { margin-top: calc(var(--spacer) * 1.5) !important; }
        .mb-1 { margin-bottom: calc(var(--spacer) * 0.25) !important; }
        .mb-2 { margin-bottom: calc(var(--spacer) * 0.5) !important; }
        .mb-3 { margin-bottom: var(--spacer) !important; }
        .mb-4 { margin-bottom: calc(var(--spacer) * 1.5) !important; }
        .p-1 { padding: calc(var(--spacer) * 0.25) !important; }
        .p-2 { padding: calc(var(--spacer) * 0.5) !important; }
        .p-3 { padding: var(--spacer) !important; }
        .p-4 { padding: calc(var(--spacer) * 1.5) !important; }
        .d-block { display: block !important; }
        .d-flex { display: flex !important; }
        .align-items-center { align-items: center !important; }
        .justify-content-between { justify-content: space-between !important; }
        .justify-content-center { justify-content: center !important; }
        .justify-content-end { justify-content: flex-end !important; }
        .flex-grow-1 { flex-grow: 1 !important; }
        .hidden { display: none !important; }
        .w-100 { width: 100% !important; }
        .visually-hidden { position: absolute !important; width: 1px !important; height: 1px !important; padding: 0 !important; margin: -1px !important; overflow: hidden !important; clip: rect(0, 0, 0, 0) !important; white-space: nowrap !important; border: 0 !important; }

        .row { display: flex; flex-wrap: wrap; margin-left: -10px; margin-right: -10px; }
        .col, .col-md-3, .col-md-4, .col-md-6, .col-md-8, .col-md-12 { padding-left: 10px; padding-right: 10px; width: 100%; margin-bottom: var(--spacer); }
        @media (min-width: 768px) {
            .col-md-3 { flex: 0 0 auto; width: 25%; }
            .col-md-4 { flex: 0 0 auto; width: 33.3333%; }
            .col-md-6 { flex: 0 0 auto; width: 50%; }
            .col-md-8 { flex: 0 0 auto; width: 66.6667%; }
            .col-md-12 { flex: 0 0 auto; width: 100%; }
            .col, .col-md-3, .col-md-4, .col-md-6, .col-md-8, .col-md-12 { margin-bottom: 0; }
        }
        @media (min-width: 992px) { /* Example LG breakpoint */
             .col-lg-2 { flex: 0 0 auto; width: 16.6667%; padding-left: 10px; padding-right: 10px; }
             .col-lg-3 { flex: 0 0 auto; width: 25%; padding-left: 10px; padding-right: 10px; } /* Added col-lg-3 */
             .col-lg-4 { flex: 0 0 auto; width: 33.3333%; padding-left: 10px; padding-right: 10px; } /* Added col-lg-4 */
             .col-lg-6 { flex: 0 0 auto; width: 50%; padding-left: 10px; padding-right: 10px; } /* Added col-lg-6 */
             .col-lg-10 { flex: 0 0 auto; width: 83.3333%; padding-left: 10px; padding-right: 10px; }
             .offset-lg-1 { margin-left: 8.333333%; } /* Added offset */
        }

        /* --- Tombol (Button) Styles --- */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.4rem; font-weight: 500; color: #fff; text-align: center; vertical-align: middle; cursor: pointer; user-select: none; background-color: transparent; border: 1px solid transparent; padding: 0.5rem 1rem; font-size: 0.95rem; line-height: 1.5; border-radius: var(--border-radius); transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out, transform .1s ease; }
        .btn:hover { text-decoration: none; transform: translateY(-1px); box-shadow: var(--box-shadow-sm); }
        .btn:focus, .btn:active { outline: 0; box-shadow: var(--box-shadow-sm); }
        .btn:active { transform: translateY(0); box-shadow: none; }
        .btn i.fas, .btn i.fa-solid { line-height: 1; } /* Ensure icon vertical alignment */
        .btn:disabled, .btn.disabled { cursor: not-allowed; opacity: 0.65; box-shadow: none; transform: none; }
        .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
        .btn-primary:hover { background-color: var(--primary-dark); border-color: var(--primary-dark); }
        .btn-secondary { background-color: var(--secondary-color); border-color: var(--secondary-color); color: #fff; }
        .btn-secondary:hover { background-color: var(--secondary-dark); border-color: var(--secondary-dark); }
        .btn-success { background-color: var(--success-color); border-color: var(--success-color); }
        .btn-success:hover { background-color: #157347; border-color: #146c43; }
        .btn-danger { background-color: var(--danger-color); border-color: var(--danger-color); }
        .btn-danger:hover { background-color: #bb2d3b; border-color: #b02a37; }
        .btn-warning { background-color: var(--warning-color); border-color: var(--warning-color); color: var(--dark-color); }
        .btn-warning:hover { background-color: #ffca2c; border-color: #ffc720; }
        .btn-info { background-color: var(--info-color); border-color: var(--info-color); color: var(--dark-color); }
        .btn-info:hover { background-color: #31d2f2; border-color: #25cff2; }
        .btn-block { display: flex; width: 100%; }
        .btn-sm { padding: .3rem .6rem; font-size: .875rem; border-radius: .25rem; gap: 0.3rem;}
        .btn-lg { padding: .75rem 1.5rem; font-size: 1.1rem; border-radius: var(--border-radius-lg); }
        .btn-outline-secondary { color: var(--secondary-color); border-color: var(--secondary-color); }
        .btn-outline-secondary:hover { color: #fff; background-color: var(--secondary-color); border-color: var(--secondary-color); }
        .btn-action { margin: 0 .15rem; padding: 0.25rem 0.5rem; font-size: 0.8rem; } /* Spacing and sizing for action buttons in table */
        .btn-link { font-weight: 400; color: var(--primary-color); text-decoration: underline; background: none; border: none; padding: 0; }
        .btn-link:hover { color: var(--primary-dark); text-decoration: underline; }

        /* Button Spinner */
        .btn .spinner-border-sm { width: 1rem; height: 1rem; border-width: .2em; }

        /* --- Form Styles --- */
        .form-group { margin-bottom: calc(var(--spacer) * 1.25); }
        .form-label, .form-group label { display: inline-block; margin-bottom: .5rem; font-weight: 500; color: var(--text-color); font-size: 0.9rem; }
        .form-group label i, .form-label i { margin-right: .4rem; color: var(--secondary-color); width: 1em; text-align: center; font-size: 0.9em; }
        .form-control, .form-select, .form-group select, .form-group textarea { display: block; width: 100%; padding: .65rem .9rem; font-size: .95rem; font-weight: 400; line-height: 1.5; color: var(--text-color); background-color: var(--card-bg); background-clip: padding-box; border: 1px solid #ced4da; appearance: none; border-radius: var(--border-radius); transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out; }
        .form-control:focus, .form-select:focus, .form-group select:focus, .form-group textarea:focus { color: var(--text-color); background-color: var(--card-bg); border-color: #86b7fe; outline: 0; box-shadow: 0 0 0 .25rem rgba(13,110,253,.25); }
        .form-control[disabled], .form-control[readonly], .form-select[disabled] { background-color: #e9ecef; opacity: 1; cursor: not-allowed; }
        textarea.form-control { min-height: 100px; resize: vertical; }
        .form-select, .form-group select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right .9rem center; background-size: 16px 12px; padding-right: 2.5rem; }
        .form-check { display: block; position: relative; padding-left: 1.75rem; margin-bottom: .75rem; }
        .form-check-input { position: absolute; margin-top: .25em; margin-left: -1.75rem; }
        .form-check-label { margin-bottom: 0; font-weight: 400; cursor: pointer; }
        .form-check-input[type=radio] { border-radius: 50%; }
        .form-check-input:checked { background-color: var(--primary-color); border-color: var(--primary-color); }
        .form-check-input:checked[type=radio] { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='2' fill='%23fff'/%3e%3c/svg%3e"); }
        .form-text { margin-top: .25rem; font-size: .875em; color: var(--text-muted); }
        /* Validation Styles */
        .form-control.is-invalid, .form-select.is-invalid, .was-validated .form-control:invalid, .was-validated .form-select:invalid { border-color: var(--danger-color) !important; padding-right: calc(1.5em + .75rem); background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right calc(.375em + .1875rem) center; background-size: calc(.75em + .375rem) calc(.75em + .375rem); }
        .form-control.is-invalid:focus, .form-select.is-invalid:focus, .was-validated .form-control:invalid:focus, .was-validated .form-select:invalid:focus { border-color: var(--danger-color) !important; box-shadow: 0 0 0 .25rem rgba(220, 53, 69, .25) !important; }
        .invalid-feedback { display: none; width: 100%; margin-top: .25rem; font-size: .875em; color: var(--danger-color); }
        .was-validated .form-control:invalid ~ .invalid-feedback, .was-validated .form-select:invalid ~ .invalid-feedback,
        .form-control.is-invalid ~ .invalid-feedback, .form-select.is-invalid ~ .invalid-feedback { display: block; } /* Ensure feedback shows */


        /* --- Alert Styles --- */
        .alert { position: relative; padding: var(--spacer) var(--spacer); margin-bottom: var(--spacer); border: 1px solid transparent; border-radius: var(--border-radius); display: flex; align-items: flex-start; /* Align icon top */ gap: 0.75rem;}
        .alert i.fas { font-size: 1.2rem; line-height: 1.6; /* Match text line-height */ margin-top: 0.1rem; /* Align icon better */ flex-shrink: 0; }
        .alert-heading { color: inherit; margin-top: 0; margin-bottom: .5rem; font-weight: 500; font-size: 1.1rem;}
        .alert-success { color: #0a3622; background-color: #d1e7dd; border-color: #a3cfbb; } .alert-success i { color: #157347;}
        .alert-danger { color: #58151c; background-color: #f8d7da; border-color: #f1aeb5; } .alert-danger i { color: #bb2d3b; }
        .alert-warning { color: #664d03; background-color: #fff3cd; border-color: #ffe69c; } .alert-warning i { color: #ffca2c; }
        .alert-info { color: #055160; background-color: #cff4fc; border-color: #9eeaf9; } .alert-info i { color: #31d2f2; }
        .alert-dismissible { padding-right: 3rem; }
        .alert-dismissible .btn-close { position: absolute; top: 0; right: 0; z-index: 2; padding: 1.25rem 1rem; background: none; border: none; font-size: 1.2rem; opacity: 0.7; cursor: pointer;}
        .alert-dismissible .btn-close:hover { opacity: 1; } /* Bootstrap 5 style */
        .fade { transition: opacity .15s linear; }
        .show { opacity: 1; }

        /* Notification Container */
        #notification-container { position: fixed; top: 1rem; right: 1rem; z-index: 1060; max-width: 350px; }
        #notification-container .alert { box-shadow: var(--box-shadow); }

        /* --- Halaman Login --- */
        .login-wrapper { width: 100%; max-width: 450px; padding: var(--spacer); }
        .login-container { padding: calc(var(--spacer) * 2); background-color: var(--card-bg); border-radius: var(--border-radius-lg); box-shadow: var(--box-shadow-lg); text-align: center; }
        .logo-placeholder { font-size: 1.75rem; font-weight: 700; color: var(--primary-color); margin-bottom: calc(var(--spacer) * 1.5); display: flex; align-items: center; justify-content: center; gap: 0.75rem; }
        .login-container h2 { margin-bottom: .5rem; color: var(--dark-color); font-size: 1.75rem; font-weight: 600; }
        .login-container p { margin-bottom: calc(var(--spacer) * 2); color: var(--text-muted); font-size: 1rem; }
        .error-message { text-align: left; color: #58151c; margin-top: var(--spacer); font-size: 0.9em; font-weight: 500; min-height: 1.2em; display: none; background-color: #f8d7da; border: 1px solid #f1aeb5; padding: .75rem 1rem; border-radius: var(--border-radius); }
        .error-message.show { display: block; }
        .login-container .form-group { text-align: left; } /* Align labels left */

        /* --- Halaman Dashboard --- */
        .dashboard-container { display: flex; min-height: 100vh; width: 100%; }

        /* --- Sidebar --- */
        .sidebar { width: 260px; background-color: var(--sidebar-bg); color: var(--sidebar-link-color); padding: 0; display: flex; flex-direction: column; flex-shrink: 0; box-shadow: var(--box-shadow-sm); position: fixed; left: 0; top: 0; bottom: 0; overflow-y: auto; z-index: 1030; /* Higher z-index */ transition: width 0.3s ease, transform 0.3s ease; }
        .sidebar-header { padding: 1.1rem 1.5rem; border-bottom: 1px solid var(--sidebar-header-border); display: flex; align-items: center; flex-shrink: 0; }
        .sidebar-header .logo-placeholder { font-size: 1.25rem; color: #fff; margin: 0; gap: 0.6rem; font-weight: 600; display: flex; align-items: center;} /* Ensure flex alignment */
        .sidebar nav { flex-grow: 1; padding: 1rem 0; }
        .sidebar nav ul { list-style: none; padding: 0; margin: 0; }
        .sidebar nav ul li a { display: flex; align-items: center; gap: 0.8rem; padding: .75rem 1.5rem; color: var(--sidebar-link-color); text-decoration: none; transition: background-color 0.2s ease, color 0.2s ease, border-left-color 0.2s ease; font-size: 0.95rem; font-weight: 400; border-left: 4px solid transparent; margin: .1rem 0; }
        .sidebar nav ul li a i.fas { font-size: 1rem; width: 1.3em; text-align: center; }
        .sidebar nav ul li a:hover { background-color: var(--sidebar-link-hover-bg); color: var(--sidebar-link-hover-color); border-left-color: var(--secondary-color); text-decoration: none; }
        .sidebar nav ul li a.active { background-color: var(--sidebar-link-active-bg); color: var(--sidebar-link-active-color); border-left-color: var(--light-color); font-weight: 500; }
        .sidebar nav ul li a.active i { color: inherit; }
        .sidebar nav ul li.nav-section-title { padding: 0.5rem 1.5rem; margin-top: 1rem; font-size: 0.8rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .logout-button { margin: 1rem 1.5rem; }

        /* --- Content Area --- */
        .content-area { flex-grow: 1; background-color: var(--body-bg); padding: 0; display: flex; flex-direction: column; margin-left: 260px; min-height: 100vh; transition: margin-left 0.3s ease; }

        /* --- Content Header --- */
        .content-header { background-color: var(--card-bg); padding: .8rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; box-shadow: var(--box-shadow-sm); position: sticky; top: 0; z-index: 1020; /* Above content, below sidebar */}
        .header-title h1 { font-size: 1.5rem; color: var(--dark-color); margin: 0; font-weight: 600; line-height: 1.2; }
        .user-info { display: flex; align-items: center; gap: 0.75rem;}
        .user-info span { font-size: 0.95rem; color: var(--text-muted); font-weight: 500; text-align: right; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color); }

        /* --- Main Content --- */
        #main-content { padding: calc(var(--spacer) * 1.5); flex-grow: 1; overflow-y: auto; }

        /* --- Card Styles --- */
        .card { background-color: var(--card-bg); border: none; border-radius: var(--border-radius-lg); margin-bottom: calc(var(--spacer) * 1.5); box-shadow: var(--box-shadow-sm); overflow: visible; /* Allow potential dropdowns to overflow */}
        .card-header { padding: 1rem 1.5rem; margin-bottom: 0; background-color: transparent; border-bottom: 1px solid var(--border-color); font-weight: 600; font-size: 1.1rem; color: var(--dark-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        .card-header-title { flex-grow: 1; font-size: 1.1rem; font-weight: 600; margin: 0;}
        .card-header-actions { display: flex; gap: 0.5rem; align-items: center; }
        .card-body { padding: 1.5rem; }
        .card-footer { padding: 1rem 1.5rem; background-color: transparent; border-top: 1px solid var(--border-color); }
        .card-body h2 { margin-top: 0; margin-bottom: calc(var(--spacer) * 1.5); font-size: 1.4rem; font-weight: 600; color: var(--primary-dark); }
        .card-body h3 { margin-top: 0; margin-bottom: var(--spacer); font-size: 1.2rem; font-weight: 600; color: var(--dark-color); }
        .card-body h3.card-subtitle { margin-top: 1.5rem; margin-bottom: .75rem; font-size: 1.1rem; font-weight: 600; color: var(--secondary-color); }
        .card-body p:last-child { margin-bottom: 0; }

        /* Specific Card Styles */
        .welcome-card { border-left: 5px solid var(--primary-color); background: linear-gradient(120deg, var(--primary-light), var(--card-bg));}
        .summary-card .card-header { background-color: #f0f2f5; }
        .score-summary-list { list-style: none; padding: 0; }
        .score-summary-list li { display: flex; align-items: center; padding: .85rem 0; border-bottom: 1px solid var(--border-color); font-size: 1rem; }
        .score-summary-list li:last-child { border-bottom: none; }
        .score-summary-list li i { font-size: 1.3rem; margin-right: var(--spacer); width: 1.5em; text-align: center; color: var(--primary-color); }
        .score-summary-list li .icon-literasi { color: #1e90ff; } /* Dodger Blue */
        .score-summary-list li .icon-numerasi { color: #32cd32; } /* Lime Green */
        .score-summary-list li span { flex-grow: 1; color: var(--text-muted); }
        .score-summary-list li strong { font-weight: 600; color: var(--dark-color); margin-left: auto; /* Push score to the right */}
        .score-summary-list li .sparkline-container { width: 80px; height: 30px; margin-left: 1rem; } /* Sparkline container */
        .sparkline-canvas { max-width: 100%; max-height: 100%; display: block; } /* Sparkline canvas */

        /* Student Psychometry List */
        .psychometry-summary-list { list-style: none; padding: 0; }
        .psychometry-summary-list li { display: flex; align-items: center; padding: .75rem 0; border-bottom: 1px dashed var(--border-color); font-size: 0.95rem; }
        .psychometry-summary-list li:last-child { border-bottom: none; }
        .psychometry-summary-list li i { font-size: 1.1rem; margin-right: 0.75rem; width: 1.5em; text-align: center; color: var(--secondary-color); }
        .psychometry-summary-list li span { flex-grow: 1; color: var(--text-muted); }
        .psychometry-summary-list li strong { font-weight: 500; color: var(--dark-color); margin-left: auto; }

        .quick-actions .card-body { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacer); }
        .test-actions .card-body { display: flex; gap: var(--spacer); flex-wrap: wrap; align-items: center; justify-content: center; padding: calc(var(--spacer) * 2); }
        .test-actions .btn { padding: 0.75rem 1.5rem; font-size: 1rem; }
        .history-section-card .card-body h2 { margin-bottom: 1rem; }

        /* Teacher/Admin Dashboard Specific */
        .summary-box { background-color: var(--card-bg); border-radius: var(--border-radius); padding: 1.5rem; text-align: center; box-shadow: var(--box-shadow-sm); border: 1px solid var(--border-color); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .summary-box:hover { transform: translateY(-3px); box-shadow: var(--box-shadow); }
        .summary-box .count { font-size: 2.25rem; font-weight: 700; color: var(--primary-color); display: block; margin-bottom: .25rem; line-height: 1.2; }
        .summary-box .label { font-size: .9rem; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em;}
        .chart-container { position: relative; height: 250px; width: 100%; margin: 0 auto; } /* Fixed height */
        .chart-placeholder { display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); font-style: italic; background-color: var(--light-color); border-radius: var(--border-radius); padding: 1rem; text-align: center; }
        .psychometry-summary-admin { list-style: none; padding: 0; margin: 0; }
        .psychometry-summary-admin li { display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; padding: 0.5rem 0; border-bottom: 1px dashed var(--border-color); }
        .psychometry-summary-admin li:last-child { border-bottom: none; }
        .psychometry-summary-admin span { color: var(--text-muted); }
        .psychometry-summary-admin strong { color: var(--dark-color); font-weight: 500; }

        /* --- Table Styles --- */
        .table-responsive { overflow-x: auto; border: 1px solid var(--border-color); border-radius: var(--border-radius); }
        .data-table { width: 100%; border-collapse: collapse; background-color: var(--card-bg); font-size: 0.9rem; margin-bottom: 0; /* Remove bottom margin as it's handled by table-responsive */}
        .data-table th, .data-table td { border: none; border-bottom: 1px solid var(--border-color); padding: 1rem 1.25rem; text-align: left; vertical-align: middle; }
        .data-table thead th { background-color: #f8f9fa; font-weight: 600; color: var(--secondary-color); font-size: 0.8rem; text-transform: uppercase; white-space: nowrap; border-bottom-width: 2px; border-bottom-color: var(--border-color); }
        .data-table tbody tr:last-child td { border-bottom: none; }
        /* .data-table tbody tr:nth-child(even) { background-color: rgba(0,0,0,.02); } */
        .data-table tbody tr:hover { background-color: #f1f3f5; /* Subtle hover */ }
        .data-table .actions-cell { white-space: nowrap; text-align: center; width: 1%; } /* Minimal width for actions */
        .data-table .status-badge { padding: 0.25em 0.6em; font-size: 75%; font-weight: 700; line-height: 1; color: #fff; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: var(--border-radius); }
        .data-table .status-aktif { background-color: var(--success-color); }
        .data-table .status-nonaktif { background-color: var(--danger-color); }
        .data-table .question-text-cell { max-width: 350px; white-space: normal; } /* Allow wrapping */
        .student-score-card .card-body h3 { font-size: 1.1rem; margin-bottom: 0.75rem; color: var(--primary-dark); }
        .student-score-card .table-responsive { margin-bottom: 1rem; margin-top: 0.5rem;}

        /* --- Settings Form --- */
        .settings-card .card-body h2 { margin-bottom: calc(var(--spacer) * 1.5); }
        .settings-form h4 { margin-top: 1.5rem; margin-bottom: 1rem; color: var(--primary-color); font-size: 1.1rem; font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: .5rem; display: flex; align-items: center; gap: 0.5rem;}
        .profile-pic-preview { width: 150px; height: 150px; border-radius: 50%; border: 4px solid var(--card-bg); box-shadow: var(--box-shadow); margin: 0 auto 1rem auto; object-fit: cover; display: block; background-color: #e9ecef; }
        .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .upload-btn { width: auto; }
        .upload-btn-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer;}
        #settings-message .alert { margin-bottom: 0; }

        /* --- Loader Styles --- */
        .loader-container { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 200px; color: var(--text-muted); gap: 1rem;}
        .loader { border: 5px solid #e9ecef; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .loader-small { border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid #fff; border-radius: 50%; width: 1rem; height: 1rem; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner-border { display: inline-block; width: 2rem; height: 2rem; vertical-align: -0.125em; border: .25em solid currentColor; border-right-color: transparent; border-radius: 50%; animation: .75s linear infinite spin; }
        .spinner-border-sm { width: 1rem; height: 1rem; border-width: .2em; }

        /* --- Modal Styles --- */
        .modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; outline: 0; background-color: rgba(0,0,0,0.5); animation: fadeIn 0.3s ease-out; }
        .modal.show { display: block; }
        .modal-dialog { position: relative; width: auto; margin: .5rem; pointer-events: none; display: flex; align-items: center; min-height: calc(100% - 1rem); max-width: 600px; } /* Centering */
        @media (min-width: 576px) { .modal-dialog { max-width: 500px; margin: 1.75rem auto; min-height: calc(100% - 3.5rem); } }
        @media (min-width: 768px) { .modal-dialog { max-width: 600px; } }
        @media (min-width: 992px) { .modal-dialog { max-width: 800px; } } /* Wider modals for user/question management */
        .modal-content { position: relative; display: flex; flex-direction: column; width: 100%; pointer-events: auto; background-color: var(--card-bg); background-clip: padding-box; border: 1px solid rgba(0,0,0,.2); border-radius: var(--border-radius-lg); outline: 0; box-shadow: var(--box-shadow-lg); }
        .modal-header { display: flex; flex-shrink: 0; align-items: center; justify-content: space-between; padding: var(--spacer) calc(var(--spacer) * 1.5); border-bottom: 1px solid var(--border-color); border-top-left-radius: calc(var(--border-radius-lg) - 1px); border-top-right-radius: calc(var(--border-radius-lg) - 1px); }
        .modal-title { margin-bottom: 0; line-height: 1.5; font-size: 1.25rem; font-weight: 600; color: var(--dark-color); }
        .modal-close-btn { padding: 1rem 1rem; margin: -1rem -1rem -1rem auto; background: transparent; border: 0; font-size: 1.5rem; font-weight: 700; line-height: 1; color: #000; text-shadow: 0 1px 0 #fff; opacity: .5; cursor: pointer;}
        .modal-close-btn:hover { opacity: .75; }
        .modal-body { position: relative; flex: 1 1 auto; padding: calc(var(--spacer) * 1.5); max-height: 70vh; overflow-y: auto; }
        .modal-footer { display: flex; flex-wrap: wrap; flex-shrink: 0; align-items: center; justify-content: flex-end; padding: calc(var(--spacer) * .75) calc(var(--spacer) * 1.5); border-top: 1px solid var(--border-color); border-bottom-right-radius: calc(var(--border-radius-lg) - 1px); border-bottom-left-radius: calc(var(--border-radius-lg) - 1px); gap: .5rem; }
        .modal-body .form-group:last-child { margin-bottom: 0; }
        .modal-body .row { margin-left: -5px; margin-right: -5px; } /* Tighter grid spacing in modal */
        .modal-body .col, .modal-body .col-md-6 { padding-left: 5px; padding-right: 5px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Tab Styles --- */
        .nav-tabs { display: flex; flex-wrap: wrap; list-style: none; padding-left: 0; margin-bottom: 0; border-bottom: 1px solid var(--border-color); }
        .nav-item { margin-bottom: -1px; } /* Overlap border */
        .nav-link { display: block; padding: .75rem 1.25rem; color: var(--primary-color); text-decoration: none; background: none; border: 1px solid transparent; border-top-left-radius: var(--border-radius); border-top-right-radius: var(--border-radius); cursor: pointer; font-weight: 500; transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out; }
        .nav-link:hover, .nav-link:focus { border-color: var(--light-color) var(--light-color) var(--border-color); isolation: isolate; color: var(--primary-dark); background-color: #e9ecef;}
        .nav-link.active { color: var(--dark-color); background-color: var(--card-bg); border-color: var(--border-color) var(--border-color) var(--card-bg); font-weight: 600; }
        .tab-content { padding: calc(var(--spacer) * 1.5) 0 0 0; } /* No padding on sides, rely on card padding */

        /* --- Test Interface Styles --- */
        .test-container { background-color: var(--card-bg); padding: calc(var(--spacer) * 2); border-radius: var(--border-radius-lg); box-shadow: var(--box-shadow); margin-bottom: calc(var(--spacer)*1.5); }
        .test-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: var(--spacer); margin-bottom: calc(var(--spacer) * 1.5); padding-bottom: var(--spacer); border-bottom: 1px solid var(--border-color); }
        .test-title { font-size: 1.5rem; font-weight: 600; color: var(--primary-dark); margin: 0; flex-grow: 1; }
        .test-progress { font-size: 1rem; font-weight: 500; color: var(--text-muted); white-space: nowrap; background-color: #e9ecef; padding: 0.3rem 0.8rem; border-radius: 50px; }
        .question-area { margin-bottom: calc(var(--spacer) * 2); }
        .question-text { font-size: 1.2rem; margin-bottom: calc(var(--spacer) * 1.5); font-weight: 500; line-height: 1.7; }
        .options-area .form-check { background-color: transparent; padding: 1rem 1.25rem 1rem 3rem; border-radius: var(--border-radius); border: 1px solid var(--border-color); margin-bottom: .75rem; transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease; cursor: pointer; position: relative; }
        .options-area .form-check:hover { background-color: var(--primary-light); border-color: var(--primary-color); }
        .options-area .form-check-input { position: absolute; left: 1.25rem; top: 50%; transform: translateY(-50%) scale(1.2); margin: 0; cursor: pointer;}
        .options-area .form-check-input:checked + .form-check-label::before { /* Optional: Custom check style */ }
        .options-area .form-check-input:checked ~ .form-check-label { font-weight: 600; color: var(--primary-dark); }
        .options-area .form-check:has(input:checked) { border-color: var(--primary-color); background-color: var(--primary-light); box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);}
        .options-area .form-check-label { font-weight: 500; cursor: pointer; margin: 0; width: 100%;}
        .test-navigation { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: var(--spacer); margin-top: calc(var(--spacer) * 2); padding-top: calc(var(--spacer) * 1.5); border-top: 1px solid var(--border-color); }
        .test-result-container { text-align: center; }
        .test-result-container .result-icon { font-size: 4rem; margin-bottom: 1rem; }
        .test-result-container .result-icon.success { color: var(--success-color); }
        .test-result-container .result-icon.info { color: var(--info-color); }
        .test-result-container h2 { font-size: 2rem; margin-bottom: .5rem; font-weight: 600; }
        .test-result-container .score-display { font-size: 3.5rem; font-weight: 700; color: var(--primary-color); margin-bottom: 0.5rem; line-height: 1; }
        .test-result-container .score-detail { font-size: 1rem; color: var(--text-muted); margin-bottom: 1.5rem; }
        .test-result-container p.result-text { font-size: 1.1rem; color: var(--dark-color); margin-bottom: 1.5rem; font-weight: 500; }
        .test-result-container p.result-note { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 2rem; }
        .test-result-container .btn { margin-top: 1rem; }

        /* --- Logo Styling --- */
        .logo-image {
            height: 35px; /* Default height */
            width: auto;
            object-fit: contain; /* Ensure logo isn't distorted */
        }
        .login-container .logo-placeholder .logo-image {
            height: 45px; /* Slightly larger for login */
        }
        .sidebar-header .logo-placeholder {
            gap: 0.6rem; /* Ensure gap is appropriate */
            align-items: center;
        }
        .sidebar-header .logo-placeholder .logo-image {
             height: 30px; /* Adjust if needed for sidebar */
        }


        /* --- Responsiveness Overrides --- */
        @media (max-width: 992px) {
            .sidebar { width: 240px; } /* Slightly wider for medium */
            .content-area { margin-left: 240px; }
            .summary-box .count { font-size: 2rem; }
            .modal-dialog { max-width: 90%; }
        }
        @media (max-width: 768px) {
            /* Mobile Sidebar - Top Nav */
            body.dashboard-view { padding-top: 60px; } /* Space for fixed top nav */
            .sidebar { position: fixed; top: 0; left: 0; right: 0; width: 100%; height: 60px; box-shadow: var(--box-shadow-sm); border-bottom: 1px solid var(--border-color); overflow: visible; z-index: 1031; flex-direction: row; background-color: var(--sidebar-bg); /* Use dark bg */}
            .sidebar-header { padding: 0 1rem; border: none; width: auto; }
            .sidebar-header .logo-placeholder { font-size: 1.1rem;}
            .sidebar-header .logo-placeholder .logo-image { height: 30px; } /* Adjust logo size for mobile top nav */
            .sidebar nav { flex-grow: 1; padding: 0; overflow-x: auto; overflow-y: hidden; height: 60px; display: flex; align-items: center;}
            .sidebar nav ul { display: flex; height: 100%; white-space: nowrap; -ms-overflow-style: none; scrollbar-width: none; padding: 0 0.5rem; }
            .sidebar nav ul::-webkit-scrollbar { display: none; }
            .sidebar nav ul li { height: 100%; display: flex; align-items: center;}
            .sidebar nav ul li a { padding: 0 1rem; height: 100%; border-left: none; border-bottom: 4px solid transparent; margin: 0; display: flex; align-items: center; font-weight: 500;}
            .sidebar nav ul li a i.fas { width: auto; margin-right: .4rem; font-size: 1rem; }
            .sidebar nav ul li a:hover { background: none; color: var(--light-color); border-bottom-color: var(--secondary-light); }
            .sidebar nav ul li a.active { background: none; color: #fff; border-bottom-color: var(--primary-color); border-left-color: transparent; }
            .sidebar nav ul li.nav-section-title { display: none; } /* Hide section titles on mobile nav */
            .logout-button { display: none; } /* Needs relocating or hamburger menu */

            /* Mobile Content */
            .content-area { margin-left: 0; margin-top: 0; /* Removed top margin if sidebar was static */ }
            .content-header { padding: .75rem 1rem; display: none; /* Hide header on mobile, info might go in sidebar */ }
            #main-content { padding: 1rem; }
            .card-body h2 { font-size: 1.3rem; }
            .login-container { padding: 1.5rem; box-shadow: var(--box-shadow); }
            .profile-pic-preview { width: 120px; height: 120px; }
            .test-actions .card-body { flex-direction: column; align-items: stretch; }
            .test-actions .btn { width: 100%; }
            .chart-container { height: 280px; } /* Taller charts */
            .modal-dialog { margin: 10px auto; max-width: calc(100% - 20px); }
            .modal-body { max-height: 75vh; }
            .data-table { font-size: 0.85rem; }
            .data-table th, .data-table td { padding: 0.75rem 0.8rem; }
            .data-table .actions-cell { white-space: normal; text-align: left; } /* Allow actions to wrap */
            .data-table .actions-cell .btn-action { margin-right: .25rem; margin-bottom: .25rem; display: inline-flex; }
            .card-header { flex-direction: column; align-items: flex-start; }
            .card-header-actions { margin-top: 0.75rem; width: 100%; justify-content: flex-start; }
            .nav-tabs { /* Ensure tabs scroll */ overflow-x: auto; white-space: nowrap; flex-wrap: nowrap; -webkit-overflow-scrolling: touch; -ms-overflow-style: none; scrollbar-width: none; }
            .nav-tabs::-webkit-scrollbar { display: none; }
            .nav-link { padding: .6rem .8rem; font-size: .9rem; }
            .test-container { padding: 1rem; }
            .test-header { flex-direction: column; align-items: flex-start; }
            .test-progress { margin-top: .5rem; align-self: flex-start;}
            .question-text { font-size: 1.1rem; }
            .options-area .form-check { padding-left: 2.75rem; }
            .options-area .form-check-input { left: 1rem; }
            .test-navigation { flex-direction: column; gap: 0.75rem; }
            .test-navigation .btn { width: 100%; font-size: 1rem; padding: 0.75rem;}
            .score-summary-list li .sparkline-container { display: none; } /* Hide sparklines on mobile */
            .psychometry-summary-list li { flex-direction: column; align-items: flex-start; gap: 0.25rem; } /* Stack psychometry results */
            .psychometry-summary-list li strong { margin-left: 0; }
        }

        /* --- END OF CSS --- */
    </style>
</head>
<body>

    <!-- Login Section -->
    <div id="login-section">
         <div class="login-wrapper">
            <div class="login-container">
                <div class="logo-placeholder">
                    <img src="logo.png" alt="Aku Bisa Simpan Logo" class="logo-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                    <span style="display: none;">Aku Bisa Simpan</span> <!-- Fallback text -->
                </div>
                <h2>Selamat Datang</h2>
                <p>Silakan login untuk mengakses fitur belajar.</p>

                <form id="login-form" novalidate> <!-- Added novalidate -->
                    <div class="form-group mb-3">
                        <label for="role" class="form-label"><i class="fas fa-user-tag"></i> Login sebagai</label>
                        <select id="role" name="role" class="form-select" required>
                            <option value="murid">Murid</option>
                            <option value="guru">Guru</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label for="username" class="form-label"><i class="fas fa-user"></i> NISN / Username</label>
                        <input type="text" id="username" name="username" class="form-control" placeholder="Masukkan NISN atau Username Anda" required>
                        <div class="invalid-feedback">NISN/Username wajib diisi.</div> <!-- Added feedback -->
                    </div>
                    <div class="form-group mb-4">
                        <label for="password" class="form-label"><i class="fas fa-lock"></i> Password</label>
                        <input type="password" id="password" name="password" class="form-control" placeholder="Masukkan Password Anda" required>
                         <div class="invalid-feedback">Password wajib diisi.</div> <!-- Added feedback -->
                    </div>
                    <button type="submit" id="login-submit-btn" class="btn btn-primary btn-lg btn-block" data-original-text="Login"> <!-- Added data-original-text -->
                        <span class="spinner-border spinner-border-sm hidden" role="status" aria-hidden="true"></span> <!-- Added spinner -->
                        <span class="button-text">Login <i class="fas fa-sign-in-alt"></i></span>
                    </button>
                    <div id="error-message" class="error-message mt-3"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Dashboard Section (Initially Hidden) -->
    <div id="dashboard-section" class="hidden">
         <div class="dashboard-container">
            <aside class="sidebar">
                <div class="sidebar-header">
                     <div class="logo-placeholder">
                        <img src="logo.png" alt="App Logo" class="logo-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                        <span style="display: none;">Aku Bisa Simpan</span> <!-- Fallback text -->
                    </div>
                </div>
                <nav>
                    <ul id="sidebar-menu">
                        <li class="p-3 text-center"><div class="spinner-border spinner-border-sm text-light" role="status"> <span class="visually-hidden">Memuat menu...</span></div></li>
                    </ul>
                </nav>
                <button id="logout-button" class="btn btn-danger logout-button mb-3 mx-3">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </aside>

            <main class="content-area">
                <header class="content-header">
                    <div class="header-title">
                         <h1 id="page-title">Dashboard</h1>
                    </div>
                    <div class="user-info">
                        <span id="user-name">Nama Pengguna</span>
                        <img id="user-avatar" src="assets/default-profile.png" alt="Avatar" class="user-avatar" onerror="this.src='assets/default-profile.png';">
                    </div>
                </header>
                <section id="main-content">
                     <div class="loader-container">
                        <div class="loader"></div>
                        <p>Memuat konten...</p>
                     </div>
                </section>
            </main>
        </div>
    </div>

    <!-- User Management Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="user-form" novalidate>
                    <div class="modal-header">
                        <h5 class="modal-title" id="user-modal-title">Tambah Pengguna</h5>
                        <button type="button" class="modal-close-btn" onclick="closeModal('user-modal')" aria-label="Close">×</button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="user-edit-identifier" value=""> <!-- Stores Firestore ID/UID -->
                        <div id="user-modal-error" class="alert alert-danger hidden"><i class="fas fa-exclamation-triangle"></i><span>Error placeholder</span></div>
                        <div class="row">
                            <div class="col-md-6"> <div class="form-group"> <label for="user-nama" class="form-label">Nama Lengkap <span class="text-danger">*</span></label> <input type="text" id="user-nama" class="form-control" required> <div class="invalid-feedback">Nama lengkap wajib diisi.</div></div> </div>
                            <div class="col-md-6"> <div class="form-group"> <label for="user-role" class="form-label">Role <span class="text-danger">*</span></label> <select id="user-role" class="form-select" required onchange="toggleUserFormFields()"> <option value="guru">Guru</option> <option value="murid">Murid</option> <option value="admin">Admin</option> </select> <div class="invalid-feedback">Role wajib dipilih.</div></div> </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6"> <div class="form-group" id="user-identifier-group"> <label for="user-identifier" id="user-identifier-label" class="form-label">Username <span class="text-danger">*</span></label> <input type="text" id="user-identifier" class="form-control" required> <div class="invalid-feedback">Username/NISN wajib diisi.</div></div> </div>
                            <div class="col-md-6"> <div class="form-group"> <label for="user-status" class="form-label">Status <span class="text-danger">*</span></label> <select id="user-status" class="form-select" required> <option value="aktif">Aktif</option> <option value="nonaktif">Nonaktif</option> </select> <div class="invalid-feedback">Status wajib dipilih.</div></div> </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6"> <div class="form-group"> <label for="user-password" class="form-label">Password <span id="password-required-indicator" class="text-danger">*</span></label> <input type="password" id="user-password" class="form-control" placeholder="Kosongkan jika tidak diubah" minlength="6"> <small id="password-help" class="form-text"></small> <div class="invalid-feedback">Password minimal 6 karakter.</div></div> </div>
                            <div class="col-md-6"> <div class="form-group"> <label for="user-confirm-password" class="form-label">Konfirmasi Password <span id="confirm-password-required-indicator" class="text-danger">*</span></label> <input type="password" id="user-confirm-password" class="form-control"> <div class="invalid-feedback">Konfirmasi password tidak cocok.</div></div> </div>
                        </div>
                        <div id="murid-fields" class="hidden"> <hr> <h6 class="text-muted">Data Tambahan Murid (Opsional)</h6> <div class="row"> <div class="col-md-6"> <div class="form-group"> <label for="user-parentName" class="form-label">Nama Ortu/Wali</label> <input type="text" id="user-parentName" class="form-control"> </div> </div> <div class="col-md-6"> <div class="form-group"> <label for="user-address" class="form-label">Alamat</label> <textarea id="user-address" class="form-control" rows="2"></textarea> </div> </div> </div> </div>
                    </div>
                    <div class="modal-footer"> <button type="button" class="btn btn-secondary" onclick="closeModal('user-modal')">Batal</button> <button type="submit" class="btn btn-primary" id="user-modal-save-btn" data-original-text="Simpan"><i class="fas fa-save"></i> <span class="button-text">Simpan</span></button> </div> <!-- Added data-original-text -->
                </form>
            </div>
        </div>
    </div>

    <!-- Question Management Modal -->
    <div id="question-modal" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="question-form" novalidate>
                    <div class="modal-header">
                        <h5 class="modal-title" id="question-modal-title">Tambah Soal</h5>
                        <button type="button" class="modal-close-btn" onclick="closeModal('question-modal')" aria-label="Close">×</button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="question-edit-id" value=""> <!-- Stores Firestore Doc ID -->
                        <input type="hidden" id="question-bank-key" value="">
                        <div id="question-modal-error" class="alert alert-danger hidden"><i class="fas fa-exclamation-triangle"></i><span>Error placeholder</span></div>

                        <div class="form-group mb-3">
                            <label for="question-text" class="form-label">Teks Pertanyaan <span class="text-danger">*</span></label>
                            <textarea id="question-text" class="form-control" rows="3" required></textarea>
                             <div class="invalid-feedback">Teks pertanyaan wajib diisi.</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6"> <div class="form-group mb-3"> <label for="question-option-a" class="form-label">Opsi A <span class="text-danger">*</span></label> <input type="text" id="question-option-a" class="form-control" required> <div class="invalid-feedback">Opsi A wajib diisi.</div></div> </div>
                            <div class="col-md-6"> <div class="form-group mb-3"> <label for="question-option-b" class="form-label">Opsi B <span class="text-danger">*</span></label> <input type="text" id="question-option-b" class="form-control" required> <div class="invalid-feedback">Opsi B wajib diisi.</div></div> </div>
                        </div>
                         <div class="row">
                            <div class="col-md-6"> <div class="form-group mb-3"> <label for="question-option-c" class="form-label">Opsi C <span class="text-danger">*</span></label> <input type="text" id="question-option-c" class="form-control" required> <div class="invalid-feedback">Opsi C wajib diisi.</div></div> </div>
                            <div class="col-md-6"> <div class="form-group mb-3" id="question-option-d-group"> <label for="question-option-d" class="form-label">Opsi D <span class="text-danger">*</span></label> <input type="text" id="question-option-d" class="form-control" required> <div class="invalid-feedback">Opsi D wajib diisi.</div></div> </div>
                        </div>
                         <div class="form-group mb-3" id="question-answer-group">
                            <label for="question-answer" class="form-label">Jawaban Benar <span class="text-danger">*</span></label>
                            <select id="question-answer" class="form-select" required>
                                <option value="" disabled selected>-- Pilih Jawaban --</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                            </select>
                             <div class="invalid-feedback">Jawaban benar wajib dipilih.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('question-modal')">Batal</button>
                        <button type="submit" class="btn btn-primary" id="question-modal-save-btn" data-original-text="Simpan Soal"><i class="fas fa-save"></i> <span class="button-text">Simpan Soal</span></button> <!-- Added data-original-text -->
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>


    <script>
        // --- START OF JAVASCRIPT ---

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyATAcg8vL_ZtgvPImi42y0rMPtW47alTGM", // Replace with your API key
          authDomain: "akubisasimpan-20a7e.firebaseapp.com", // e.g., save-eduapp.firebaseapp.com
          projectId: "akubisasimpan-20a7e", // e.g., save-eduapp
          storageBucket: "akubisasimpan-20a7e.firebasestorage.app", // e.g., save-eduapp.appspot.com
          messagingSenderId: "897029841279",
          appId: "1:897029841279:web:f52ac01f087420da0bba4a",
          measurementId: "G-CF0V0R44Y7" // Optional
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app();
        }

        // Initialize Analytics (optional)
        try { firebase.analytics(); } catch (e) { console.warn("Firebase Analytics initialization failed:", e); }

        // Get Firebase Service Handles
        const fbAuth = firebase.auth();
        const fbDb = firebase.firestore();
        const fbStorage = firebase.storage();

        // --- IMPORTANT SECURITY NOTE ---
        // Ensure Firestore & Storage Security Rules are configured in the Firebase Console.
        // --- END SECURITY NOTE ---


        document.addEventListener('DOMContentLoaded', () => {

            // --- Global Elements & State ---
            const loginSection = document.getElementById('login-section');
            const dashboardSection = document.getElementById('dashboard-section');
            let currentUser = null; // Populated by Firebase Auth state listener
            let activeCharts = {};
            let currentActiveUserTab = 'guru'; // Default tab in user management
            let currentActiveQuestionBank = 'literasi'; // Default bank in question management
            let currentTestState = {}; // Holds state during a test
            const threeOptionTestKeys = ['gayaBelajar', 'kecerdasanGanda']; // Types needing only 3 options

            // --- UI Utility Functions ---
            const showNotification = (message, type = 'success', duration = 4000) => {
                const containerId = 'notification-container';
                let container = document.getElementById(containerId);
                if (!container) {
                    container = document.createElement('div'); container.id = containerId;
                    document.body.appendChild(container);
                }
                const alertIcon = type === 'success' ? 'fa-check-circle' : (type === 'danger' ? 'fa-exclamation-triangle' : (type === 'warning' ? 'fa-exclamation-circle' : 'fa-info-circle'));
                const alert = document.createElement('div'); alert.className = `alert alert-${type} alert-dismissible fade`;
                alert.style.boxShadow = 'var(--box-shadow)'; alert.setAttribute('role', 'alert');
                alert.innerHTML = `<i class="fas ${alertIcon}"></i> <div class="flex-grow-1">${message}</div> <button type="button" class="btn-close" aria-label="Close"></button>`;
                const closeButton = alert.querySelector('.btn-close');

                const removeAlert = () => {
                    alert.classList.remove('show'); // Trigger fade-out
                    // Listen for the transition to end BEFORE removing from DOM
                    alert.addEventListener('transitionend', () => {
                        if (alert.parentNode) { // Check if it hasn't been removed already
                            alert.remove();
                            // Optional: Remove container if empty
                            if (container && container.children.length === 0) {
                               if (document.body.contains(container)) { // Check if container still in body
                                    container.remove();
                               }
                            }
                        }
                    }, { once: true }); // Important: only fire once
                };

                closeButton.addEventListener('click', removeAlert); // Manual close
                container.appendChild(alert);

                // Trigger fade in after element is added to DOM
                requestAnimationFrame(() => {
                    alert.classList.add('show');
                });

                // Auto dismiss
                setTimeout(removeAlert, duration); // Schedule removal
            };
            window.closeModal = (modalId) => { const modal = document.getElementById(modalId); if (modal) modal.classList.remove('show'); };
            window.openModal = (modalId) => { const modal = document.getElementById(modalId); if (modal) modal.classList.add('show'); };
            const displayModalError = (modalId, message) => { const errorDiv = document.getElementById(`${modalId}-error`); if (errorDiv) { errorDiv.querySelector('span').innerHTML = message; errorDiv.classList.remove('hidden'); } };
            const clearModalError = (modalId) => { const errorDiv = document.getElementById(`${modalId}-error`); if (errorDiv) errorDiv.classList.add('hidden'); };
            const toggleButtonLoading = (buttonId, isLoading) => {
                 const button = document.getElementById(buttonId); if (!button) return;
                 const spinner = button.querySelector('.spinner-border, .spinner-border-sm'); // Select both sizes
                 const buttonTextSpan = button.querySelector('.button-text'); // Target the span

                 if (isLoading) {
                     button.disabled = true;
                     if (spinner) spinner.classList.remove('hidden');
                     if (buttonTextSpan) buttonTextSpan.textContent = 'Memproses...'; // Change only text span
                 } else {
                     button.disabled = false;
                     if (spinner) spinner.classList.add('hidden');
                     if (buttonTextSpan) {
                         // Restore original text from data attribute
                         const originalText = button.dataset.originalText || 'Submit'; // Fallback
                         const icon = button.querySelector('i.fas'); // Find icon if exists
                         buttonTextSpan.innerHTML = `${originalText} ${icon ? icon.outerHTML : ''}`; // Reconstruct content
                     }
                 }
            };
            // Enhanced Form Validation with visual feedback
            const validateForm = (formElement) => {
                formElement.classList.add('was-validated'); // Trigger Bootstrap styles
                let isValid = true;
                const fields = formElement.querySelectorAll('input[required], select[required], textarea[required]');

                fields.forEach(field => {
                    // Reset custom invalid state if previously set by JS
                    field.classList.remove('is-invalid');
                    let fieldValid = true;

                    if (!field.value || (field.type === 'select-one' && field.value === "")) {
                        fieldValid = false;
                    } else if (field.type === 'password') {
                        // Only validate password fields if they are required OR have a value (for optional changes)
                        if (field.required || field.value) {
                            if (field.id === 'user-password' && field.value.length < 6) {
                                fieldValid = false;
                                const feedback = field.closest('.form-group').querySelector('.invalid-feedback');
                                if (feedback) feedback.textContent = 'Password minimal 6 karakter.';
                            } else if (field.id === 'user-confirm-password') {
                                const passwordField = document.getElementById('user-password');
                                if (passwordField && passwordField.value !== field.value) {
                                    fieldValid = false;
                                    const feedback = field.closest('.form-group').querySelector('.invalid-feedback');
                                    if (feedback) feedback.textContent = 'Konfirmasi password tidak cocok.';
                                }
                            }
                        }
                    } else if (field.type === 'number' && field.id === 'user-identifier' && !/^\d+$/.test(field.value)) {
                        fieldValid = false;
                        const feedback = field.closest('.form-group').querySelector('.invalid-feedback');
                        if (feedback) feedback.textContent = 'NISN harus berupa angka.';
                    } else if (field.validity && !field.validity.valid) {
                        // Catch other native HTML5 validation errors if any (e.g., pattern)
                        fieldValid = false;
                    }

                    if (!fieldValid) {
                        isValid = false;
                        field.classList.add('is-invalid'); // Explicitly add class for JS checks if needed
                    }
                });
                return isValid;
            };

            // --- View Management Functions ---
            const showLogin = () => { loginSection.classList.remove('hidden'); dashboardSection.classList.add('hidden'); document.body.classList.add('login-view'); document.body.classList.remove('dashboard-view'); destroyActiveCharts(); };
            const showDashboard = () => { loginSection.classList.add('hidden'); dashboardSection.classList.remove('hidden'); document.body.classList.remove('login-view'); document.body.classList.add('dashboard-view'); initializeDashboard(); };

            // --- Login Logic (Firebase Integrated) ---
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', async (event) => { // Make async
                    event.preventDefault();
                    const submitButton = document.getElementById('login-submit-btn');
                    const role = document.getElementById('role').value;
                    const identifier = document.getElementById('username').value.trim(); // NISN or Username
                    const password = document.getElementById('password').value;
                    const errorMsgDiv = document.getElementById('error-message');
                    errorMsgDiv.classList.remove('show');
                    loginForm.classList.remove('was-validated'); // Reset validation state

                    // Basic JS validation first
                    if (!identifier || !password) {
                        if (!identifier) document.getElementById('username').classList.add('is-invalid');
                        if (!password) document.getElementById('password').classList.add('is-invalid');
                        errorMsgDiv.textContent = 'NISN/Username dan Password wajib diisi.';
                        errorMsgDiv.classList.add('show');
                        return;
                    }
                    document.getElementById('username').classList.remove('is-invalid');
                    document.getElementById('password').classList.remove('is-invalid');

                    toggleButtonLoading(submitButton.id, true);

                    // Construct dummy email for Firebase Auth
                    // IMPORTANT: Ensure this domain matches what you use for user creation
                    const email = `${identifier}@akubisasimpan-20a7e.firebaseapp.com`;

                    try {
                        // Sign in with Firebase Auth
                        const userCredential = await fbAuth.signInWithEmailAndPassword(email, password);
                        console.log("Firebase Auth successful for:", userCredential.user.uid);
                        // Auth state listener (initializeApp) will handle fetching profile and showing dashboard
                        // No need to call showDashboard() here directly.
                        // Button loading state will be reset implicitly when view changes or on error.

                    } catch (error) {
                        console.error("Firebase Login Error:", error);
                        let message = 'Login gagal. Terjadi kesalahan tidak terduga.';
                        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                            message = 'NISN/Username atau Password salah.';
                        } else if (error.code === 'auth/invalid-email') {
                            message = 'Format NISN/Username tidak valid untuk login.';
                        } else if (error.code === 'auth/too-many-requests') {
                            message = 'Terlalu banyak percobaan login. Coba lagi nanti.';
                        } else if (error.message) {
                            // Avoid showing overly technical messages directly
                            message = `Login gagal. Silakan periksa kembali data Anda.`;
                            console.error("Detailed Firebase Error:", error.message); // Log detail for debugging
                        }
                        errorMsgDiv.textContent = message;
                        errorMsgDiv.classList.add('show');
                        toggleButtonLoading(submitButton.id, false);
                    }
                });
            } else { console.error("Login form not found!"); }

            // --- Dashboard Logic ---
            let mainContent, pageTitle, userNameDisplay, userAvatar, sidebarNav, logoutButton;
            const initializeDashboard = () => {
                mainContent = document.getElementById('main-content'); pageTitle = document.getElementById('page-title'); userNameDisplay = document.getElementById('user-name'); userAvatar = document.getElementById('user-avatar'); sidebarNav = document.getElementById('sidebar-menu'); logoutButton = document.getElementById('logout-button');
                if (!mainContent || !pageTitle || !userNameDisplay || !userAvatar || !sidebarNav || !logoutButton) { console.error("Dashboard elements missing!"); if (dashboardSection) dashboardSection.innerHTML = '<div class="alert alert-danger m-5">Error memuat elemen dashboard.</div>'; return; }

                // currentUser is populated by the onAuthStateChanged listener
                if (!currentUser) { console.error("InitializeDashboard called without currentUser!"); return; }

                userNameDisplay.textContent = currentUser.name || 'Pengguna';
                userAvatar.src = currentUser.profilePic || 'assets/default-profile.png';
                userAvatar.onerror = () => { userAvatar.src = 'assets/default-profile.png'; };

                generateSidebarMenu();
                // Find the first menu item that has a 'section' property
                const initialMenuItem = (menus[currentUser.role] || []).find(item => item.section);
                const initialSection = initialMenuItem?.section || 'dashboard-home';
                const initialTitle = initialMenuItem?.title || 'Dashboard';
                loadContent(initialSection, initialTitle); // Load initial content
                logoutButton.removeEventListener('click', handleLogout); logoutButton.addEventListener('click', handleLogout);
            };
            const handleLogout = () => {
                if (confirm("Apakah Anda yakin ingin keluar?")) {
                    fbAuth.signOut().then(() => {
                        console.log("User signed out successfully.");
                        // Auth state listener will automatically call showLogin()
                    }).catch((error) => {
                        console.error("Sign out error:", error);
                        showNotification("Gagal logout.", "danger");
                    });
                }
             };

            // --- Chart Management ---
            const destroyActiveCharts = () => { Object.values(activeCharts).forEach(chart => { if (chart && typeof chart.destroy === 'function') { chart.destroy(); } }); activeCharts = {}; };

            // --- Content Loading ---
            const showLoading = (containerId = 'main-content') => { const container = document.getElementById(containerId); if (container) { container.innerHTML = `<div class="loader-container p-5"><div class="loader"></div><p>Memuat konten...</p></div>`; } };
            const loadContent = async (section, title, isHistoryView = false) => { // Make async
                if (!mainContent || !pageTitle || !currentUser) return;
                destroyActiveCharts(); showLoading(); pageTitle.textContent = title;
                const originalSectionForHighlight = isHistoryView ? section.replace('-history', '') : section;
                document.querySelectorAll('#sidebar-menu li a').forEach(link => link.classList.remove('active'));
                const activeLink = document.querySelector(`#sidebar-menu li a[data-section="${originalSectionForHighlight}"]`);
                if (activeLink) activeLink.classList.add('active');

                // No artificial delay needed with async Firebase calls
                mainContent.innerHTML = ''; // Clear loading immediately

                try {
                    if (isHistoryView && section.endsWith('-history')) {
                        const originalSection = section.replace('-history', ''); const parts = originalSection.split('-');
                        if (parts.length >= 2 && parts[0] === 'test') {
                            const dataKey = parts.slice(1).join('-');
                            const originalMenuItem = menus.murid.find(m => m.section === originalSection);
                            const originalTitle = originalMenuItem?.title.replace('Test ','') || title.replace('Riwayat Test ', '');
                            const isScoredTest = dataKeyRequiresScore(dataKey);
                            await loadTestHistory(originalSection, dataKey, originalTitle, isScoredTest); // Await history loading
                        } else { mainContent.innerHTML = '<div class="alert alert-warning">Tidak dapat memuat riwayat untuk bagian ini.</div>'; }
                        return;
                    }

                    // Route to the correct content loader function (use await for async loaders)
                    switch (section) {
                        case 'dashboard-home':
                            if (currentUser.role === 'murid') await loadStudentDashboardHome();
                            else if (currentUser.role === 'guru') await loadTeacherDashboardHome();
                            else if (currentUser.role === 'admin') await loadAdminDashboardHome();
                            break;
                        case 'pengaturan': await loadSettings(); break;
                        // Student Test Sections
                        case 'test-literasi': loadTestSection(section, 'literasi', 'Literasi'); break;
                        case 'test-numerasi': loadTestSection(section, 'numerasi', 'Numerasi'); break;
                        case 'test-gaya-belajar': loadTestSection(section, 'gayaBelajar', 'Gaya Belajar'); break;
                        case 'test-modalitas-belajar': loadTestSection(section, 'modalitasBelajar', 'Modalitas Belajar'); break;
                        case 'test-kecerdasan-ganda': loadTestSection(section, 'kecerdasanGanda', 'Kecerdasan Ganda'); break;
                        case 'test-ketertarikan': loadTestSection(section, 'ketertarikan', 'Ketertarikan'); break;
                        // Guru/Admin Sections
                        case 'kelola-soal-guru':
                        case 'kelola-soal-admin': await loadKelolaSoal(); break;
                        case 'lihat-nilai': await loadLihatNilai(); break;
                        case 'kelola-pengguna': await loadKelolaPengguna(); break; // Admin only
                        default: mainContent.innerHTML = `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Konten untuk "${title}" (${section}) tidak ditemukan atau belum diimplementasikan.</div>`;
                    }
                } catch (error) {
                    console.error(`Error loading content "${section}":`, error);
                    mainContent.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Terjadi kesalahan saat memuat konten. Silakan coba lagi atau hubungi support.</div>';
                }
            };

            // --- Specific Content Loaders (Firebase Integrated) ---

            // Student Dashboard & Tests
            const loadStudentDashboardHome = async () => { // Make async
                 if (!currentUser || !currentUser.uid) { mainContent.innerHTML = `<div class="alert alert-danger">Error: Data pengguna tidak valid.</div>`; return; }
                 showLoading();
                 let studentData = { highestScores: {} }; // Default structure
                 let literasiHistoryData = [];
                 let numerasiHistoryData = [];
                 let latestPsychometry = { gayaBelajar: 'Belum ada', modalitasBelajar: 'Belum ada', kecerdasanGanda: 'Belum ada', ketertarikan: 'Belum ada' };

                 try {
                     // Fetch main user data (includes highest scores)
                     const userDocRef = fbDb.collection('users').doc(currentUser.uid);
                     const userDoc = await userDocRef.get();
                     if (userDoc.exists) {
                         studentData = { ...userDoc.data() }; // Get all data including highestScores
                     } else {
                         console.warn("Student document not found in Firestore:", currentUser.uid);
                     }

                     // Fetch latest psychometry results (limit 1, order by date desc)
                     const fetchLatestResult = async (testKey) => {
                         try {
                             const testHistoryCollectionRef = userDocRef.collection('testHistory');
                             const testDocRef = testHistoryCollectionRef.doc(testKey);
                             const testDocSnap = await testDocRef.get();
                             if (!testDocSnap.exists) return 'Belum ada';
                             const resultsRef = testDocRef.collection('results').orderBy('date', 'desc').limit(1);
                             const snapshot = await resultsRef.get();
                             return snapshot.empty ? 'Belum ada' : snapshot.docs[0].data().result || '--';
                         } catch (fetchError) {
                             console.error(`Error fetching latest result for ${testKey}:`, fetchError);
                             return 'Error'; // Indicate fetch error
                         }
                     };

                     latestPsychometry.gayaBelajar = await fetchLatestResult('gayaBelajar');
                     latestPsychometry.modalitasBelajar = await fetchLatestResult('modalitasBelajar');
                     latestPsychometry.kecerdasanGanda = await fetchLatestResult('kecerdasanGanda');
                     latestPsychometry.ketertarikan = await fetchLatestResult('ketertarikan');

                     // Fetch score history for sparklines (limit last 10 for performance)
                     const fetchScoreHistory = async (testKey) => {
                         try {
                             const testHistoryCollectionRef = userDocRef.collection('testHistory');
                             const testDocRef = testHistoryCollectionRef.doc(testKey);
                             const testDocSnap = await testDocRef.get();
                             if (!testDocSnap.exists) return [];
                             const resultsRef = testDocRef.collection('results').orderBy('date', 'asc').limitToLast(10); // Asc for trend, limit for perf
                             const snapshot = await resultsRef.get();
                             return snapshot.docs.map(doc => doc.data().score).filter(score => score !== null && score !== undefined);
                         } catch (fetchError) {
                             console.error(`Error fetching score history for ${testKey}:`, fetchError);
                             return []; // Return empty on error
                         }
                     };
                     literasiHistoryData = await fetchScoreHistory('literasi');
                     numerasiHistoryData = await fetchScoreHistory('numerasi');

                     const scores = studentData.highestScores || {}; // Ensure highestScores exists

                     mainContent.innerHTML = `
                        <div class="card welcome-card mb-4"> <div class="card-body p-4"> <h2 class="mb-1">Selamat Datang, ${currentUser.name}!</h2> <p class="text-muted mb-0">Berikut adalah ringkasan hasil test terbaikmu sejauh ini.</p> </div> </div>
                        <div class="row">
                            <div class="col-lg-6 mb-4"> <div class="card summary-card h-100"> <div class="card-header"><span class="card-header-title">Skor Tertinggi & Tren</span></div> <div class="card-body"> <ul class="score-summary-list"> <li> <i class="fas fa-book-open icon-literasi"></i> <span>Test Literasi</span> <div class="sparkline-container" id="literasi-sparkline-container"> <canvas id="literasi-sparkline"></canvas> </div> <strong>${scores.literasi ?? '--'}</strong> </li> <li> <i class="fas fa-calculator icon-numerasi"></i> <span>Test Numerasi</span> <div class="sparkline-container" id="numerasi-sparkline-container"> <canvas id="numerasi-sparkline"></canvas> </div> <strong>${scores.numerasi ?? '--'}</strong> </li> </ul> </div> </div> </div>
                            <div class="col-lg-6 mb-4"> <div class="card h-100"> <div class="card-header"><span class="card-header-title">Hasil Psikometri Terbaru</span></div> <div class="card-body"> <ul class="psychometry-summary-list"> <li><i class="fas fa-palette"></i><span>Gaya Belajar</span><strong>${latestPsychometry.gayaBelajar}</strong></li> <li><i class="fas fa-brain"></i><span>Modalitas Belajar</span><strong>${latestPsychometry.modalitasBelajar}</strong></li> <li><i class="fas fa-lightbulb"></i><span>Kecerdasan Ganda</span><strong>${latestPsychometry.kecerdasanGanda}</strong></li> <li><i class="fas fa-heart"></i><span>Ketertarikan</span><strong>${latestPsychometry.ketertarikan}</strong></li> </ul> </div> </div> </div>
                        </div>
                        <div class="row"> <div class="col-12"> <div class="card quick-actions"> <div class="card-header"><span class="card-header-title">Mulai Test Baru</span></div> <div class="card-body"> <button class="btn btn-outline-secondary" onclick="window.navigateTo('test-literasi', 'Test Literasi')"><i class="fas fa-pen"></i> Test Literasi</button> <button class="btn btn-outline-secondary" onclick="window.navigateTo('test-numerasi', 'Test Numerasi')"><i class="fas fa-calculator"></i> Test Numerasi</button> <button class="btn btn-outline-secondary" onclick="window.navigateTo('test-gaya-belajar', 'Test Gaya Belajar')"><i class="fas fa-palette"></i> Test Gaya Belajar</button> <button class="btn btn-outline-secondary" onclick="window.navigateTo('test-modalitas-belajar', 'Test Modalitas Belajar')"><i class="fas fa-brain"></i> Test Modalitas</button> <button class="btn btn-outline-secondary" onclick="window.navigateTo('test-kecerdasan-ganda', 'Test Kecerdasan Ganda')"><i class="fas fa-lightbulb"></i> Test Kecerdasan</button> <button class="btn btn-outline-secondary" onclick="window.navigateTo('test-ketertarikan', 'Test Ketertarikan')"><i class="fas fa-heart"></i> Test Ketertarikan</button> </div> </div> </div> </div>
                        `;

                     // Render Sparklines after HTML is in the DOM
                     renderSparkline('literasi-sparkline', literasiHistoryData, 'Skor Literasi');
                     renderSparkline('numerasi-sparkline', numerasiHistoryData, 'Skor Numerasi');

                 } catch (error) {
                     console.error("Error loading student dashboard:", error);
                     mainContent.innerHTML = `<div class="alert alert-danger">Gagal memuat data dashboard: ${error.message}</div>`;
                 }
            };
            const loadTestSection = (section, dataKey, title) => { // No async needed here, just renders buttons
                  if (currentUser.role !== 'murid') { mainContent.innerHTML = `<div class="alert alert-warning">Menu ini hanya untuk murid.</div>`; return; }
                  const instructions = testInstructions[dataKey] || `Klik tombol "Mulai Test" untuk mengerjakan soal ${title}. Hasil test akan direkam. Anda juga dapat melihat riwayat pengerjaan sebelumnya.`;
                  mainContent.innerHTML = `
                      <div class="card test-section-card mb-4"> <div class="card-body p-4"> <h2>Test ${title}</h2> <p class="text-muted mb-0">${instructions}</p> </div> </div>
                      <div class="card test-actions"> <div class="card-body"> <button class="btn btn-success btn-lg start-test-btn" onclick="confirmStartTest('${dataKey}', '${title}')"> <i class="fas fa-play-circle"></i> Mulai Test ${title} </button> <button class="btn btn-outline-secondary history-test-btn" onclick="window.navigateToHistory('${section}', '${dataKey}', '${title}')"> <i class="fas fa-history"></i> Lihat Riwayat Test </button> </div> </div>`;
             };
             const testInstructions = { literasi: "Uji kemampuan Anda dalam memahami dan menggunakan bahasa tertulis.", numerasi: "Uji kemampuan Anda dalam memahami dan menggunakan konsep matematika dasar.", gayaBelajar: "Identifikasi gaya belajar yang paling efektif untuk Anda (Visual, Auditori, Kinestetik).", modalitasBelajar: "Temukan preferensi modalitas Anda dalam menerima dan mengolah informasi.", kecerdasanGanda: "Kenali potensi kecerdasan majemuk yang dominan pada diri Anda.", ketertarikan: "Jelajahi minat dan ketertarikan Anda terhadap berbagai bidang." };
            const loadTestHistory = async (originalSection, dataKey, title, hasScore) => { // Make async
                  if (currentUser.role !== 'murid' || !currentUser.uid) { mainContent.innerHTML = `<div class="alert alert-warning">Riwayat hanya tersedia untuk murid.</div>`; return; }
                  showLoading();
                  let history = [];
                  try {
                      const testHistoryCollectionRef = fbDb.collection('users').doc(currentUser.uid).collection('testHistory');
                      const testDocRef = testHistoryCollectionRef.doc(dataKey);
                      const testDocSnap = await testDocRef.get();
                      if (!testDocSnap.exists) {
                          console.log(`No history document found for test key: ${dataKey}`);
                          history = []; // Ensure history is empty array
                      } else {
                          const historyRef = testDocRef.collection('results').orderBy('date', 'desc');
                          const snapshot = await historyRef.get();
                          history = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                      }
                  } catch (error) {
                      console.error(`Error fetching history for ${dataKey}:`, error);
                      mainContent.innerHTML = `<div class="alert alert-danger">Gagal memuat riwayat test: ${error.message}</div>`;
                      return;
                  }

                  let historyTableHtml = '<p class="text-muted mt-3 text-center">Belum ada riwayat test untuk kategori ini.</p>';
                  if (history.length > 0) {
                      historyTableHtml = `<div class="table-responsive"><table class="data-table history-table"><thead><tr><th>Tanggal Pengerjaan</th><th>${hasScore ? 'Skor' : 'Hasil Dominan'}</th></tr></thead><tbody>`;
                      history.forEach(item => { // Already sorted by query
                          const displayValue = hasScore ? (item.score ?? '-') : (item.result ?? '-');
                          const dateValue = item.date?.toDate ? item.date.toDate() : new Date(); // Handle Timestamp or default
                          const formattedDate = dateValue.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                          historyTableHtml += `<tr><td>${formattedDate}</td><td>${displayValue}</td></tr>`;
                      });
                      historyTableHtml += '</tbody></table></div>';
                  }

                  mainContent.innerHTML = `
                      <div class="card history-section-card"> <div class="card-header"> <h2 class="card-header-title mb-0">Riwayat Test ${title}</h2> </div> <div class="card-body"> <button class="btn btn-secondary btn-sm mb-3" onclick="window.navigateTo('${originalSection}', 'Test ${title}')"> <i class="fas fa-arrow-left"></i> Kembali ke Halaman Test </button> ${historyTableHtml} </div> </div>`;
            };

            // Test Interface (Firebase Integrated)
            const loadTestInterface = async (testKey, testTitle) => { // Make async
                showLoading();
                let questions = [];
                try {
                    const bankDocRef = fbDb.collection('questionBanks').doc(testKey);
                    const bankDocSnap = await bankDocRef.get();

                    if (!bankDocSnap.exists) {
                        console.log(`Question bank document '${testKey}' does not exist.`);
                        questions = []; // Treat as empty bank
                    } else {
                        const questionsRef = bankDocRef.collection('questions');
                        const snapshot = await questionsRef.get();
                        questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    }
                } catch (error) {
                    console.error(`Error fetching questions for ${testKey}:`, error);
                    mainContent.innerHTML = `<div class="alert alert-danger">Gagal memuat soal: ${error.message}</div>`;
                    return;
                }

                if (questions.length === 0) {
                    mainContent.innerHTML = `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Soal untuk test ${testTitle} belum tersedia.</div> <button class="btn btn-secondary mt-3" onclick="window.navigateTo('dashboard-home', 'Dashboard')"><i class="fas fa-arrow-left"></i> Kembali</button>`;
                    return;
                }
                // Shuffle questions for variety
                const shuffledQuestions = [...questions].sort(() => Math.random() - 0.5);
                currentTestState = { testKey: testKey, testTitle: testTitle, questions: shuffledQuestions, currentIndex: 0, answers: {} };
                if (pageTitle) pageTitle.textContent = `Mengerjakan Test: ${testTitle}`;

                mainContent.innerHTML = `
                    <div class="test-container"> <div class="test-header"> <h3 class="test-title">${testTitle}</h3> <span class="test-progress badge bg-secondary" id="test-progress-indicator">Soal 1 dari ${shuffledQuestions.length}</span> </div> <form id="test-form"> <div class="question-area" id="question-area"> <div class="text-center p-5"><div class="spinner-border text-primary"></div></div> </div> </form> <div class="test-navigation"> <button id="prev-question-btn" type="button" class="btn btn-outline-secondary" onclick="navigateTestQuestion(-1)" disabled><i class="fas fa-arrow-left"></i> Sebelumnya</button> <button id="finish-test-btn" type="button" class="btn btn-danger hidden" onclick="confirmFinishTest()" data-original-text="Selesai & Kirim"><span class="spinner-border spinner-border-sm hidden"></span><span class="button-text"><i class="fas fa-check-circle"></i> Selesai & Kirim</span></button> <button id="next-question-btn" type="button" class="btn btn-primary" onclick="navigateTestQuestion(1)">Berikutnya <i class="fas fa-arrow-right"></i></button> </div> </div>`;
                renderTestQuestion();
            };
             window.confirmStartTest = (testKey, testTitle) => { if (confirm(`Anda akan memulai ${testTitle}. Pastikan koneksi stabil. Siap?`)) { startTest(testKey, testTitle); } }
             window.confirmFinishTest = () => { if (confirm(`Yakin ingin menyelesaikan test ${currentTestState.testTitle}? Jawaban tidak dapat diubah.`)) { finishTest(); } }
            const renderTestQuestion = () => {
                const questionArea = document.getElementById('question-area'); const progressIndicator = document.getElementById('test-progress-indicator'); const prevBtn = document.getElementById('prev-question-btn'); const nextBtn = document.getElementById('next-question-btn'); const finishBtn = document.getElementById('finish-test-btn');
                if (!questionArea || !progressIndicator || !prevBtn || !nextBtn || !finishBtn || !currentTestState || !currentTestState.questions || currentTestState.questions.length === 0) { console.error("Error rendering question: Missing elements or invalid state."); mainContent.innerHTML = `<div class="alert alert-danger">Error menampilkan soal.</div>`; return; }
                const currentQuestion = currentTestState.questions[currentTestState.currentIndex]; const questionNumber = currentTestState.currentIndex + 1; const totalQuestions = currentTestState.questions.length; const currentAnswer = currentTestState.answers[currentQuestion.id];
                progressIndicator.textContent = `Soal ${questionNumber} / ${totalQuestions}`;
                let optionsHtml = ''; const isThreeOption = threeOptionTestKeys.includes(currentTestState.testKey); const numOptions = isThreeOption ? 3 : (currentQuestion.options?.length || 0);
                if (numOptions < (isThreeOption ? 3 : 4)) { console.warn(`Question ${currentQuestion.id} has fewer options than expected.`); }
                for (let i = 0; i < numOptions; i++) {
                    const optionLetter = String.fromCharCode(65 + i); const optionText = currentQuestion.options[i] || `Opsi ${optionLetter} Tdk Tersedia`; const isChecked = currentAnswer === optionLetter;
                    const sanitizedOptionText = optionText.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    optionsHtml += `<div class="form-check"> <input class="form-check-input" type="radio" name="question_${currentQuestion.id}" id="option_${optionLetter}" value="${optionLetter}" ${isChecked ? 'checked' : ''} onchange="handleAnswerSelection('${currentQuestion.id}', '${optionLetter}')"> <label class="form-check-label" for="option_${optionLetter}">${optionLetter}. ${sanitizedOptionText}</label> </div>`;
                }
                const sanitizedQuestionText = (currentQuestion.text || "Teks Pertanyaan Tdk Tersedia").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                questionArea.style.opacity = '0'; questionArea.innerHTML = `<div class="question-text">${questionNumber}. ${sanitizedQuestionText}</div><div class="options-area">${optionsHtml}</div>`;
                requestAnimationFrame(() => { questionArea.style.transition = 'opacity 0.3s ease-in-out'; questionArea.style.opacity = '1'; });
                prevBtn.disabled = currentTestState.currentIndex === 0; nextBtn.classList.toggle('hidden', questionNumber === totalQuestions); finishBtn.classList.toggle('hidden', questionNumber !== totalQuestions);
            };
            window.handleAnswerSelection = (questionId, selectedOption) => { if (currentTestState && currentTestState.answers) { currentTestState.answers[questionId] = selectedOption; } else { console.error("Cannot save answer: currentTestState invalid."); } };
            window.navigateTestQuestion = (direction) => { if (!currentTestState || !currentTestState.questions) return; const newIndex = currentTestState.currentIndex + direction; if (newIndex >= 0 && newIndex < currentTestState.questions.length) { currentTestState.currentIndex = newIndex; renderTestQuestion(); } };
            window.finishTest = async () => { // Make async
                 const finishButton = document.getElementById('finish-test-btn'); if (finishButton) toggleButtonLoading(finishButton.id, true);
                 const { testKey, testTitle, questions, answers } = currentTestState;
                 const studentUid = currentUser.uid; const totalQuestions = questions.length;
                 let correctAnswers = 0; let resultText = null; let score = 0;
                 const isScoredTest = dataKeyRequiresScore(testKey);
                 if (isScoredTest) {
                     questions.forEach(q => { if (q.answer && answers[q.id] === q.answer) { correctAnswers++; } });
                     score = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
                 } else {
                     const answerValues = Object.values(answers); const mostFrequentAnswer = answerValues.reduce((acc, val) => { acc[val] = (acc[val] || 0) + 1; return acc; }, {});
                     let dominantResult = Object.keys(mostFrequentAnswer).reduce((a, b) => mostFrequentAnswer[a] > mostFrequentAnswer[b] ? a : b, null);
                     // Example mapping - adjust based on actual test content
                     if (testKey === 'gayaBelajar') resultText = dominantResult === 'A' ? 'Visual' : dominantResult === 'B' ? 'Auditori' : 'Kinestetik';
                     else if (testKey === 'kecerdasanGanda') resultText = dominantResult === 'A' ? 'Logis-Matematis' : dominantResult === 'B' ? 'Linguistik' : 'Naturalis';
                     else if (testKey === 'modalitasBelajar') resultText = dominantResult === 'A' ? 'Visual' : dominantResult === 'B' ? 'Auditori' : 'Kinestetik'; // Assuming same as gayaBelajar for example
                     else if (testKey === 'ketertarikan') resultText = dominantResult === 'A' ? 'Sains' : dominantResult === 'B' ? 'Seni' : 'Sosial'; // Example
                     else resultText = dominantResult ? `Hasil Dominan Opsi ${dominantResult}` : "Hasil Belum Terdefinisi";
                 }
                 const newResultData = { date: firebase.firestore.FieldValue.serverTimestamp(), answers: answers };
                 if (isScoredTest) newResultData.score = score; else newResultData.result = resultText;
                 try {
                     const testDocRef = fbDb.collection('users').doc(studentUid).collection('testHistory').doc(testKey);
                     const resultColRef = testDocRef.collection('results');
                     // Ensure the parent document exists (create if not) - useful for first test
                     await testDocRef.set({ lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
                     // Add the new result to the subcollection
                     await resultColRef.add(newResultData);
                     console.log(`Test result saved for user ${studentUid}, test ${testKey}`);

                     // Update highest score if applicable using a transaction
                     if (isScoredTest) {
                         const userDocRef = fbDb.collection('users').doc(studentUid);
                         await fbDb.runTransaction(async (transaction) => {
                             const userDoc = await transaction.get(userDocRef);
                             if (!userDoc.exists) { throw "User document does not exist!"; }
                             const currentHighest = userDoc.data().highestScores?.[testKey] || 0;
                             if (score > currentHighest) {
                                 transaction.update(userDocRef, {
                                     [`highestScores.${testKey}`]: score // Use dot notation
                                 });
                                 console.log(`Highest score updated for ${testKey}`);
                             }
                         });
                     }
                     showTestResult(testKey, testTitle, score, correctAnswers, totalQuestions, isScoredTest, resultText);
                 } catch (error) { console.error("Error saving test result:", error); showNotification(`Gagal menyimpan hasil test: ${error.message}`, "danger", 5000); if (finishButton) toggleButtonLoading(finishButton.id, false); }
             };
            const showTestResult = (testKey, testTitle, score, correctAnswers, totalQuestions, isScoredTest, resultText = null) => {
                   let resultDisplay = ''; const resultIconClass = isScoredTest ? (score >= 70 ? 'success fas fa-check-circle' : 'info fas fa-info-circle') : 'info fas fa-award';
                   const iconHtml = `<i class="result-icon ${resultIconClass}"></i>`;
                   if (isScoredTest) { resultDisplay = `${iconHtml} <h2>Test ${testTitle} Selesai!</h2> <p>Hasil pengerjaan Anda:</p> <div class="score-display">${score}</div> <p class="score-detail">${correctAnswers} dari ${totalQuestions} Jawaban Benar</p> <p class="result-note">Hasil ini telah disimpan.</p>`; }
                   else { resultDisplay = `${iconHtml} <h2>Test ${testTitle} Selesai!</h2> <p>Preferensi/kecenderungan dominan Anda:</p> <p class="result-text">${resultText || 'Hasil Tdk Terdefinisi'}</p> <p class="result-note">Hasil ini bersifat indikatif dan telah disimpan.</p>`; }
                   mainContent.innerHTML = `<div class="test-result-container card"><div class="card-body p-4">${resultDisplay}<button class="btn btn-primary" onclick="window.navigateTo('dashboard-home', 'Dashboard')"><i class="fas fa-arrow-left"></i> Kembali ke Dashboard</button></div></div>`;
                   currentTestState = {}; // Clear test state
             };

            // Settings Page (Firebase Integrated)
            const loadSettings = async () => { // Make async
                if (!currentUser || !currentUser.uid) { handleLogout(); return; }
                showLoading();
                try {
                    const userDocRef = fbDb.collection('users').doc(currentUser.uid);
                    const userDoc = await userDocRef.get();
                    if (!userDoc.exists) throw new Error("Data pengguna tidak ditemukan.");
                    currentUser = { uid: currentUser.uid, ...userDoc.data() }; // Refresh currentUser with latest data
                } catch (error) {
                    console.error("Error fetching settings data:", error);
                    mainContent.innerHTML = `<div class="alert alert-danger">Gagal memuat data pengaturan: ${error.message}</div>`;
                    return;
                }
                const profilePicSrc = currentUser.profilePic || 'assets/default-profile.png';
                mainContent.innerHTML = `
                    <div class="row"> <div class="col-lg-10 offset-lg-1"> <form id="settings-form" novalidate> <div class="card settings-card"> <div class="card-header"><h2 class="card-header-title mb-0">Pengaturan Profil & Akun</h2></div> <div class="card-body"> <div id="settings-message" class="mb-3"></div> <div class="row"> <div class="col-md-4 text-center"> <img src="${profilePicSrc}" alt="Foto Profil" id="profile-pic-preview" class="profile-pic-preview" onerror="this.src='assets/default-profile.png';"> <label for="profilePic" class="btn btn-secondary btn-sm upload-btn"> <i class="fas fa-camera"></i> Ganti Foto </label> <input type="file" id="profilePic" name="profilePic" accept="image/png, image/jpeg, image/gif" style="position: absolute; left: -9999px;"> <p class="form-text mt-1">Max. 1MB (PNG, JPG, GIF)</p> </div> <div class="col-md-8"> <h4><i class="fas fa-user-edit"></i> Informasi Dasar</h4> <div class="form-group mb-3"><label for="name" class="form-label">Nama:</label><input type="text" id="name" name="name" class="form-control" value="${currentUser.name || ''}" required><div class="invalid-feedback">Nama wajib diisi.</div></div> ${currentUser.role === 'murid' ? `<div class="form-group mb-3"><label for="nisn" class="form-label">NISN:</label><input type="text" id="nisn" name="nisn" class="form-control" value="${currentUser.nisn || ''}" disabled></div> <div class="form-group mb-3"><label for="parentName" class="form-label">Nama Ortu/Wali:</label><input type="text" id="parentName" name="parentName" class="form-control" value="${currentUser.parentName || ''}"></div> <div class="form-group mb-3"><label for="address" class="form-label">Alamat:</label><textarea id="address" name="address" class="form-control" rows="3">${currentUser.address || ''}</textarea></div>` : ''} ${currentUser.role !== 'murid' ? `<div class="form-group mb-3"><label for="username" class="form-label">Username:</label><input type="text" id="username" name="username" class="form-control" value="${currentUser.username || ''}" disabled></div>` : ''} </div> </div> <hr> <h4><i class="fas fa-key"></i> Ubah Password</h4> <div class="row"> <div class="col-md-4"><div class="form-group mb-3"><label for="currentPassword" class="form-label">Password Lama:</label><input type="password" id="currentPassword" name="currentPassword" class="form-control" placeholder="Masukkan password saat ini"><div class="invalid-feedback">Password lama wajib diisi untuk ubah password.</div></div></div> <div class="col-md-4"><div class="form-group mb-3"><label for="newPassword" class="form-label">Password Baru:</label><input type="password" id="newPassword" name="newPassword" class="form-control" placeholder="Min. 6 karakter" minlength="6"><div class="invalid-feedback">Password baru min. 6 karakter.</div></div></div> <div class="col-md-4"><div class="form-group mb-3"><label for="confirmPassword" class="form-label">Konfirmasi Baru:</label><input type="password" id="confirmPassword" name="confirmPassword" class="form-control" placeholder="Ulangi password baru"><div class="invalid-feedback">Konfirmasi password tidak cocok.</div></div></div> </div> <p class="form-text">Kosongkan bagian ini jika tidak ingin mengubah password.</p> </div> <div class="card-footer text-end"> <button type="submit" id="settings-save-btn" class="btn btn-primary" data-original-text="Simpan Perubahan"><i class="fas fa-save"></i> <span class="button-text">Simpan Perubahan</span></button> </div> </div> </form> </div> </div>`; // Added data-original-text
                const settingsForm = document.getElementById('settings-form'); if (settingsForm) { settingsForm.removeEventListener('submit', handleSettingsSave); settingsForm.addEventListener('submit', handleSettingsSave); }
                const profilePicInput = document.getElementById('profilePic'); const profilePicPreview = document.getElementById('profile-pic-preview'); if (profilePicInput && profilePicPreview) { profilePicInput.removeEventListener('change', handleProfilePicChange); profilePicInput.addEventListener('change', handleProfilePicChange); }
            };
            const handleProfilePicChange = (event) => {
                 const profilePicPreview = document.getElementById('profile-pic-preview'); const file = event.target.files[0]; if (!file || !profilePicPreview) return;
                 if (!['image/png', 'image/jpeg', 'image/gif'].includes(file.type)) { displaySettingsMessage('Format gambar tidak valid (PNG, JPG, GIF).', 'warning'); event.target.value = null; return; }
                 if (file.size > 1 * 1024 * 1024) { displaySettingsMessage('Ukuran gambar maksimal 1MB.', 'warning'); event.target.value = null; return; }
                 const reader = new FileReader(); reader.onload = (e) => { profilePicPreview.src = e.target.result; }; reader.onerror = () => { displaySettingsMessage('Gagal membaca file gambar.', 'danger'); profilePicPreview.src = currentUser.profilePic || 'assets/default-profile.png'; }; reader.readAsDataURL(file);
            };
            const handleSettingsSave = async (event) => { // Make async
                 event.preventDefault(); const saveButton = document.getElementById('settings-save-btn'); const form = document.getElementById('settings-form'); toggleButtonLoading(saveButton.id, true); clearSettingsMessage(); form.classList.remove('was-validated');
                 let isValid = true; let messages = []; let focusField = null;
                 const nameInput = document.getElementById('name'); const parentNameInput = document.getElementById('parentName'); const addressInput = document.getElementById('address'); const currentPasswordInput = document.getElementById('currentPassword'); const newPasswordInput = document.getElementById('newPassword'); const confirmPasswordInput = document.getElementById('confirmPassword'); const profilePicInput = document.getElementById('profilePic');
                 const newName = nameInput.value.trim(); const newParentName = parentNameInput ? parentNameInput.value.trim() : currentUser.parentName; const newAddress = addressInput ? addressInput.value.trim() : currentUser.address; const currentPassword = currentPasswordInput.value; const newPassword = newPasswordInput.value; const confirmPassword = confirmPasswordInput.value; const profilePicFile = profilePicInput.files[0];
                 // --- Validation ---
                 nameInput.classList.remove('is-invalid'); currentPasswordInput.classList.remove('is-invalid'); newPasswordInput.classList.remove('is-invalid'); confirmPasswordInput.classList.remove('is-invalid');
                 if (!newName) { isValid = false; messages.push('Nama tidak boleh kosong.'); focusField = focusField || nameInput; nameInput.classList.add('is-invalid'); }
                 let passwordUpdateAttempted = newPassword || confirmPassword || currentPassword; let passwordChanged = false;
                 if (passwordUpdateAttempted) {
                     if (!currentPassword) { isValid = false; messages.push('Masukkan password lama untuk mengubah password.'); focusField = focusField || currentPasswordInput; currentPasswordInput.classList.add('is-invalid');}
                     else if (!newPassword || newPassword.length < 6) { isValid = false; messages.push('Password baru minimal harus 6 karakter.'); focusField = focusField || newPasswordInput; newPasswordInput.classList.add('is-invalid'); }
                     else if (newPassword !== confirmPassword) { isValid = false; messages.push('Konfirmasi password baru tidak cocok.'); focusField = focusField || confirmPasswordInput; confirmPasswordInput.classList.add('is-invalid'); }
                     else { passwordChanged = true; }
                 }
                 if (!isValid) { displaySettingsMessage(messages.join('<br>'), 'danger'); if (focusField) focusField.focus(); toggleButtonLoading(saveButton.id, false); return; }
                 // --- End Validation ---
                 try {
                     let newProfilePicUrl = currentUser.profilePic;
                     // 1. Update Password in Firebase Auth (if changed)
                     if (passwordChanged) {
                         const user = fbAuth.currentUser; if (!user) throw new Error("User not logged in.");
                         const userEmail = user.email; if (!userEmail) throw new Error("User email not available."); // Use the dummy email
                         const credential = firebase.auth.EmailAuthProvider.credential(userEmail, currentPassword);
                         await user.reauthenticateWithCredential(credential); await user.updatePassword(newPassword);
                         console.log("Firebase password updated.");
                     }
                     // 2. Upload Profile Picture to Firebase Storage (if changed)
                     if (profilePicFile) {
                         const storageRef = fbStorage.ref(); const filePath = `profilePictures/${currentUser.uid}/${Date.now()}_${profilePicFile.name}`; const fileRef = storageRef.child(filePath);
                         const uploadTask = await fileRef.put(profilePicFile); newProfilePicUrl = await uploadTask.ref.getDownloadURL();
                         console.log("Profile picture uploaded:", newProfilePicUrl);
                     }
                     // 3. Update User Data in Firestore
                     const userDocRef = fbDb.collection('users').doc(currentUser.uid); const dataToUpdate = { name: newName, profilePic: newProfilePicUrl };
                     if (currentUser.role === 'murid') { dataToUpdate.parentName = parentName; dataToUpdate.address = address; }
                     await userDocRef.update(dataToUpdate);
                     console.log("Firestore user data updated.");
                     // 4. Update Local State and UI
                     currentUser.name = newName; currentUser.profilePic = newProfilePicUrl; if (currentUser.role === 'murid') { currentUser.parentName = newParentName; currentUser.address = newAddress; }
                     if(userNameDisplay) userNameDisplay.textContent = currentUser.name; if(userAvatar) userAvatar.src = currentUser.profilePic || 'assets/default-profile.png';
                     currentPasswordInput.value = ''; newPasswordInput.value = ''; confirmPasswordInput.value = ''; profilePicInput.value = null;
                     let successMessage = 'Pengaturan berhasil disimpan!'; if (passwordChanged && profilePicFile) successMessage = 'Pengaturan, password, dan foto profil berhasil disimpan!'; else if (passwordChanged) successMessage = 'Pengaturan dan password berhasil disimpan!'; else if (profilePicFile) successMessage = 'Pengaturan dan foto profil berhasil disimpan!';
                     displaySettingsMessage(successMessage, 'success'); showNotification(successMessage, 'success');
                 } catch (error) {
                     console.error("Error saving settings:", error); let errorMessage = "Gagal menyimpan pengaturan.";
                     if (error.code === 'auth/wrong-password') { errorMessage = "Password lama yang Anda masukkan salah."; currentPasswordInput.focus(); currentPasswordInput.classList.add('is-invalid'); }
                     else if (error.code === 'auth/requires-recent-login') { errorMessage = "Sesi terlalu lama. Logout & login kembali untuk ubah password."; }
                     else if (error.code === 'storage/unauthorized') { errorMessage = "Gagal upload foto: Tidak ada izin."; }
                     else if (error.message) { errorMessage = `Gagal menyimpan: ${error.message}`; }
                     displaySettingsMessage(errorMessage, 'danger'); showNotification(errorMessage, 'danger', 5000);
                 } finally { toggleButtonLoading(saveButton.id, false); }
            };
            const displaySettingsMessage = (message, type = 'success') => {
                  const settingsMessage = document.getElementById('settings-message'); if (!settingsMessage) return;
                  const alertContent = message.includes('<br>') ? message : message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                  settingsMessage.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert"> ${alertContent} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button> </div>`;
                  const newCloseButton = settingsMessage.querySelector('.btn-close');
                  if (newCloseButton) { newCloseButton.addEventListener('click', () => { const alertDiv = newCloseButton.closest('.alert'); if (alertDiv) { alertDiv.classList.remove('show'); alertDiv.addEventListener('transitionend', () => alertDiv.remove(), { once: true }); } }); }
             };
            const clearSettingsMessage = () => { const settingsMessage = document.getElementById('settings-message'); if(settingsMessage) settingsMessage.innerHTML = ''; }

            // Teacher & Admin Dashboard (Firebase Integrated - Aggregation needed for scale)
            const loadTeacherDashboardHome = async () => { // Make async
                showLoading();
                let totalStudents = 0, totalGurus = 0, totalQuestions = 0, totalTestRecords = 0;
                let gayaBelajarAgg = {}, modalitasAgg = {}, kecerdasanAgg = {}, ketertarikanAgg = {};

                try {
                    // Fetch Counts (Example - Use getCountFromServer in v9+ or maintain counters)
                    // Note: getCountFromServer is not available in v8 SDK. This approach reads documents.
                    const usersSnapshot = await fbDb.collection('users').get();
                    usersSnapshot.forEach(doc => {
                        const role = doc.data().role;
                        if (role === 'murid') totalStudents++;
                        else if (role === 'guru' && doc.data().status === 'aktif') totalGurus++;
                    });

                    // Fetch Question Count (Example - Iterate banks)
                    const banksSnapshot = await fbDb.collection('questionBanks').get();
                    for (const bankDoc of banksSnapshot.docs) {
                        const questionsRef = fbDb.collection('questionBanks').doc(bankDoc.id).collection('questions');
                        // Use get() and size for count in v8 (can be slow for large subcollections)
                        const questionsSnapshot = await questionsRef.get();
                        totalQuestions += questionsSnapshot.size;
                    }


                    // Fetch Psychometry & Test Records (VERY INEFFICIENT - Needs Aggregation for Production)
                    console.warn("PERFORMANCE WARNING: Fetching individual student histories for dashboard is INEFFICIENT for large datasets! Use Cloud Functions for aggregation in production.");
                    const studentsSnapshot = await fbDb.collection('users').where('role', '==', 'murid').get();
                    for (const studentDoc of studentsSnapshot.docs) {
                        const uid = studentDoc.id;
                        const historyKeys = ['literasi', 'numerasi', 'gayaBelajar', 'modalitasBelajar', 'kecerdasanGanda', 'ketertarikan'];
                        for (const key of historyKeys) {
                            const testDocRef = fbDb.collection('users').doc(uid).collection('testHistory').doc(key);
                            const testDocSnap = await testDocRef.get();
                            if (testDocSnap.exists) {
                                const resultsSnapshot = await testDocRef.collection('results').get();
                                totalTestRecords += resultsSnapshot.size;
                                if (resultsSnapshot.size > 0 && !dataKeyRequiresScore(key)) {
                                    const latestResultSnapshot = await testDocRef.collection('results').orderBy('date', 'desc').limit(1).get();
                                    if (!latestResultSnapshot.empty) {
                                        const result = latestResultSnapshot.docs[0].data().result;
                                        if (result) {
                                            const aggTarget = key === 'gayaBelajar' ? gayaBelajarAgg : key === 'modalitasBelajar' ? modalitasAgg : key === 'kecerdasanGanda' ? kecerdasanAgg : ketertarikanAgg;
                                            const individualResults = String(result).split(',').map(r => r.trim()).filter(r => r);
                                            individualResults.forEach(res => aggTarget[res] = (aggTarget[res] || 0) + 1);
                                        }
                                    }
                                }
                            }
                        }
                    }


                    // Process Aggregated Data
                    const processAggregatedData = (aggData) => {
                        const labels = Object.keys(aggData).sort(); const data = labels.map(label => aggData[label]);
                        let maxFreq = 0; let mostFrequent = [];
                        labels.forEach(label => { if (aggData[label] > maxFreq) { maxFreq = aggData[label]; mostFrequent = [label]; } else if (aggData[label] === maxFreq) { mostFrequent.push(label); } });
                        return { labels, data, mostFrequent: mostFrequent.sort().join(' / ') || 'N/A' };
                    };
                    const gayaProcessed = processAggregatedData(gayaBelajarAgg);
                    const modalitasProcessed = processAggregatedData(modalitasAgg);
                    const kecerdasanProcessed = processAggregatedData(kecerdasanAgg);
                    const ketertarikanProcessed = processAggregatedData(ketertarikanAgg);

                    mainContent.innerHTML = `
                        <div class="row mb-4"> <div class="col-lg-3 col-md-6 col-6 mb-3 mb-lg-0"> <div class="summary-box"> <span class="count">${totalStudents}</span> <span class="label">Total Murid</span> </div> </div> <div class="col-lg-3 col-md-6 col-6 mb-3 mb-lg-0"> <div class="summary-box"> <span class="count">${totalGurus}</span> <span class="label">Guru Aktif</span> </div> </div> <div class="col-lg-3 col-md-6 col-6 mb-3 mb-lg-0"> <div class="summary-box"> <span class="count">${totalQuestions}</span> <span class="label">Jumlah Soal</span> </div> </div> <div class="col-lg-3 col-md-6 col-6 mb-3 mb-lg-0"> <div class="summary-box"> <span class="count">${totalTestRecords}</span> <span class="label">Record Test</span> </div> </div> </div>
                        <div class="card mb-4"> <div class="card-header"><h3 class="card-header-title mb-0">Ringkasan Psikometri Kelas (Hasil Terbaru Terbanyak)</h3></div> <div class="card-body"> <ul class="psychometry-summary-admin"> <li><span>Gaya Belajar Dominan</span><strong>${gayaProcessed.mostFrequent}</strong></li> <li><span>Modalitas Belajar Dominan</span><strong>${modalitasProcessed.mostFrequent}</strong></li> <li><span>Kecerdasan Ganda Dominan</span><strong>${kecerdasanProcessed.mostFrequent}</strong></li> <li><span>Ketertarikan Dominan</span><strong>${ketertarikanProcessed.mostFrequent}</strong></li> </ul> </div> </div>
                        <h3 class="mb-3">Distribusi Hasil Psikometri Kelas</h3>
                        <div class="row"> <div class="col-md-4 mb-4"> <div class="card h-100"> <div class="card-body text-center d-flex flex-column"> <h4 class="mb-3">Gaya Belajar</h4> <div class="chart-container flex-grow-1 d-flex align-items-center justify-content-center" id="gayaBelajarChartContainer"> <canvas id="gayaBelajarChart"></canvas> </div> </div> </div> </div> <div class="col-md-4 mb-4"> <div class="card h-100"> <div class="card-body text-center d-flex flex-column"> <h4 class="mb-3">Modalitas Belajar</h4> <div class="chart-container flex-grow-1 d-flex align-items-center justify-content-center" id="modalitasChartContainer"> <canvas id="modalitasChart"></canvas> </div> </div> </div> </div> <div class="col-md-4 mb-4"> <div class="card h-100"> <div class="card-body text-center d-flex flex-column"> <h4 class="mb-3">Kecerdasan Ganda</h4> <div class="chart-container flex-grow-1 d-flex align-items-center justify-content-center" id="kecerdasanChartContainer"> <canvas id="kecerdasanChart"></canvas> </div> </div> </div> </div> </div>
                    `;

                    const createOrShowPlaceholder = (containerId, canvasId, chartLabel, labels, data) => {
                         const container = document.getElementById(containerId); if (!container) { console.error(`Chart container not found: ${containerId}`); return; }
                         if (typeof Chart === 'undefined') { console.error("Chart.js library not loaded."); container.innerHTML = `<div class="chart-placeholder text-danger">Error: Chart library tidak termuat.</div>`; return; }
                         if (labels && labels.length > 0) {
                              const canvas = container.querySelector('canvas'); if (!canvas) { console.error(`Canvas element not found: ${containerId}`); container.innerHTML = `<div class="chart-placeholder text-danger">Error: Elemen chart tidak ditemukan.</div>`; return; }
                              const ctx = canvas.getContext('2d'); if (!ctx) { console.error(`Could not get 2D context: ${canvasId}`); container.innerHTML = `<div class="chart-placeholder text-danger">Error: Gagal membuat konteks chart.</div>`; return; }
                              if (activeCharts[canvasId]) { activeCharts[canvasId].destroy(); }
                              try {
                                   const chartColors = ['#0d6efd', '#ffc107', '#198754', '#dc3545', '#0dcaf0', '#6f42c1', '#fd7e14', '#20c997', '#6c757d', '#d63384'];
                                   activeCharts[canvasId] = new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ label: chartLabel, data: data, backgroundColor: chartColors.slice(0, data.length), borderColor: '#ffffff', borderWidth: 2, hoverOffset: 6 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 15, font: { size: 11 } } }, tooltip: { boxPadding: 5 } } } });
                              } catch (chartError) { console.error(`Error creating chart (${canvasId}):`, chartError); container.innerHTML = `<div class="chart-placeholder text-danger">Error saat membuat chart: ${chartError.message}</div>`; }
                         } else { container.innerHTML = `<div class="chart-placeholder">Data belum tersedia</div>`; }
                     };

                     createOrShowPlaceholder('gayaBelajarChartContainer', 'gayaBelajarChart', 'Gaya Belajar', gayaProcessed.labels, gayaProcessed.data);
                     createOrShowPlaceholder('modalitasChartContainer', 'modalitasChart', 'Modalitas Belajar', modalitasProcessed.labels, modalitasProcessed.data);
                     createOrShowPlaceholder('kecerdasanChartContainer', 'kecerdasanChart', 'Kecerdasan Ganda', kecerdasanProcessed.labels, kecerdasanProcessed.data);

                } catch (error) {
                    console.error("Error loading teacher/admin dashboard:", error);
                    mainContent.innerHTML = `<div class="alert alert-danger">Gagal memuat data dashboard: ${error.message}</div>`;
                }
             };
            const loadAdminDashboardHome = () => { loadTeacherDashboardHome(); }; // Use the same dashboard for now

            // Kelola Soal (Firebase Integrated)
            const loadKelolaSoal = async () => { // Make async
                 if (currentUser.role !== 'guru' && currentUser.role !== 'admin') { mainContent.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Akses ditolak.</div>`; return; }
                 showLoading();
                 let availableBanks = [];
                 try {
                     const banksSnapshot = await fbDb.collection('questionBanks').get();
                     availableBanks = banksSnapshot.docs.map(doc => doc.id);
                     if (availableBanks.length === 0) {
                         console.log("No question banks found in Firestore. Consider adding default banks.");
                         // Optionally create default banks here if needed for first run
                         // Example: await fbDb.collection('questionBanks').doc('literasi').set({ name: 'Literasi', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                     }
                 } catch (error) {
                     console.error("Error fetching question bank list:", error);
                     mainContent.innerHTML = `<div class="alert alert-danger">Gagal memuat daftar bank soal: ${error.message}</div>`;
                     return;
                 }

                 let tabsHtml = '';
                 const defaultBanks = ['literasi', 'numerasi', 'gayaBelajar', 'modalitasBelajar', 'kecerdasanGanda', 'ketertarikan'];
                 const allPossibleBanks = [...new Set([...defaultBanks, ...availableBanks])].sort(); // Combine and sort

                 allPossibleBanks.forEach(bankKey => {
                     const bankTitle = bankKey.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                     tabsHtml += `<li class="nav-item"> <a class="nav-link ${bankKey === currentActiveQuestionBank ? 'active' : ''}" href="#" data-bank="${bankKey}">${bankTitle}</a> </li>`;
                 });

                 mainContent.innerHTML = `
                     <div class="card"> <div class="card-header"> <h3 class="card-header-title mb-0">Manajemen Bank Soal</h3> <div class="card-header-actions"> <button id="excel-question-upload-btn" class="btn btn-success btn-sm" onclick="document.getElementById('excel-question-upload-input').click()" title="Upload soal dari file Excel"> <i class="fas fa-file-excel"></i> Upload Excel </button> <input type="file" id="excel-question-upload-input" class="hidden" accept=".xlsx, .xls" onchange="handleExcelQuestionUpload(event)"> <button class="btn btn-primary btn-sm" onclick="openQuestionModal()" title="Tambah soal baru manual"> <i class="fas fa-plus"></i> Tambah Manual </button> </div> </div> <div class="card-body"> <div id="question-upload-status-message" class="mb-3"></div> <ul class="nav nav-tabs mb-3" id="question-bank-tabs"> ${tabsHtml} </ul> <div class="tab-content" id="question-bank-content"> <div class="text-center p-5"><div class="spinner-border text-primary"></div></div> </div> </div> </div>
                 `;
                 document.querySelectorAll('#question-bank-tabs .nav-link').forEach(tab => { tab.addEventListener('click', (e) => { e.preventDefault(); switchQuestionBankTab(e.target.getAttribute('data-bank')); }); });

                 // Ensure the currentActiveQuestionBank is valid, otherwise default
                 if (!allPossibleBanks.includes(currentActiveQuestionBank) && allPossibleBanks.length > 0) {
                     currentActiveQuestionBank = allPossibleBanks[0];
                 }

                 if (allPossibleBanks.length > 0) {
                    // Highlight the correct tab
                    document.querySelectorAll('#question-bank-tabs .nav-link').forEach(tab => {
                        tab.classList.toggle('active', tab.getAttribute('data-bank') === currentActiveQuestionBank);
                    });
                    await renderQuestionTable(currentActiveQuestionBank); // Render initial table
                 } else {
                    document.getElementById('question-bank-content').innerHTML = '<div class="alert alert-info">Belum ada bank soal yang tersedia.</div>';
                 }
             };
             window.switchQuestionBankTab = async (bankKey) => { // Make async
                 currentActiveQuestionBank = bankKey;
                 document.querySelectorAll('#question-bank-tabs .nav-link').forEach(tab => { tab.classList.toggle('active', tab.getAttribute('data-bank') === bankKey); });
                 const statusDiv = document.getElementById('question-upload-status-message'); if (statusDiv) statusDiv.innerHTML = '';
                 const contentDiv = document.getElementById('question-bank-content'); if(contentDiv) contentDiv.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>`;
                 await renderQuestionTable(bankKey);
             };
             const renderQuestionTable = async (bankKey) => { // Make async
                  const container = document.getElementById('question-bank-content'); if (!container) return;
                  let questions = [];
                  try {
                      const bankDocRef = fbDb.collection('questionBanks').doc(bankKey);
                      const bankDocSnap = await bankDocRef.get();
                      if (bankDocSnap.exists) {
                          const questionsRef = bankDocRef.collection('questions');
                          const snapshot = await questionsRef.get();
                          questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                      } else {
                          console.log(`Question bank document '${bankKey}' does not exist.`);
                          questions = []; // Treat as empty
                      }
                  } catch (error) { console.error(`Error fetching questions for ${bankKey}:`, error); container.innerHTML = `<div class="alert alert-danger">Gagal memuat soal: ${error.message}</div>`; return; }
                  const is3Opt = threeOptionTestKeys.includes(bankKey); const answerHeader = is3Opt ? 'Preferensi*' : 'Jawaban Benar';
                  let tableHtml = `<div class="table-responsive"><table class="data-table" id="${bankKey}-questions-table"><thead> <tr> <th>ID Soal</th> <th class="question-text-cell">Teks Pertanyaan</th> <th>Opsi</th> <th>${answerHeader}</th> <th class="actions-cell">Aksi</th> </tr> </thead><tbody>`;
                   if (questions.length > 0) {
                       questions.forEach(q => {
                            const questionId = q.id; // Firestore doc ID
                            const answerDisplay = q.answer !== null && q.answer !== undefined ? q.answer : (is3Opt ? '<em class="text-muted">N/A</em>' : '-');
                            let optionsPreview = (q.options || []).slice(0, is3Opt ? 3 : 4).map((opt, i) => `<strong>${String.fromCharCode(65 + i)}:</strong> ${(opt || '').substring(0, 20)}${(opt || '').length > 20 ? '...' : ''}`).join('<br>');
                            const questionTextPreview = (q.text || '').substring(0, 80) + ((q.text || '').length > 80 ? '...' : '');
                            tableHtml += `<tr> <td><small>${questionId || '-'}</small></td> <td class="question-text-cell" title="${q.text || ''}">${questionTextPreview}</td> <td><small>${optionsPreview || '-'}</small></td> <td>${answerDisplay}</td> <td class="actions-cell"> <button class="btn btn-info btn-sm btn-action" title="Edit Soal" onclick="openQuestionModal('${bankKey}', '${questionId}')"><i class="fas fa-edit fa-fw"></i></button> <button class="btn btn-danger btn-sm btn-action" title="Hapus Soal" onclick="handleDeleteQuestion('${bankKey}', '${questionId}')"><i class="fas fa-trash fa-fw"></i></button> </td> </tr>`;
                        });
                    } else { tableHtml += `<tr><td colspan="5" class="text-center text-muted p-4">Belum ada soal di bank soal ${bankKey}.</td></tr>`; }
                    tableHtml += `</tbody></table></div>`; if (is3Opt) tableHtml += `<p class="form-text mt-2">*Tes preferensi tidak memiliki jawaban benar/salah.</p>`
                  container.innerHTML = tableHtml;
              };

            // Excel Question Upload (Firebase Integrated)
             window.handleExcelQuestionUpload = (event) => {
                const file = event.target.files[0]; const statusDiv = document.getElementById('question-upload-status-message'); const uploadButton = document.getElementById('excel-question-upload-btn');
                statusDiv.innerHTML = ''; statusDiv.className = 'mb-3'; if (!file) return;
                const validExtensions = ['.xlsx', '.xls']; const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase(); if (!validExtensions.includes(fileExtension)) { statusDiv.innerHTML = `<div class="alert alert-danger">Format file tidak valid (.xlsx/.xls).</div>`; event.target.value = null; return; }

                // *** XLSX CHECK ADDED HERE ***
                if (typeof XLSX === 'undefined') {
                    console.error("SheetJS (XLSX) library is not loaded.");
                    statusDiv.innerHTML = `<div class="alert alert-danger">Error: Library untuk membaca file Excel (XLSX) tidak termuat. Coba refresh halaman.</div>`;
                    event.target.value = null;
                    return;
                }
                // *** END OF XLSX CHECK ***

                 statusDiv.innerHTML = `<div class="alert alert-info"><div class="spinner-border spinner-border-sm"></div> Memproses file Excel "${file.name}"...</div>`;
                 if (uploadButton) toggleButtonLoading(uploadButton.id, true);
                 const reader = new FileReader();
                 reader.onload = async (e) => { // Make async
                      let resultHtml = ''; let uploadSuccess = false; const bankKey = currentActiveQuestionBank; const is3OptionType = threeOptionTestKeys.includes(bankKey);
                      let addedCount = 0; let skippedCount = 0; let errorMessages = [];
                      const batch = fbDb.batch(); // Initialize batch write
                      const bankDocRef = fbDb.collection('questionBanks').doc(bankKey); // Ref to bank doc
                      const questionsColRef = bankDocRef.collection('questions'); // Ref to questions subcollection

                      try {
                          const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName]; if (!worksheet) throw new Error("Sheet pertama kosong."); const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                          if (!jsonData || jsonData.length < 2) throw new Error("Tidak ada data soal yang valid.");
                          const headersRaw = jsonData[0]; if (!headersRaw || headersRaw.length === 0) throw new Error("Header tidak ditemukan."); const headers = headersRaw.map(h => String(h).trim().toLowerCase());
                          let expectedHeaders, optionCount, hasAnswerColumn;
                          if (is3OptionType) { expectedHeaders = ["nomor", "pertanyaan", "opsi a", "opsi b", "opsi c"]; optionCount = 3; hasAnswerColumn = false; }
                          else { expectedHeaders = ["nomor", "pertanyaan", "opsi a", "opsi b", "opsi c", "opsi d", "jawaban"]; optionCount = 4; hasAnswerColumn = true; }
                          const requiredHeadersPresent = expectedHeaders.every(expectedH => headers.includes(expectedH)); if (!requiredHeadersPresent) { throw new Error(`Format header tidak sesuai. Wajib: ${expectedHeaders.map(h=>`"${h}"`).join(', ')}.`); }
                          const headerMap = {}; headers.forEach((h, index) => { headerMap[h] = index; });

                          // Ensure the bank document exists (create if not)
                          await bankDocRef.set({ name: bankKey.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()), lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });

                          for (let i = 1; i < jsonData.length; i++) {
                                const row = jsonData[i]; if (row.every(cell => String(cell).trim() === '')) continue; const rowNum = i + 1;
                                const questionText = String(row[headerMap["pertanyaan"]] || '').trim(); const options = []; for(let j=0; j<optionCount; j++) { options.push(String(row[headerMap[`opsi ${String.fromCharCode(97 + j)}`]] || '').trim()); }
                                const answer = hasAnswerColumn ? String(row[headerMap["jawaban"]] || '').trim().toUpperCase() : null;
                                let rowErrors = []; if (!questionText) rowErrors.push("Pertanyaan kosong"); options.forEach((opt, k) => { if (!opt) rowErrors.push(`Opsi ${String.fromCharCode(65+k)} kosong`); }); if (hasAnswerColumn && !answer) rowErrors.push("Jawaban kosong"); else if (hasAnswerColumn && !['A', 'B', 'C', 'D'].includes(answer)) rowErrors.push(`Jawaban '${answer}' tidak valid`);
                                if (rowErrors.length > 0) { errorMessages.push(`Baris ${rowNum}: ${rowErrors.join(', ')}.`); skippedCount++; continue; }
                                const newQuestionData = { text: questionText, options: options, answer: answer, type: is3OptionType ? 'multiple-choice-3opt' : 'multiple-choice' };
                                const newQuestionRef = questionsColRef.doc(); // Auto-generate ID within subcollection
                                batch.set(newQuestionRef, newQuestionData); // Add to batch
                                addedCount++;
                            }
                           if (addedCount > 0) { await batch.commit(); console.log(`${addedCount} questions committed to Firestore for bank ${bankKey}.`); } // Commit batch
                           if (addedCount > 0) { resultHtml += `<div class="alert alert-success">Upload selesai! ${addedCount} soal baru ditambahkan ke bank ${bankKey}.${skippedCount > 0 ? ` ${skippedCount} baris dilewati.` : ''}</div>`; uploadSuccess = true; await renderQuestionTable(bankKey); }
                           else if (skippedCount > 0 && errorMessages.length === 0) { resultHtml += `<div class="alert alert-warning">Tidak ada soal baru valid. ${skippedCount} baris dilewati.</div>`; }
                           else { resultHtml += `<div class="alert alert-warning">Tidak ada soal baru ditambahkan.</div>`; }
                           if (errorMessages.length > 0) { resultHtml += `<div class="alert alert-danger mt-2" style="max-height: 150px; overflow-y: auto;"><strong class="d-block mb-1">Detail Error (${errorMessages.length}):</strong><ul class="list-unstyled mb-0" style="font-size: 0.85em;">`; errorMessages.slice(0, 20).forEach(msg => resultHtml += `<li><i class="fas fa-times-circle text-danger me-1"></i>${msg}</li>`); if (errorMessages.length > 20) resultHtml += `<li>...dan ${errorMessages.length - 20} error lainnya.</li>`; resultHtml += `</ul></div>`; }
                      } catch (error) { console.error("Error processing Excel:", error); resultHtml = `<div class="alert alert-danger">Gagal proses file: ${error.message}.</div>`; }
                      finally { statusDiv.innerHTML = resultHtml; if (uploadSuccess) showNotification("Upload soal dari Excel berhasil!", 'success'); if (uploadButton) toggleButtonLoading(uploadButton.id, false); event.target.value = null; }
                 };
                 reader.onerror = (error) => { console.error("Error reading file:", error); statusDiv.innerHTML = `<div class="alert alert-danger">Gagal membaca file.</div>`; if (uploadButton) toggleButtonLoading(uploadButton.id, false); event.target.value = null; };
                 reader.readAsArrayBuffer(file);
              };

            // Lihat Nilai (Firebase Integrated - Inefficient Fetch Warning)
            const loadLihatNilai = async () => { // Make async
                if (currentUser.role !== 'guru' && currentUser.role !== 'admin') { mainContent.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Akses ditolak.</div>`; return; }
                showLoading();
                let contentHtml = `<h2 class="mb-3">Rekap Nilai & Hasil Test Murid</h2>`;
                let studentList = [];
                try {
                    const studentsSnapshot = await fbDb.collection('users').where('role', '==', 'murid').orderBy('name').get();
                    studentList = studentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error("Error fetching student list:", error);
                    // Check if it's an index error
                    if (error.code === 'failed-precondition') {
                         mainContent.innerHTML = `<div class="alert alert-danger">Gagal memuat daftar murid: Query memerlukan index Firestore. <br>Buat index di Firebase Console untuk collection 'users' dengan field 'role' (Asc) dan 'name' (Asc).<br><small>Detail: ${error.message}</small></div>`;
                    } else {
                         mainContent.innerHTML = `<div class="alert alert-danger">Gagal memuat daftar murid: ${error.message}</div>`;
                    }
                    return;
                }

                if (studentList.length === 0) { contentHtml += `<div class="alert alert-info mt-3"><i class="fas fa-info-circle"></i> Belum ada data murid.</div>`; }
                else {
                    console.warn("PERFORMANCE WARNING: Fetching individual student histories for 'Lihat Nilai' is INEFFICIENT for large datasets! Consider alternative data structures or pagination.");
                    for (const murid of studentList) {
                        const studentUid = murid.id; // Firestore document ID is the UID
                        let studentTestData = {};
                        try {
                            // Fetch latest 3 results for each test type (Inefficient N+1)
                            const studentTests = menus.murid.filter(item => item.section?.startsWith('test-'));
                            for (const menuItem of studentTests) {
                                const dataKey = menuItem.section.replace('test-', '');
                                const testDocRef = fbDb.collection('users').doc(studentUid).collection('testHistory').doc(dataKey);
                                const testDocSnap = await testDocRef.get();
                                if (testDocSnap.exists) {
                                    const historyRef = testDocRef.collection('results').orderBy('date', 'desc').limit(3);
                                    const snapshot = await historyRef.get();
                                    studentTestData[dataKey] = snapshot.docs.map(doc => doc.data());
                                } else {
                                    studentTestData[dataKey] = []; // Ensure key exists even if no history doc
                                }
                            }
                        } catch (fetchError) { console.error(`Error fetching history for ${murid.name}:`, fetchError); }

                        contentHtml += `<div class="card student-score-card mb-4"> <div class="card-body p-4"> <h4 class="mb-3"><i class="fas fa-user-graduate me-2"></i> ${murid.name} <small class="text-muted">(NISN: ${murid.nisn || 'N/A'})</small></h4>`;
                        const studentTests = menus.murid.filter(item => item.section?.startsWith('test-'));
                        if (studentTests.length > 0) {
                           contentHtml += '<div class="row">';
                            studentTests.forEach(menuItem => {
                                const dataKey = menuItem.section.replace('test-', ''); const testTitle = menuItem.title.replace('Test ', ''); const history = studentTestData[dataKey] || []; const hasScore = dataKeyRequiresScore(dataKey);
                                contentHtml += '<div class="col-md-6 mb-3">'; contentHtml += `<h5>${testTitle}</h5>`;
                                if (history.length > 0) {
                                     contentHtml += `<div class="table-responsive"><table class="data-table history-table mb-0"><thead><tr><th>Tanggal</th><th>${hasScore ? 'Skor' : 'Hasil'}</th></tr></thead><tbody>`;
                                     history.forEach(item => { // Already sorted by query (desc), limit 3
                                          const dateValue = item.date?.toDate ? item.date.toDate() : new Date();
                                          const formattedDate = dateValue.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
                                          const displayValue = hasScore ? (item.score ?? '-') : (item.result ?? '-');
                                          contentHtml += `<tr><td>${formattedDate}</td><td>${displayValue}</td></tr>`;
                                      });
                                      contentHtml += '</tbody></table></div>';
                                 } else { contentHtml += '<p class="text-muted form-text">Belum ada riwayat.</p>'; }
                                contentHtml += '</div>';
                            });
                             contentHtml += '</div>';
                        } else { contentHtml += '<p class="text-muted">Tidak ada data test tersedia.</p>';}
                        contentHtml += `</div></div>`;
                    }
                }
                mainContent.innerHTML = contentHtml;
            };

            // Admin User Management (Firebase Integrated)
            const loadKelolaPengguna = async () => { // Make async
                if (currentUser.role !== 'admin') { mainContent.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Akses ditolak.</div>`; return; }
                let containerHtml = `
                     <div class="card"> <div class="card-header"> <h3 class="card-header-title mb-0">Manajemen Pengguna</h3> <div class="card-header-actions"> <button id="upload-excel-btn" class="btn btn-success btn-sm hidden" onclick="document.getElementById('excel-upload-input').click()" title="Upload data siswa dari Excel"> <i class="fas fa-file-excel"></i> Upload Siswa (Excel) </button> <button class="btn btn-primary btn-sm" onclick="openUserModal()" title="Tambah pengguna baru manual"> <i class="fas fa-plus"></i> Tambah Pengguna </button> <input type="file" id="excel-upload-input" class="hidden" accept=".xlsx, .xls" onchange="handleExcelUserUpload(event)"> </div> </div> <div class="card-body"> <div id="upload-status-message" class="mb-3"></div> <ul class="nav nav-tabs mb-3" id="user-tabs"> <li class="nav-item"> <a class="nav-link ${currentActiveUserTab === 'guru' ? 'active' : ''}" href="#" data-role="guru"><i class="fas fa-chalkboard-teacher me-1"></i> Guru</a> </li> <li class="nav-item"> <a class="nav-link ${currentActiveUserTab === 'murid' ? 'active' : ''}" href="#" data-role="murid"><i class="fas fa-user-graduate me-1"></i> Murid</a> </li> <li class="nav-item"> <a class="nav-link ${currentActiveUserTab === 'admin' ? 'active' : ''}" href="#" data-role="admin"><i class="fas fa-user-shield me-1"></i> Admin</a> </li> </ul> <div class="tab-content" id="user-tab-content"> <div class="text-center p-5"><div class="spinner-border text-primary"></div></div> </div> </div> </div> `;
                 mainContent.innerHTML = containerHtml;
                 document.querySelectorAll('#user-tabs .nav-link').forEach(tab => { tab.addEventListener('click', (e) => { e.preventDefault(); showUserTab(e.target.getAttribute('data-role')); }); });
                 await showUserTab(currentActiveUserTab);
             };
             const showUserTab = async (role) => { // Make async
                 currentActiveUserTab = role; const uploadButton = document.getElementById('upload-excel-btn'); const uploadStatusDiv = document.getElementById('upload-status-message');
                 document.querySelectorAll('#user-tabs .nav-link').forEach(tab => { tab.classList.toggle('active', tab.getAttribute('data-role') === role); });
                 if (uploadButton) uploadButton.classList.toggle('hidden', role !== 'murid'); if (uploadStatusDiv) uploadStatusDiv.innerHTML = '';
                 const contentDiv = document.getElementById('user-tab-content'); if(contentDiv) contentDiv.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>`;
                 await renderUserTableForRole(role);
             };
             const renderUserTableForRole = async (role) => { // Make async
                  const container = document.getElementById('user-tab-content'); if (!container) return;
                  let usersOfRole = [];
                  try {
                      const usersRef = fbDb.collection('users').where('role', '==', role).orderBy('name');
                      const snapshot = await usersRef.get();
                      usersOfRole = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); // Use Firestore doc ID as 'id'
                  } catch (error) {
                      console.error(`Error fetching ${role} users:`, error);
                      // *** IMPROVED ERROR HANDLING FOR INDEX ***
                      if (error.code === 'failed-precondition') {
                           container.innerHTML = `<div class="alert alert-danger">Gagal memuat data ${role}: Query memerlukan index Firestore. <br>Silakan buat index di Firebase Console untuk collection 'users' dengan field 'role' (Asc) dan 'name' (Asc).<br><small>Detail: ${error.message}</small></div>`;
                      } else {
                           container.innerHTML = `<div class="alert alert-danger">Gagal memuat data ${role}: ${error.message}</div>`;
                      }
                      return;
                  }
                  const tableId = `${role}-management-table`; const identifierHeader = role === 'murid' ? 'NISN' : 'Username';
                  let tableHtml = `<div class="table-responsive"><table class="data-table" id="${tableId}"><thead> <tr> <th>#</th> <th>Nama</th> <th>${identifierHeader}</th> <th>Status</th> <th class="actions-cell">Aksi</th> </tr> </thead><tbody>`;
                  if (usersOfRole.length > 0) {
                      usersOfRole.forEach((user, index) => {
                         const userId = user.id; // Firestore document ID (which should be the UID)
                         const identifier = user.nisn || user.username || 'N/A';
                         const isCurrentUser = userId === currentUser.uid;
                         const statusClass = user.status === 'aktif' ? 'status-aktif' : 'status-nonaktif'; const statusText = user.status === 'aktif' ? 'Aktif' : 'Nonaktif'; const toggleStatusText = user.status === 'aktif' ? 'Nonaktifkan' : 'Aktifkan'; const toggleStatusIcon = user.status === 'aktif' ? 'fa-toggle-off' : 'fa-toggle-on'; const toggleStatusBtnClass = user.status === 'aktif' ? 'btn-warning' : 'btn-success';
                          tableHtml += `<tr> <td>${index + 1}</td> <td>${user.name || 'Tanpa Nama'}</td> <td>${identifier}</td> <td><span class="status-badge ${statusClass}">${statusText}</span></td> <td class="actions-cell"> <button class="btn btn-info btn-sm btn-action" title="Edit" onclick="openUserModal('${user.role}', '${userId}')"><i class="fas fa-edit fa-fw"></i></button> <button class="btn ${toggleStatusBtnClass} btn-sm btn-action" title="${toggleStatusText}" onclick="handleToggleStatus('${userId}', '${user.status}')" ${isCurrentUser ? 'disabled' : ''}><i class="fas ${toggleStatusIcon} fa-fw"></i></button> <button class="btn btn-secondary btn-sm btn-action" title="Reset Password" onclick="handleResetPassword('${userId}')"><i class="fas fa-key fa-fw"></i></button> <button class="btn btn-danger btn-sm btn-action" title="Hapus" onclick="handleDeleteUser('${userId}', '${user.name || 'Pengguna'}')" ${isCurrentUser ? 'disabled' : ''}><i class="fas fa-trash fa-fw"></i></button> </td> </tr>`;
                        });
                  } else { tableHtml += `<tr><td colspan="5" class="text-center text-muted p-4">Belum ada data pengguna ${role}.</td></tr>`; }
                  tableHtml += `</tbody></table></div>`; container.innerHTML = tableHtml;
              };
              // Excel User Upload (Firebase Integrated)
               window.handleExcelUserUpload = (event) => {
                  const file = event.target.files[0]; const statusDiv = document.getElementById('upload-status-message'); const uploadButton = document.getElementById('upload-excel-btn');
                  statusDiv.innerHTML = ''; statusDiv.className = 'mb-3'; if (!file) return;
                  const validExtensions = ['.xlsx', '.xls']; const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase(); if (!validExtensions.includes(fileExtension)) { statusDiv.innerHTML = `<div class="alert alert-danger">Format file tidak valid (.xlsx/.xls).</div>`; event.target.value = null; return; }

                  // *** XLSX CHECK ADDED HERE ***
                  if (typeof XLSX === 'undefined') {
                      console.error("SheetJS (XLSX) library is not loaded.");
                      statusDiv.innerHTML = `<div class="alert alert-danger">Error: Library untuk membaca file Excel (XLSX) tidak termuat. Coba refresh halaman.</div>`;
                      event.target.value = null;
                      return;
                  }
                  // *** END OF XLSX CHECK ***

                  statusDiv.innerHTML = `<div class="alert alert-info"><div class="spinner-border spinner-border-sm"></div> Memproses file "${file.name}"...</div>`; toggleButtonLoading(uploadButton.id, true);
                  const reader = new FileReader();
                  reader.onload = async (e) => { // Make async
                        let resultHtml = ''; let uploadSuccess = false; let addedCount = 0; let skippedCount = 0; let errorMessages = [];
                        const batch = fbDb.batch(); // Initialize Firestore batch
                        try {
                            const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName]; if (!worksheet) throw new Error("Sheet pertama kosong."); const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                            if (!jsonData || jsonData.length < 2) throw new Error("Tidak ada data siswa yang valid."); const headers = jsonData[0].map(h => String(h).trim().toLowerCase()); const expectedHeaders = ["nomor", "nama lengkap", "nisn"]; if (headers.length < 3 || headers[0] !== expectedHeaders[0] || headers[1] !== expectedHeaders[1] || headers[2] !== expectedHeaders[2]) throw new Error(`Format header Excel tidak sesuai. Wajib: Nomor, Nama Lengkap, NISN.`);
                            const defaultPassword = 'password123'; // Set a secure default or generate one
                            for (let i = 1; i < jsonData.length; i++) {
                                  const row = jsonData[i]; if (row.every(cell => String(cell).trim() === '')) continue; const rowNum = i + 1;
                                  const namaLengkap = String(row[1] || '').trim(); const nisn = String(row[2] || '').trim().replace(/\s+/g, '');
                                 if (!namaLengkap || !nisn) { errorMessages.push(`Baris ${rowNum}: Nama/NISN kosong.`); skippedCount++; continue; }
                                 if (!/^\d+$/.test(nisn)) { errorMessages.push(`Baris ${rowNum}: NISN '${nisn}' tidak valid (harus angka).`); skippedCount++; continue; }
                                 // Check Firestore for existing NISN
                                 const existingUserSnapshot = await fbDb.collection('users').where('nisn', '==', nisn).limit(1).get();
                                 if (!existingUserSnapshot.empty) { errorMessages.push(`Baris ${rowNum}: NISN '${nisn}' (${namaLengkap}) sudah terdaftar.`); skippedCount++; continue; }
                                 try {
                                     const email = `${nisn}@akubisasimpan-20a7e.firebaseapp.com`; // Dummy email using YOUR project ID
                                     const userCredential = await fbAuth.createUserWithEmailAndPassword(email, defaultPassword);
                                     const uid = userCredential.user.uid;
                                     const newUserFirestoreData = { uid: uid, name: namaLengkap, nisn: nisn, role: 'murid', status: 'aktif', parentName: '', address: '', profilePic: 'assets/default-profile.png', createdAt: firebase.firestore.FieldValue.serverTimestamp() };
                                     const userDocRef = fbDb.collection('users').doc(uid);
                                     batch.set(userDocRef, newUserFirestoreData); // Add user data to batch
                                     addedCount++;
                                 } catch (authError) { console.error(`Error creating auth user for NISN ${nisn}:`, authError); let authErrorMessage = `Gagal buat akun Auth (${authError.code || authError.message})`; if (authError.code === 'auth/email-already-in-use') { authErrorMessage = `Email (dummy) untuk NISN ${nisn} sudah digunakan.`; } errorMessages.push(`Baris ${rowNum}: ${authErrorMessage}`); skippedCount++; }
                             }
                            if (addedCount > 0) { await batch.commit(); console.log(`${addedCount} users committed to Firestore.`); } // Commit the batch
                            if (addedCount > 0) { resultHtml += `<div class="alert alert-success">Upload berhasil! ${addedCount} siswa baru ditambahkan.${skippedCount > 0 ? ` ${skippedCount} baris dilewati/error.` : ''} Password default: '${defaultPassword}'.</div>`; uploadSuccess = true; await showUserTab('murid'); }
                            else if (skippedCount > 0 && errorMessages.length === 0) { resultHtml += `<div class="alert alert-warning">Tidak ada siswa baru ditambahkan. ${skippedCount} baris dilewati.</div>`; }
                            else { resultHtml += `<div class="alert alert-warning">Tidak ada siswa baru ditambahkan.</div>`; }
                            if (errorMessages.length > 0) { resultHtml += `<div class="alert alert-danger mt-2" style="max-height: 150px; overflow-y: auto;"><strong class="d-block mb-1">Detail Error (${errorMessages.length}):</strong><ul class="list-unstyled mb-0" style="font-size: 0.85em;">`; errorMessages.slice(0, 20).forEach(msg => resultHtml += `<li><i class="fas fa-times-circle text-danger me-1"></i>${msg}</li>`); if (errorMessages.length > 20) resultHtml += `<li>...dan ${errorMessages.length - 20} error lainnya.</li>`; resultHtml += `</ul></div>`; }
                        } catch (error) { console.error("Error processing Excel:", error); resultHtml = `<div class="alert alert-danger">Gagal proses file: ${error.message}.</div>`; }
                        finally { statusDiv.innerHTML = resultHtml; if(uploadSuccess) showNotification("Upload data siswa selesai.", "success"); toggleButtonLoading(uploadButton.id, false); event.target.value = null; }
                   };
                    reader.onerror = (error) => { console.error("Error reading file:", error); statusDiv.innerHTML = `<div class="alert alert-danger">Gagal membaca file.</div>`; toggleButtonLoading(uploadButton.id, false); event.target.value = null; };
                    reader.readAsArrayBuffer(file);
              };

            // User Modal Functions (Firebase Integrated)
             window.openUserModal = async (role = null, userId = null) => { // Use userId (Firestore ID/UID)
                 const modalId = 'user-modal'; openModal(modalId); clearModalError(modalId);
                 const form = document.getElementById('user-form'); const title = document.getElementById('user-modal-title'); const editIdentifierInput = document.getElementById('user-edit-identifier'); const passwordInput = document.getElementById('user-password'); const confirmPasswordInput = document.getElementById('user-confirm-password'); const passwordRequired = document.getElementById('password-required-indicator'); const confirmPasswordRequired = document.getElementById('confirm-password-required-indicator'); const passwordHelp = document.getElementById('password-help'); const roleSelectModal = document.getElementById('user-role'); const identifierInput = document.getElementById('user-identifier');
                 form.reset(); form.classList.remove('was-validated'); passwordInput.classList.remove('is-invalid'); confirmPasswordInput.classList.remove('is-invalid');
                 editIdentifierInput.value = userId; // Store Firestore ID/UID
                 const isEdit = !!userId;
                 title.textContent = isEdit ? 'Edit Detail Pengguna' : 'Tambah Pengguna Baru';
                 passwordRequired.style.display = isEdit ? 'none' : 'inline'; confirmPasswordRequired.style.display = isEdit ? 'none' : 'inline'; passwordHelp.textContent = isEdit ? 'Kosongkan jika tidak ingin mengubah.' : 'Min. 6 karakter. Wajib diisi.';
                 passwordInput.required = !isEdit; confirmPasswordInput.required = !isEdit; confirmPasswordInput.disabled = !passwordInput.value && isEdit;
                 roleSelectModal.disabled = isEdit; identifierInput.disabled = isEdit;
                 // Add listener to enable/require confirm password only when new password is typed
                 passwordInput.oninput = () => {
                     confirmPasswordInput.disabled = !passwordInput.value;
                     confirmPasswordInput.required = !!passwordInput.value;
                     if (!passwordInput.value) {
                         confirmPasswordInput.classList.remove('is-invalid');
                         confirmPasswordInput.value = '';
                     }
                 };
                 if (isEdit) {
                      try {
                          const userDocRef = fbDb.collection('users').doc(userId); const userDoc = await userDocRef.get(); if (!userDoc.exists) throw new Error("Pengguna tidak ditemukan."); const userToEdit = { id: userDoc.id, ...userDoc.data() };
                          document.getElementById('user-nama').value = userToEdit.name || ''; roleSelectModal.value = userToEdit.role; identifierInput.value = userToEdit.nisn || userToEdit.username || ''; document.getElementById('user-status').value = userToEdit.status || 'aktif';
                          if (userToEdit.role === 'murid') { document.getElementById('user-parentName').value = userToEdit.parentName || ''; document.getElementById('user-address').value = userToEdit.address || ''; }
                      } catch (error) { console.error("Error fetching user for edit:", error); showNotification(`Error: ${error.message}`, "danger"); closeModal(modalId); return; }
                 } else { roleSelectModal.value = currentActiveUserTab || 'guru'; confirmPasswordInput.disabled = false; confirmPasswordInput.required = true; passwordInput.required = true; }
                 toggleUserFormFields(); // Call after setting role value
             };
             window.toggleUserFormFields = () => {
                  const role = document.getElementById('user-role').value; const identifierLabel = document.getElementById('user-identifier-label'); const identifierInput = document.getElementById('user-identifier'); const muridFields = document.getElementById('murid-fields'); const saveButton = document.getElementById('user-modal-save-btn');
                 if (role === 'murid') { identifierLabel.innerHTML = 'NISN <span class="text-danger">*</span>'; identifierInput.placeholder = 'Masukkan NISN Numerik'; identifierInput.type = 'number'; identifierInput.pattern = '\\d+'; muridFields.classList.remove('hidden'); }
                 else { identifierLabel.innerHTML = 'Username <span class="text-danger">*</span>'; identifierInput.placeholder = 'Masukkan Username'; identifierInput.type = 'text'; identifierInput.removeAttribute('pattern'); muridFields.classList.add('hidden'); }
                 saveButton.disabled = false;
             };
             const userForm = document.getElementById('user-form'); if (userForm) { userForm.addEventListener('submit', (event) => { event.preventDefault(); handleUserFormSubmit(); }); }
             const handleUserFormSubmit = async () => { // Make async
                const modalId = 'user-modal'; const form = document.getElementById('user-form'); const saveButton = document.getElementById('user-modal-save-btn'); clearModalError(modalId);
                const isEdit = !!document.getElementById('user-edit-identifier').value; const passwordInput = document.getElementById('user-password'); const confirmPasswordInput = document.getElementById('user-confirm-password'); confirmPasswordInput.required = !isEdit || !!passwordInput.value; // Re-check requirement
                if (!validateForm(form)) { displayModalError(modalId, "Harap perbaiki isian yang ditandai."); return; }
                toggleButtonLoading(saveButton.id, true);
                const name = document.getElementById('user-nama').value.trim(); const role = document.getElementById('user-role').value; const identifierValue = document.getElementById('user-identifier').value.trim(); const status = document.getElementById('user-status').value; const password = document.getElementById('user-password').value; const parentName = document.getElementById('user-parentName')?.value.trim(); const address = document.getElementById('user-address')?.value.trim(); const editUserId = document.getElementById('user-edit-identifier').value; // Firestore ID/UID
                try {
                    if (isEdit) {
                        // Editing existing user
                        const userDocRef = fbDb.collection('users').doc(editUserId); const dataToUpdate = { name: name, status: status }; if (role === 'murid') { dataToUpdate.parentName = parentName; dataToUpdate.address = address; }
                        // Password change requires re-auth, handle separately in settings for simplicity here
                        if (password) {
                            // NOTE: Updating password here is complex due to re-authentication needs.
                            // Recommend directing users to Settings page for password changes.
                            // If needed here, implement re-auth flow.
                            displayModalError(modalId, "Ubah password melalui halaman Pengaturan Akun.");
                            toggleButtonLoading(saveButton.id, false);
                            return;
                        }
                        await userDocRef.update(dataToUpdate); console.log("User updated in Firestore:", editUserId);
                    } else {
                        // Adding new user
                        const identifierField = role === 'murid' ? 'nisn' : 'username';
                        // Check if identifier already exists in Firestore
                        const existingUserSnapshot = await fbDb.collection('users').where(identifierField, '==', identifierValue).limit(1).get();
                        if (!existingUserSnapshot.empty) {
                            throw new Error(`${role === 'murid' ? 'NISN' : 'Username'} "${identifierValue}" sudah digunakan.`);
                        }
                        const email = `${identifierValue}@akubisasimpan-20a7e.firebaseapp.com`; // Dummy email using YOUR project ID
                        // Create user in Firebase Auth
                        const userCredential = await fbAuth.createUserWithEmailAndPassword(email, password);
                        const uid = userCredential.user.uid;
                        // Create user document in Firestore
                        const newUserFirestoreData = { uid: uid, name: name, role: role, status: status, profilePic: 'assets/default-profile.png', createdAt: firebase.firestore.FieldValue.serverTimestamp() };
                        if (role === 'murid') { newUserFirestoreData.nisn = identifierValue; newUserFirestoreData.parentName = parentName; newUserFirestoreData.address = address; } else { newUserFirestoreData.username = identifierValue; }
                        const userDocRef = fbDb.collection('users').doc(uid);
                        await userDocRef.set(newUserFirestoreData); console.log("User added to Auth and Firestore:", uid);
                    }
                    toggleButtonLoading(saveButton.id, false); closeModal(modalId); await showUserTab(currentActiveUserTab); showNotification(`Data pengguna ${isEdit ? 'diperbarui' : 'ditambahkan'}!`, 'success');
                } catch (error) { console.error("Error saving user:", error); displayModalError(modalId, `Gagal menyimpan: ${error.message}`); toggleButtonLoading(saveButton.id, false); }
              };

             // User Action Handlers (Firebase Integrated)
            window.handleDeleteUser = async (userId, userName) => { // Use userId (Firestore ID/UID)
                const userDocRef = fbDb.collection('users').doc(userId); const isCurrentUser = userId === currentUser.uid; if (isCurrentUser) { showNotification("Anda tidak dapat menghapus akun Anda sendiri.", "warning"); return; }
                if (confirm(`Yakin ingin menghapus pengguna "${userName}"? Tindakan ini hanya menghapus data dari database aplikasi, BUKAN akun login Firebase. Penghapusan akun login memerlukan tindakan terpisah (misal: Cloud Function).`)) {
                    try { await userDocRef.delete(); console.log("User deleted from Firestore:", userId); await showUserTab(currentActiveUserTab); showNotification("Pengguna berhasil dihapus dari database.", "success"); }
                    catch (error) { console.error("Error deleting user:", error); showNotification(`Gagal menghapus pengguna: ${error.message}`, "danger"); }
                 }
            };
            window.handleToggleStatus = async (userId, currentStatus) => { // Use userId (Firestore ID/UID)
                const userDocRef = fbDb.collection('users').doc(userId); const isCurrentUser = userId === currentUser.uid; const newStatus = currentStatus === 'aktif' ? 'nonaktif' : 'aktif'; const actionText = newStatus === 'aktif' ? 'mengaktifkan' : 'menonaktifkan';
                if (isCurrentUser && newStatus === 'nonaktif') { showNotification("Anda tidak dapat menonaktifkan akun Anda sendiri.", "warning"); return; }
                let userName = `Pengguna (ID: ${userId})`; try { const userDoc = await userDocRef.get(); if(userDoc.exists) userName = userDoc.data().name; } catch(e){}
                if (confirm(`Yakin ingin ${actionText} pengguna "${userName}"? Pengguna ${newStatus === 'nonaktif' ? 'tidak akan bisa login.' : 'akan bisa login kembali.'}`)) {
                    try { await userDocRef.update({ status: newStatus }); console.log("User status updated:", userId, newStatus); await showUserTab(currentActiveUserTab); showNotification(`Status ${userName} diubah menjadi ${newStatus}.`, "success"); }
                    catch (error) { console.error("Error toggling status:", error); showNotification(`Gagal ubah status: ${error.message}`, "danger"); }
                 }
            };
            window.handleResetPassword = async (userId) => { // Use userId (Firestore ID/UID)
                try {
                    const userDoc = await fbDb.collection('users').doc(userId).get(); if (!userDoc.exists) throw new Error("Data pengguna tidak ditemukan."); const userData = userDoc.data();
                    const identifier = userData.nisn || userData.username; if (!identifier) throw new Error("Identifier (NISN/Username) tidak ditemukan untuk pengguna ini.");
                    const email = `${identifier}@akubisasimpan-20a7e.firebaseapp.com`; // Dummy email using YOUR project ID
                    if (confirm(`Kirim email reset password ke alamat terkait "${userData.name}" (Email: ${email})?`)) { await fbAuth.sendPasswordResetEmail(email); console.log("Password reset email sent to:", email); showNotification(`Email reset password dikirim untuk ${userData.name}.`, "success"); }
                } catch (error) { console.error("Error sending password reset:", error); let errorMsg = `Gagal kirim email reset: ${error.message}`; if (error.code === 'auth/user-not-found') { errorMsg = "Gagal: Akun Auth tidak ditemukan untuk pengguna ini."; } showNotification(errorMsg, "danger", 5000); }
            };

            // Question Modal Functions (Firebase Integrated)
             window.openQuestionModal = async (bankKey = null, questionId = null) => { // Make async
                const modalId = 'question-modal'; openModal(modalId); clearModalError(modalId); const form = document.getElementById('question-form'); const title = document.getElementById('question-modal-title'); const editIdInput = document.getElementById('question-edit-id'); const bankKeyInput = document.getElementById('question-bank-key'); const optionDGroup = document.getElementById('question-option-d-group'); const answerGroup = document.getElementById('question-answer-group'); const answerSelect = document.getElementById('question-answer');
                form.reset(); form.classList.remove('was-validated'); const currentBank = bankKey || currentActiveQuestionBank; editIdInput.value = questionId; bankKeyInput.value = currentBank;
                const isEdit = !!questionId; const is3Opt = threeOptionTestKeys.includes(currentBank); const bankDisplayName = currentBank.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                title.textContent = isEdit ? 'Edit Soal' : `Tambah Soal - ${bankDisplayName}`; optionDGroup.classList.toggle('hidden', is3Opt); document.getElementById('question-option-d').required = !is3Opt; answerGroup.classList.toggle('hidden', is3Opt); answerSelect.required = !is3Opt;
                if (isEdit) {
                     try {
                         const questionDocRef = fbDb.collection('questionBanks').doc(currentBank).collection('questions').doc(questionId); const questionDoc = await questionDocRef.get(); if (!questionDoc.exists) throw new Error("Soal tidak ditemukan."); const questionToEdit = { id: questionDoc.id, ...questionDoc.data() };
                         document.getElementById('question-text').value = questionToEdit.text || ''; document.getElementById('question-option-a').value = questionToEdit.options?.[0] || ''; document.getElementById('question-option-b').value = questionToEdit.options?.[1] || ''; document.getElementById('question-option-c').value = questionToEdit.options?.[2] || '';
                         if (!is3Opt) { document.getElementById('question-option-d').value = questionToEdit.options?.[3] || ''; answerSelect.value = questionToEdit.answer || ''; }
                     } catch (error) { console.error("Error fetching question for edit:", error); showNotification(`Error: ${error.message}`, "danger"); closeModal(modalId); return; }
                 } else { answerSelect.value = ''; }
              };
             const questionForm = document.getElementById('question-form'); if (questionForm) { questionForm.addEventListener('submit', (event) => { event.preventDefault(); handleQuestionFormSubmit(); }); }
             const handleQuestionFormSubmit = async () => { // Make async
                  const modalId = 'question-modal'; const form = document.getElementById('question-form'); const saveButton = document.getElementById('question-modal-save-btn'); clearModalError(modalId);
                  if (!validateForm(form)) { displayModalError(modalId, "Harap perbaiki isian yang ditandai."); return; }
                  toggleButtonLoading(saveButton.id, true);
                  const bankKey = document.getElementById('question-bank-key').value; const editId = document.getElementById('question-edit-id').value; const text = document.getElementById('question-text').value.trim(); const optA = document.getElementById('question-option-a').value.trim(); const optB = document.getElementById('question-option-b').value.trim(); const optC = document.getElementById('question-option-c').value.trim(); const is3Opt = threeOptionTestKeys.includes(bankKey); const optD = !is3Opt ? document.getElementById('question-option-d').value.trim() : null; const answer = !is3Opt ? document.getElementById('question-answer').value : null;
                  // Re-validate specific logic after basic validation
                  let errors = []; if(!text) errors.push("Teks pertanyaan kosong."); if(!optA) errors.push("Opsi A kosong."); if(!optB) errors.push("Opsi B kosong."); if(!optC) errors.push("Opsi C kosong."); if (!is3Opt && !optD) errors.push("Opsi D kosong."); if (!is3Opt && !answer) errors.push("Jawaban benar belum dipilih."); if(errors.length > 0) { displayModalError(modalId, errors.join('<br>')); toggleButtonLoading(saveButton.id, false); return; }
                  if (!bankKey) { displayModalError(modalId, 'Error: Bank soal tidak valid.'); toggleButtonLoading(saveButton.id, false); return; }
                  const questionData = { text: text, options: is3Opt ? [optA, optB, optC] : [optA, optB, optC, optD], answer: answer, type: is3Opt ? 'multiple-choice-3opt' : 'multiple-choice' };
                  try {
                      const bankDocRef = fbDb.collection('questionBanks').doc(bankKey);
                      const questionsColRef = bankDocRef.collection('questions');
                      // Ensure bank document exists (create if not)
                      await bankDocRef.set({ name: bankKey.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()), lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });

                      if (editId) { // Edit
                          const questionDocRef = questionsColRef.doc(editId); await questionDocRef.update(questionData); console.log("Question updated:", editId);
                      } else { // Add
                          const newDocRef = await questionsColRef.add(questionData); console.log("Question added with ID:", newDocRef.id);
                      }
                      toggleButtonLoading(saveButton.id, false); closeModal(modalId); await renderQuestionTable(bankKey); showNotification(`Soal ${editId ? 'diperbarui' : 'ditambahkan'}!`, 'success');
                  } catch (error) { console.error("Error saving question:", error); displayModalError(modalId, `Gagal menyimpan soal: ${error.message}`); toggleButtonLoading(saveButton.id, false); }
              };
            window.handleDeleteQuestion = async (bankKey, questionId) => { // Make async
                 if (!bankKey || !questionId) { showNotification("Error: Data soal tidak valid.", "danger"); return; }
                 let questionTextPreview = `Soal (ID: ${questionId})`; try { const qDoc = await fbDb.collection('questionBanks').doc(bankKey).collection('questions').doc(questionId).get(); if (qDoc.exists) questionTextPreview = (qDoc.data().text || '').substring(0, 50) + "..."; } catch(e) {}
                 if (confirm(`Yakin ingin menghapus soal "${questionTextPreview}" dari bank ${bankKey}?`)) {
                      try { const questionDocRef = fbDb.collection('questionBanks').doc(bankKey).collection('questions').doc(questionId); await questionDocRef.delete(); console.log("Question deleted:", questionId); await renderQuestionTable(bankKey); showNotification("Soal berhasil dihapus.", "success"); }
                      catch (error) { console.error("Error deleting question:", error); showNotification(`Gagal menghapus soal: ${error.message}`, "danger"); }
                  }
             };

            // --- Helper Functions ---
            window.navigateTo = (section, title) => { loadContent(section, title, false); };
            window.navigateToHistory = (originalSection, dataKey, title) => { const historySection = `${originalSection}-history`; loadContent(historySection, `Riwayat Test ${title}`, true); };
            const startTest = (testKey, testTitle) => { loadTestInterface(testKey, testTitle); }; window.startTest = startTest;
            const dataKeyRequiresScore = (dataKey) => { return !['gayaBelajar', 'kecerdasanGanda', 'modalitasBelajar', 'ketertarikan'].includes(dataKey); };
            const renderSparkline = (canvasId, scores, label) => {
                const canvas = document.getElementById(canvasId); const container = document.getElementById(canvasId + '-container'); if (!canvas || !container) { console.warn(`Canvas/container not found: ${canvasId}`); return; }
                if (activeCharts[canvasId]) { activeCharts[canvasId].destroy(); }
                if (scores && scores.length >= 2) {
                    container.innerHTML = ''; container.appendChild(canvas); const ctx = canvas.getContext('2d'); if (!ctx) { console.error(`No 2D context: ${canvasId}`); return; }
                    activeCharts[canvasId] = new Chart(ctx, { type: 'line', data: { labels: scores.map((_, index) => index + 1), datasets: [{ label: label, data: scores, fill: false, borderColor: 'rgba(13, 110, 253, 0.6)', tension: 0.1, borderWidth: 1.5, pointRadius: 0, pointHoverRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { display: false } }, plugins: { legend: { display: false }, tooltip: { enabled: false } }, elements: { line: { borderJoinStyle: 'round' } } } });
                } else { container.innerHTML = `<span class="text-muted" style="font-size: 0.8em;">N/A</span>`; }
            };

            // --- Sidebar Menu Generation ---
            const menus = {
                  murid: [ { section: 'dashboard-home', title: 'Dashboard', icon: 'fa-tachometer-alt' }, { type: 'divider', title: 'ASESMEN' }, { section: 'test-literasi', title: 'Test Literasi', icon: 'fa-book-open' }, { section: 'test-numerasi', title: 'Test Numerasi', icon: 'fa-calculator' }, { section: 'test-gaya-belajar', title: 'Test Gaya Belajar', icon: 'fa-palette' }, { section: 'test-modalitas-belajar', title: 'Test Modalitas', icon: 'fa-brain' }, { section: 'test-kecerdasan-ganda', title: 'Test Kecerdasan', icon: 'fa-lightbulb' }, { section: 'test-ketertarikan', title: 'Test Ketertarikan', icon: 'fa-heart' }, { type: 'divider', title: 'AKUN' }, { section: 'pengaturan', title: 'Pengaturan Akun', icon: 'fa-cog' }, ],
                  guru: [ { section: 'dashboard-home', title: 'Dashboard Guru', icon: 'fa-chalkboard-teacher' }, { type: 'divider', title: 'MANAJEMEN' }, { section: 'kelola-soal-guru', title: 'Kelola Soal', icon: 'fa-edit' }, { section: 'lihat-nilai', title: 'Lihat Nilai Murid', icon: 'fa-clipboard-list' }, { type: 'divider', title: 'AKUN' }, { section: 'pengaturan', title: 'Pengaturan Akun', icon: 'fa-user-cog' }, ],
                 admin: [ { section: 'dashboard-home', title: 'Dashboard Admin', icon: 'fa-user-shield' }, { type: 'divider', title: 'MANAJEMEN DATA' }, { section: 'kelola-pengguna', title: 'Kelola Pengguna', icon: 'fa-users-cog' }, { section: 'kelola-soal-admin', title: 'Kelola Bank Soal', icon: 'fa-database' }, { section: 'lihat-nilai', title: 'Lihat Nilai Murid', icon: 'fa-clipboard-check' }, { type: 'divider', title: 'AKUN' }, { section: 'pengaturan', title: 'Pengaturan Akun', icon: 'fa-cogs' }, ]
             };
             const generateSidebarMenu = () => {
                 if (!sidebarNav || !currentUser || !currentUser.role) { if(sidebarNav) sidebarNav.innerHTML = '<li><a href="#" class="text-danger p-3">Error memuat menu.</a></li>'; return; }
                  let menuItems = ''; const currentRoleMenu = menus[currentUser.role] || []; if (currentRoleMenu.length === 0) { sidebarNav.innerHTML = '<li><a href="#" class="text-warning p-3">Tidak ada menu.</a></li>'; return; }
                  currentRoleMenu.forEach(item => { if(item.type === 'divider') { menuItems += `<li class="nav-section-title">${item.title}</li>`; } else { menuItems += `<li><a href="#" data-section="${item.section}" data-title="${item.title}"><i class="fas ${item.icon} fa-fw"></i><span>${item.title}</span></a></li>`; } });
                  sidebarNav.innerHTML = menuItems;
                 document.querySelectorAll('#sidebar-menu li a').forEach(link => { link.addEventListener('click', (event) => { event.preventDefault(); const section = link.getAttribute('data-section'); const title = link.getAttribute('data-title'); if (window.innerWidth <= 768 && document.querySelector('.sidebar.mobile-open')) { document.querySelector('.sidebar').classList.remove('mobile-open'); } if (section) { window.navigateTo(section, title || 'Halaman'); } else { console.warn("Menu link without data-section."); } }); });
             };

            // --- !!! UNSAFE FUNCTION FOR INITIAL ADMIN CREATION !!! ---
            // --- !!! REMOVE THIS FUNCTION AFTER FIRST ADMIN IS CREATED !!! ---
            // --- !!! WARNING: THIS IS FOR DEVELOPMENT SETUP ONLY !!! ---
            const createInitialAdmin_UNSAFE = async () => {
                const adminUsername = "admin"; // CHANGE THIS if desired
                const adminPassword = "admin123"; // CHANGE THIS to a STRONG password!
                const adminEmail = `${adminUsername}@akubisasimpan-20a7e.firebaseapp.com`; // Dummy email based on username and YOUR project ID
                const adminName = "Administrator Utama"; // Or desired name

                console.warn("!!! RUNNING UNSAFE INITIAL ADMIN CREATION !!!");
                console.warn("!!! THIS FUNCTION SHOULD BE REMOVED AFTER FIRST ADMIN IS CREATED !!!");
                alert("PERINGATAN: Fungsi pembuatan admin awal sedang berjalan. Ini HANYA untuk setup awal. Hapus fungsi ini dari kode setelah admin berhasil dibuat.");

                showNotification("Mencoba membuat admin awal...", "info", 5000);

                try {
                    // 1. Create user in Firebase Authentication
                    const userCredential = await fbAuth.createUserWithEmailAndPassword(adminEmail, adminPassword);
                    const uid = userCredential.user.uid;
                    console.log("Admin user created in Auth, UID:", uid);

                    // 2. Create user document in Firestore with admin role
                    const userDocRef = fbDb.collection('users').doc(uid);
                    const adminData = {
                        uid: uid,
                        name: adminName,
                        username: adminUsername, // Store username if needed for display/reference
                        role: "admin",
                        status: "aktif",
                        profilePic: 'assets/default-profile.png', // Default pic
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    // This set() operation WILL AUTOMATICALLY CREATE the 'users' collection if it doesn't exist.
                    await userDocRef.set(adminData);
                    console.log("Admin user document created in Firestore.");
                    showNotification(`Admin awal "${adminUsername}" berhasil dibuat! Hapus kode pembuatan dari JavaScript sekarang.`, "success", 10000);
                    alert(`Admin awal "${adminUsername}" berhasil dibuat!\n\nUID: ${uid}\n\nPENTING: Hapus fungsi createInitialAdmin_UNSAFE dari kode JavaScript Anda SEKARANG!`);

                } catch (error) {
                    console.error("Error creating initial admin:", error);
                    let message = `Gagal membuat admin awal: ${error.message}`;
                    if (error.code === 'auth/email-already-in-use') {
                        message = `Gagal: Akun untuk "${adminUsername}" (email: ${adminEmail}) sudah ada di Firebase Auth. Coba username lain atau hapus akun yang ada.`;
                    } else if (error.code === 'auth/weak-password') {
                        message = "Gagal: Password terlalu lemah. Gunakan password yang lebih kuat.";
                    }
                    showNotification(message, "danger", 10000);
                    alert(`Gagal membuat admin awal: ${message}`);
                }
            };
            // --- !!! END OF UNSAFE FUNCTION !!! ---
            // --- !!! UNCOMMENT THE LINE BELOW ONLY ONCE FOR INITIAL SETUP !!! ---
            // createInitialAdmin_UNSAFE(); // <-- !!! REMOVE OR COMMENT OUT THIS LINE AFTER USE !!!


            // --- Initial Application Load & Auth State Change ---
            const initializeApp = () => {
                fbAuth.onAuthStateChanged(async (user) => { // Make async
                    if (user) {
                        console.log("Firebase Auth User:", user.uid);
                        try {
                            const userDocRef = fbDb.collection('users').doc(user.uid); const userDoc = await userDocRef.get();
                            if (userDoc.exists) {
                                currentUser = { uid: user.uid, ...userDoc.data() };
                                if (currentUser.status === 'aktif') { console.log("Current User Data:", currentUser); showDashboard(); }
                                else { console.warn("User is inactive:", currentUser.uid); await fbAuth.signOut(); showLogin(); showNotification("Akun Anda tidak aktif. Hubungi administrator.", "warning", 5000); }
                            } else { console.error("User data not found in Firestore:", user.uid); await fbAuth.signOut(); showLogin(); showNotification("Data profil tidak ditemukan. Login gagal.", "danger", 5000); }
                        } catch (error) { console.error("Error fetching user profile:", error); await fbAuth.signOut(); showLogin(); showNotification("Gagal memuat data profil. Login gagal.", "danger", 5000); }
                    } else { console.log("No Firebase user signed in."); currentUser = null; showLogin(); }
                });
            };

            initializeApp(); // Run the app initialization

        }); // End DOMContentLoaded

        // --- END OF JAVASCRIPT ---
    </script>

</body>
</html>
